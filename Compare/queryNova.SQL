USE [SOMA]
GO
/****** Object:  StoredProcedure [dbo].[LX_CM_PRODUCAO_PA]    Script Date: 31/10/2025 11:11:36 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[LX_CM_PRODUCAO_PA] @COD_CUSTO_MEDIO AS CHAR(8), @EMPRESA AS INT, @ARBITRADO AS INT, @SEMI_ACABADO TINYINT = 0, @CONSERTO BIT = 0        
AS        
 -----------------------------------------------------        
 -- PROCEDURE PARA GERAÇÃO DA TABELA CM_PRODUCAO_PA --        
 ----------------------------------------------------- 
 -- 04/01/2022 - RENATO TINOCO   -#CSM004# - Ajuste para processamento das OPs de transformacao do Paraguai
 -- 03/04/2020 - MB				 - #GS:01.03# - INCLUSÃO DO PREENCHIMENTO DO CAMPO QTDE_EM_PROCESSO.
 -- 19/04/2018 - LPR			 - #GS:01.02# - INCLUSÃO DO (NOLOCK)/*#GS:01.02#*/   
 -- 17/03/2018 - LPR			 -#GS:01.01# - CRIACAO DE TEMPORARIAS PARA MELHORAR A PERFORMANCE.  
 -- 13/09/2017 - RENATO TINOCO   -#CSM002# - Comentado o filtro de NF_PENDENTE no indicador de absorcao LX-MP pois independente de existir ou nao NF de remessa, o custo deve considerar o consumo de MP
 -- 04/07/2017 - RENATO TINOCO   -#CSM001# - Tratamento do imposto de ICMS para as notas fiscais de servico  
 -- 02/03/2020 - RENATO TINOCO   -#CSM003# - Tratamento dos valores em processo quando a OP for finalizada pelo banco sem geracao de perda por OS
 -- 03/07/2017 - BRUNO SAL       - ##   - DEMANDA XXXXX - Criação do parâmetro CM_ABS_CONSIDERA_PERDA_MP para considerar a PERDA no TOTAL_ABSORVICAO_PERIODO        
 -- 29/06/2017 - BRUNO SAL       - ##   - DEMANDA XXXXX - Correção da TOTAL_QTDE_ACUMULADA quando não existe vínculo com TAREFA.         
 -- 06/06/2017 - RODRIGO SOUZA   - ##   - DEMANDA XXXXX -         
 -- 29/05/2017 - RODRIGO SOUZA   - #29# - DEMANDA 32637 - Correção para gerar corretamente itens de OPs de conserto.        
 -- 18/05/2017 - RODRIGO SOUZA   - #28# - DEMANDA 31860 - Correção para não validar recurso produtivo em saidas sem OS.        
 -- 13/03/2017 - CARLOS ALBERTO  - #27# - DEMANDA 5617  - 01.17 - COMPLEMENTO DA IMPLEMENTAÇÃO DO TRATAMENTO PARA O LX-OS SER GERADO SOMENTE QUANDO A OPERACAO GERAR MOVIMENTO FINANCEIRO ITP.        
 -- 07/10/2016 - RODRIGO SOUZA   - #26# - DEMANDA 2489 - Foi criado o parametro CM_ABSORVE_FIM_TAREFA para definir se os custos serão absorvidos no inicio ou no final da tarefa.        
 -- 07/10/2016 - RODRIGO SOUZA   - #25# - DEMANDA 4253 - Correção no insert da tabela @TMP_CALCULOS_MP que estava inserindo a quantidade como null.        
 -- 07/10/2016 - RODRIGO SOUZA   - #24# - DEMANDA 8972 - Correção para utilizar a quantidade de perdas no processo para calcular a porcentagem por cor em casos de OP com perda total.        
 -- 22/08/2016 - ANDRÉ PEREIRA   - #23# - DEMANDA 2813 - VALIDAÇÃO DE VALORIZAÇÃO DO INDICADOR DE ABSORÇÃO LX-OS NO RETORNO DE NF DE SERVIÇO UTLIZANDO         
 --                A QUANTIDADE MOVIMENTADA DA NF DE ENTRADA        
 -- 22/08/2016 - ANDRÉ PEREIRA   - #22# - DEMANDA 7299 - CORREÇÃO PARA EVITAR DUPLICIDADE EM CONTABILIZAÇÃO DE ESTOQUE EM TERCEIRO        
 -- 12/08/2016 - ANDRÉ PEREIRA   - #21# - DEMANDA 5617 - TRATAMENTO PARA O LX-OS SER GERADO SOMENTE QUANDO A OPERACAO GERAR MOVIMENTO FINANCEIRO ITP        
 -- 22/07/2016 - RODRIGO SOUZA   - #20# - DEMANDA 2433 - Alterado o arredondamento dos campos de valor que estavam com round(2) para round(5)        
 -- 21/07/2016 - SAMUEL SANTOS    - #19# - DEMANDA 4493 - Ajustar QTDE retorno de LX-MP COM OS        
 -- 16/07/2016 - RODRIGO SOUZA     - #18# - DEMANDA 4253 - CORREÇÃO NO CUSTO ABSORÇÃO - 1 - MATÉRIA PRIMA - SAIDA SEM OS PARA CONSIDERAR RETORNOS QUE ACONTECERAM NO PERIODO.        
 -- 02/07/2016 - MARCELO SZALONTAI - #17# - DEMANDA 4571 - ADIÇÃO DE CORREÇÃO PARA TRATAR O CUSTO POR EMPRESA.        
 -- 28/04/2016 - DIEGO QUARESMA    - #16# - DEMANDA 2431 - TRATAMENTO PARA O LX-OS SER GERADO SOMENTE QUANDO A OPERACAO GERAR MOVIMENTO FINANCEIRO.        
 -- 02/02/2016 - MARCELO SZALONTAI - #15# - DEMANDA 1658 - TRATAMENTO DE CUSTO POR MATRIZ CONTABIL        
 -- 14/01/2016 - MARCELO SZALONTAI - #14# -              - ADIÇÃO DE TRATAMENTO DAS OS COM PARALELO.        
 -- 14/01/2016 - MARCELO SZALONTAI - #13# - DEMANDA 1471 - ADIÇÃO DE TRATAMENTO PARA USAR O CAMPO COR QUANDO O CUSTO FOR POR COR        
 -- 18/12/2015 - MARCELO SZALONTAI - #12# - DEMANDA 1312 - TRATAMENTO PARA USAR O CAMPO RECEBIMENTO DA TABELA ENTRADAS COMO FILTRO DE DATA NO LUGAR        
 --                                                        DO CAMPO DATA DA TABELA PRODUCAO_ORDEM_SERVICO.        
 -- 07/12/2015 - MARCELO SZALONTAI - #11# - DEMANDA  909 - TRATAMENTO PARA TRAZER O VALOR DO CAMPO IMPOSTOS_VALORES.VALOR_IMPOSTO CORRETO.        
    --                                                        ANTES TRAZIA O VALOR TOTAL E NÃO POR ITEM. AGORA TRAZ POR ITEM.                                         
 -- 02/07/2015 - MARCELO SZALONTAI - #10# - TP BLOCO K - ADIÇÃO DO VALOR 5 NO CAMPO TIPO_PRODCESSO PARA TRATAR OP DE RETRABALHO        
 -- 02/07/2015 - DIEGO QUARESMA - #9# - TP BLOCO K - ALTERAMOS A CHAMADA DA PROCEDURE LX_CM_PRODUCAO_PA_TERCEIRO PARA LX_CM_PRODUCAO_PA_PROCESSO,         
 --         POIS A NOVA TRATA TANTO O TERCEIRO COMO O PROPRIO.        
 -- 18/05/2015 - RODRIGO SOUZA  - #8# - CORREÇÃO PARA SOMENTE ABATER O VALOR DO CUSTO ANTERIOR SE A QUANTIDADE PRODUZIDA É MAIOR QUE ZERO.        
 -- 23/05/2015 - RODRIGO SOUZA  - #7# - CORREÇÃO PARA ATUALIZAR A COLUNA CUSTO1 DA TABELA ESTOQUE_PROD1_ENT COM O CUSTO DA PRODUÇÃO.        
 -- 23/05/2015 - RODRIGO SOUZA  - #6# - CORREÇÃO NO CALCULO DE ABATIMENTO DA QUANTIDADE CONSUMIDA DE MATERIA PRIMA COM OS.        
 -- 21/01/2015 - RODRIGO SOUZA  - #5# - CORREÇÃO NO CALCULO DE ABATIMENTO DA QUANTIDADE CONSUMIDA.        
 -- 15/01/2015 - DIEGO QUARESMA - #4# - TP 5882464 - ADICIONADO TRATAMENTO PARA VALIDAR SE O CAMPO ORDEM_SERVICO ESTA BRANCO E ALTERAMOS PARA NULL.        
 -- 21/08/2013 - RODRIGO SOUZA  - #3# ADICIONADO TRATAMENTO PARA ABATER O RETORNO DA QUANTIDADE CONSUMIDA.        
 -- 07/05/2013 - SAMUEL SANTOS  - #2# POPULAR TABELA CM_PRODUCAO_PA_TERCEIRO        
 -- 24/04/2013 - SAMUEL SANTOS  - #1# ACERTO NA OBTENÇÃO DOS VALORES EM PROCESSO E VALOR PRODUZIDO.          
 -- 23/07/2012 - RAFAEL - ALTERAÇÃO NA QUANTIDADE DE DIGITOS DA NOTA FISCAL E SERIE NF        
 -- 20/12/2011 - FABIANO BANIN  - ACERTO NA OBTENÇÃO DOS VALORES DE ABSORÇÃO DOS RECURSOS PRODUTIVOS, NECESSÁRIO PARA QUE UTILIZE A NOVA FORMA DE        
 --                              GRAVAÇÃO DOS VALORES.        
 -- 09/12/2011 - FABIANO BANIN  - NA OBTENÇÃO DO CUSTO DE PRODUÇÃO NÃO ESTAVA UTILIZANDO AS ABSORÇÕES POR TEMPO, CAUSANDO DISTORÇÃO NOS VALORES         
 --                              DE PRODUÇÃO E DO CUSTO.        
 -- 24/10/2011 - FABIANO BANIN - INCLUSÃO DA TABELA LOJA_VENDA E LOJA_VENDA_PRODUTO NA ABSORÇÃO POR VENDAS.        
 -- 03/10/2011 - FABIANO BANIN - AJUSTE NA OBTENÇÃO DO DESCONTO DOS IMPOSTOS PARA AS NOTAS FISCAIS DE SERVIÇOS.        
 -- 20/09/2011 - FABIANO BANIN - ACERTO NO CÁLCULO DA ABSORÇÃO DO TIPO INDICADOR IGUAL A 4.        
 -- 23/05/2011 - FABIANO BANIN - INCLUSÃO DE UM PARÂMETRO PARA TRATAMENTO DO VALOR DE PRODUÇÃO, ESSE PARÂMETRO IRÁ INDICAR SE UTILIZA O ACUMULADO        
 --                              OU SE UTILIZA APENAS OS GASTOS DO MÊS.        
 -- 12/05/2011 - FABIANO BANIN - ALTERADO A FORMA DE RETIRAR O IMPOSTO DO VALOR CREDITADO DO LANÇAMENTO LX-OS.        
 -- 12/11/2010 - FABIANO BANIN - ACERTO NA UTILIZAÇÃO DO PARÂMETRO CM_QTDE_PROC_MOVIMENTO.        
 -- 04/11/2010 - FABIANO BANIN - ALTERADO A PARTE DE OBTENÇÃO DA QTDE EM PROCESSO, FOI FEITO UMA MELHORIA PARA UTILIZAR AS LAVAGENS, PERDA E         
 --                              ALTERAÇÃO DE PCP, ANTES NÃO ESTAVA OLHANDO ALGUMAS OCORRÊNCIAS FAZENDO COM QUE A QTDE EM PROCESSO NO PERÍODO         
 --                              DO FECHAMENTO FICASSE DIFERENTE DO REAL.        
 -- 13/10/2010 - FABIANO BANIN - ALTERADO A PARTE DE OBTENÇÃO DA QTDE EM PROCESSO, EM ALGUNS CASOS OS VALORES FICAVAM NEGATIVOS.        
 -- 30/07/2010 - FABIANO BANIN - ACERTO NA OBTENÇÃO DA QTDE EM PROCESSO. NÃO ESTAVA FAZENDO USO DA ALTERAÇÃO DE PCP E DA PERDA         
 -- 23/07/2010 - FABIANO BANIN - ACERTO NO ARREDONDAMENTO DO CUSTO ARBITRADO.        
 -- 16/06/2010 - FABIANO BANIN - ACERTO NA COMPOSIÇÃO DO CUSTO ARBITRADO.        
 -- 11/05/2010 - FABIANO BANIN - VERIFICAÇÃO DE ESTOQUE EM PROCESSO POR PARAMETRO (CM_QTDE_PROC_MOVIMENTO)          
 -- 04/05/2010 - FABIANO BANIN - ACERTO NA COMPOSIÇÃO DO MAIOR CUSTO DO FATURAMENTO, ANTES NÃO VERIFICAVA A VARIAÇÃO POR TAMANHO.        
 -- 16/03/2010 - FABIANO BANIN - VERIFICAÇÃO SE O FECHAMENTO UTILIZA A COR DO PRODUTO, CASO NÃO UTILIZE JOGAR O MAIOR VALOR DO PRODUTO, E NÃO         
 --                              MAIS PRODUTO + COR, NO CUSTO ARBITRADO POR VENDA.        
 -- 11/03/2010 - FABIANO BANIN - NO ARBITRADO POR VENDA ESTAVA PEGANDO O SUM DO VALOR / QTDE NO LUGAR DE PEGAR O MAX.        
 -- 16/11/2009 - FABIANO BANIN - ALTERAÇÃO NAS ABSORÇÕES DO CUSTO DA PRODUÇÃO.        
 -- 09/10/2009 - FABIANO BANIN - ALTERAÇÃO DA COMPOSIÇÃO DO VALOR DO LX-OS        
 -- 17/09/2009 - FABIANO BANIN - INCLUSÃO DE UM NOVO TIPO DE ABSORÇÃO PARA RATEIO DOS VALORES DE MATERIAIS.        
 -- 01/07/2009 - FABIANO BANIN - ACERTO NA ABSORÇÃO.        
 -- 25/06/2009 - FABIANO BANIN - SÓ DEVE PEGAR O CUSTO EFETIVO QUANDO TIVER NOTA FISCAL PARA O TIPO LX-OS        
 -- 22/06/2009 - FABIANO BANIN - ALTERAÇÃO NA ABSORÇÃO POR LANÇAMENTO CONTÁBIL.        
 -- 01/06/2009 - FABIANO BANIN - AJUSTE NO FECHAMENTO DO VALOR DA PRODUÇÃO.        
 -- 22/01/2009 - FABIANO BANIN - AJUSTE NO ARBITRADO QUANDO O PRODUTO TEM VARIAÇÃO DE PREÇO POR TAMANHOS.        
 -- 18/08/2008 - FELIPE - CORRIGIDO TRATAMENTO DE ABSORCAO POR QTDE        
 -- 08/07/2008 - FELIPE - CORRIGIDO TRATAMENTO DE OP + CORES        
 -- 24/06/2008 - FELIPE - TRATAMENTO DE OP DE TRANSFORMAÇÃO / CONSERTO        
 -- 23/06/2008 - FELIPE - CORRIGIDO CONSUMO MATERIAL POR OS        
 -- 31/03/2008 - FELIPE - NOVO PROCESSO (SEM FAIXA DE CUSTO)        
 -----------------------------------------------------        
 SET NOCOUNT ON        
        
 DECLARE @INICIO_VENDAS AS DATETIME, @FINAL_VENDAS AS DATETIME, @PORC_ACABADO AS NUMERIC(8,5),        
         @PORC_PROCESSO AS NUMERIC(8,5), @CODIGO_TAB_PRECO AS CHAR(2),        
         @DATA_INI AS DATETIME, @DATA_FIN AS DATETIME, @COD_CUSTO_ANT CHAR(8), @FECHA_COR_PA AS BIT,        
   @CALCULA_CUSTO_POR_FILIAL AS BIT/*#15#*/        
        
 SELECT @DATA_INI = ISNULL(DATEADD(DAY, 1, B.DATA_SALDO), '19000101'),         
   @DATA_FIN = A.DATA_SALDO,        
   @COD_CUSTO_ANT = A.COD_CUSTO_MEDIO_ANTERIOR,         
   @FECHA_COR_PA = A.FECHA_CUSTO_COR_PA,        
   @CALCULA_CUSTO_POR_FILIAL = A.CALCULA_CUSTO_POR_FILIAL /*#15#*/        
 FROM CM_FECHAMENTO_CUSTO_MEDIO AS A (NOLOCK)        
      LEFT JOIN CM_FECHAMENTO_CUSTO_MEDIO AS B (NOLOCK) ON A.COD_CUSTO_MEDIO_ANTERIOR = B.COD_CUSTO_MEDIO        
 WHERE A.COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO        
        
 --#26# Inicio        
 DECLARE @CM_ABSORVE_FIM_TAREFA CHAR(3)        
 SELECT @CM_ABSORVE_FIM_TAREFA = ISNULL(DBO.FX_PARAMETRO('CM_ABSORVE_FIM_TAREFA'),'.F.')        
 --#26# Fim        
        
 --#5#        
 DECLARE @TMP_CALCULOS_MP AS TABLE ( COD_CUSTO_MEDIO CHAR(8),        
          ORDEM_PRODUCAO CHAR(8),        
          MATERIAL CHAR(11),        
          COR_MATERIAL CHAR (10),        
          QTDE NUMERIC(9,3),        
          PERDA NUMERIC(9,3),        
          CUSTO NUMERIC(15,5),        
          QTDE_RETORNO NUMERIC(9,3)        
          ,TOTAL_ABSORCAO_PERIODO NUMERIC(14,2))        
                  
               
 DECLARE @CM_PRODUCAO_PA_ABSORCAO AS TABLE ( TOTAL_ABSORCAO_PERIODO NUMERIC(14,2),        
            COD_CUSTO_MEDIO CHAR(8),        
            PRODUTO CHAR(12),        
            COR_PRODUTO CHAR(10),        
            ORDEM_PRODUCAO CHAR(8),        
            TOTAL_MINUTOS_PERIODO INT,        
      INDICADOR_ABSORCAO CHAR(8),        
            TOTAL_QTDE_PERIODO NUMERIC(10,3),        
            TOTAL_ABSORCAO_ACUMULADO NUMERIC(14,2),        
            TOTAL_QTDE_ACUMULADA NUMERIC(10,3),        
            TAREFA CHAR(10))        
                 
 --#5#        
        
 --#24#        
 DECLARE @PERC_COR AS TABLE (ORDEM_PRODUCAO CHAR(8),COR_PRODUTO CHAR(10),PERC_COR DECIMAL (14,12), ID_COR INT)        
 --#24#        
        
--#24#        
IF @FECHA_COR_PA=1        
BEGIN        
        
  INSERT INTO @PERC_COR        
  SELECT DISTINCT A.ORDEM_PRODUCAO,A.COR_PRODUTO,ROUND(((case when QTDE_O=0 then C.QTDE_PERDA else QTDE_O+C.QTDE_PERDA end)*1.0/ CASE WHEN B.QTDE= 0 THEN B.QTDE_PERDA ELSE B.QTDE+B.QTDE_PERDA END ),3) AS PERC_COR --#24#        
  ,0 AS ID_COR        
  FROM PRODUCAO_ORDEM_COR A   (NOLOCK)/*#GS:01.02#*/       
   INNER JOIN ( SELECT ORDEM_PRODUCAO, SUM(QTDE_O) QTDE , SUM(PERDAS_NO_PROCESSO)*-1 QTDE_PERDA--#24#        
       FROM PRODUCAO_ORDEM_COR     (NOLOCK)/*#GS:01.02#*/     
       GROUP BY ORDEM_PRODUCAO) B                 
    ON A.ORDEM_PRODUCAO = B.ORDEM_PRODUCAO         
   INNER JOIN ( SELECT ORDEM_PRODUCAO, COR_PRODUTO, SUM(QTDE_O) QTDE , SUM(PERDAS_NO_PROCESSO)*-1 QTDE_PERDA--#24#        
       FROM PRODUCAO_ORDEM_COR  (NOLOCK)/*#GS:01.02#*/        
       GROUP BY ORDEM_PRODUCAO, COR_PRODUTO) C                 
    ON A.ORDEM_PRODUCAO = C.ORDEM_PRODUCAO         
    AND A.COR_PRODUTO = C.COR_PRODUTO        
         
   INNER JOIN ( SELECT DISTINCT B.ORDEM_PRODUCAO         
       FROM ESTOQUE_SAI_MAT AS A    (NOLOCK)/*#GS:01.02#*/     
        INNER JOIN ESTOQUE_SAI1_MAT AS B    (NOLOCK)/*#GS:01.02#*/     
         ON A.REQ_MATERIAL = B.REQ_MATERIAL        
         AND A.FILIAL = B.FILIAL         
        LEFT JOIN ( PRODUCAO_OS_ANTERIOR  (NOLOCK)/*#GS:01.02#*/AS D --#18#        
         INNER JOIN PRODUCAO_ORDEM_SERVICO  (NOLOCK)/*#GS:01.02#*/AS E ON E.ORDEM_SERVICO = D.ORDEM_SERVICO AND E.INDICADOR_TIPO_MOV IN (1,3) --#18#        
             ) ON D.ORDEM_SERVICO = (CASE WHEN A.ORDEM_SERVICO = '' THEN NULL ELSE A.ORDEM_SERVICO END ) --#18#        
       WHERE A.EMISSAO BETWEEN @DATA_INI AND @DATA_FIN        
       AND  A.ORDEM_SERVICO IS NULL        
       UNION ALL        
       SELECT A.ORDEM_PRODUCAO         
       FROM PRODUCAO_OS_ANTERIOR  (NOLOCK)/*#GS:01.02#*/AS A        
        INNER JOIN PRODUCAO_ORDEM_SERVICO  (NOLOCK)/*#GS:01.02#*/AS B        
         ON A.ORDEM_SERVICO=B.ORDEM_SERVICO         
       WHERE B.DATA BETWEEN @DATA_INI AND @DATA_FIN        
       AND  B.INDICADOR_TIPO_MOV IN ( 1, 3 )        
       UNION ALL        
       SELECT B.ORDEM_PRODUCAO        
       FROM ESTOQUE_RET_MAT  (NOLOCK)/*#GS:01.02#*/AS A        
        INNER JOIN ESTOQUE_RET1_MAT  (NOLOCK)/*#GS:01.02#*/AS B        
         ON A.REQ_MATERIAL = B.REQ_MATERIAL         
         AND A.FILIAL = B.FILIAL         
       WHERE B.ORDEM_PRODUCAO  IS NOT NULL        
       AND A.EMISSAO BETWEEN @DATA_INI AND @DATA_FIN ) TEMP_MOV        
    ON TEMP_MOV.ORDEM_PRODUCAO = A.ORDEM_PRODUCAO          
   INNER JOIN PRODUCAO_ORDEM  (NOLOCK)/*#GS:01.02#*/AS D        
    ON D.ORDEM_PRODUCAO = A.ORDEM_PRODUCAO         
   INNER JOIN PRODUTOS  (NOLOCK)/*#GS:01.02#*/AS G        
    ON G.PRODUTO = D.PRODUTO         
  WHERE ISNULL(G.MONTAGEM_KIT, 0) = @SEMI_ACABADO AND        
    ISNULL(D.TIPO_PROCESSO, 0) NOT IN ( 4 )         
        
  UPDATE A        
  SET  A.ID_COR = B.ID         
  FROM @PERC_COR AS A        
   INNER JOIN (SELECT  ORDEM_PRODUCAO,COR_PRODUTO ,ROW_NUMBER() OVER(PARTITION BY ORDEM_PRODUCAO ORDER BY ORDEM_PRODUCAO,PERC_COR DESC) AS ID FROM @PERC_COR) AS B        
   ON A.ORDEM_PRODUCAO = B.ORDEM_PRODUCAO         
   AND A.COR_PRODUTO = B.COR_PRODUTO         
        
        
  UPDATE A        
  SET  PERC_COR = A.PERC_COR+B.DIFERENCA         
  FROM @PERC_COR AS A        
  INNER JOIN( SELECT (1-SOMA_PERCENTUAL)AS DIFERENCA , ORDEM_PRODUCAO        
     FROM ( SELECT ORDEM_PRODUCAO,SUM(PERC_COR) AS SOMA_PERCENTUAL        
        FROM @PERC_COR        
        GROUP BY ORDEM_PRODUCAO) AS DIF         
     ) AS B        
  ON A.ORDEM_PRODUCAO = B.ORDEM_PRODUCAO         
  WHERE A.ID_COR =1        
END        
--#24#        
        
        
 /* PEGA OS VALORES PARA O CUSTO ARBITRADO DA PRODUÇÃO */        
 IF @ARBITRADO = 1 OR @ARBITRADO = 2        
 BEGIN        
        
  SELECT @INICIO_VENDAS = ARBITRADO_INICIO_VENDAS, @FINAL_VENDAS = ARBITRADO_FINAL_VENDAS, @PORC_ACABADO = ARBITRADO_PORC_PA_ACABADO,        
         @PORC_PROCESSO = ARBITRADO_PORC_PA_EM_PROC, @CODIGO_TAB_PRECO = CODIGO_TAB_PRECO        
  FROM CM_FECHAMENTO_CUSTO_MEDIO        
  WHERE COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO        
        
 END        
 ELSE        
 BEGIN        
        
  UPDATE PRODUCAO_CUSTO_ABSORCAO        
  SET TIPO_INDICADOR = 1  /* MATERIA PRIMA */        
  WHERE INDICADOR_ABSORCAO = 'LX-MP'        
        
  IF @@ROWCOUNT = 0        
   INSERT INTO PRODUCAO_CUSTO_ABSORCAO (INDICADOR_ABSORCAO, DESC_INDICADOR, ITEM_COMPOSICAO, TIPO_INDICADOR)        
   VALUES( 'LX-MP', 'CUSTO MATÉRIA PRIMA (IND.PADRÃO LINX)', NULL, 1)        
        
  UPDATE PRODUCAO_CUSTO_ABSORCAO        
  SET TIPO_INDICADOR = 2  /* MÃO DE OBRA */        
  WHERE INDICADOR_ABSORCAO = 'LX-OS'        
        
  IF @@ROWCOUNT = 0       
   INSERT INTO PRODUCAO_CUSTO_ABSORCAO (INDICADOR_ABSORCAO, DESC_INDICADOR, ITEM_COMPOSICAO, TIPO_INDICADOR)        
   VALUES( 'LX-OS', 'CUSTO ORDEM SERVIÇO (IND.PADRÃO LINX)', NULL, 2)        
        
  UPDATE PRODUCAO_CUSTO_ABSORCAO        
  SET TIPO_INDICADOR = 3  /* CUSTO FABRIL */        
  WHERE INDICADOR_ABSORCAO = 'LX-OSF'        
        
  IF @@ROWCOUNT = 0        
   INSERT INTO PRODUCAO_CUSTO_ABSORCAO (INDICADOR_ABSORCAO, DESC_INDICADOR, ITEM_COMPOSICAO, TIPO_INDICADOR)        
   VALUES( 'LX-OSF', 'CUSTO FABRIL OS (IND.PADRÃO LINX)', NULL, 3)        
        
  DECLARE @IND_MP_PADRAO CHAR(8), @IND_OS_PADRAO CHAR(8)        
        
  SELECT @IND_MP_PADRAO = A.INDICADOR_ABSORCAO        
  FROM ( SELECT TOP 1 A.INDICADOR_ABSORCAO, SUM(CASE WHEN B.INDICADOR_ABSORCAO IS NULL THEN 99999 ELSE 1 END) AS CNT        
    FROM PRODUCAO_CUSTO_ABSORCAO A   (NOLOCK)/*#GS:01.02#*/      
       LEFT JOIN PRODUCAO_CUSTO_RECURSO B  (NOLOCK)/*#GS:01.02#*/ON A.INDICADOR_ABSORCAO=B.INDICADOR_ABSORCAO        
    WHERE TIPO_INDICADOR = 1        
    GROUP BY A.INDICADOR_ABSORCAO        
    ORDER BY CNT DESC ) A        
        
  SELECT @IND_OS_PADRAO = A.INDICADOR_ABSORCAO        
  FROM ( SELECT TOP 1 A.INDICADOR_ABSORCAO, SUM(CASE WHEN B.INDICADOR_ABSORCAO IS NULL THEN 99999 ELSE 1 END) AS CNT        
    FROM PRODUCAO_CUSTO_ABSORCAO A  (NOLOCK)/*#GS:01.02#*/       
       LEFT JOIN PRODUCAO_CUSTO_RECURSO B  (NOLOCK)/*#GS:01.02#*/ON A.INDICADOR_ABSORCAO=B.INDICADOR_ABSORCAO        
    WHERE TIPO_INDICADOR = 2        
    GROUP BY A.INDICADOR_ABSORCAO        
    ORDER BY CNT DESC) A        
        
  IF  @CONSERTO = 0        
  BEGIN        
          
   -- CUSTO ABSORÇÃO - 1 - MATÉRIA PRIMA - OS        
   INSERT INTO CM_PRODUCAO_PA_ABSORCAO ( COD_CUSTO_MEDIO, PRODUTO, COR_PRODUTO, ORDEM_PRODUCAO, TAREFA, INDICADOR_ABSORCAO,         
              TOTAL_QTDE_PERIODO, TOTAL_QTDE_ACUMULADA, TOTAL_MINUTOS_PERIODO, TOTAL_ABSORCAO_ACUMULADO,         
              TOTAL_ABSORCAO_PERIODO )        
           
   SELECT COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO, C.PRODUTO,         
     ( CASE WHEN @FECHA_COR_PA = 1 THEN C.COR_PRODUTO ELSE '' END ) AS COR_PRODUTO,  /*#13#*/        
     C.ORDEM_PRODUCAO, C.TAREFA,         
     ISNULL(I.INDICADOR_ABSORCAO, @IND_MP_PADRAO) AS INDICADOR_ABSORCAO, 0 AS TOTAL_QTDE_PERIODO, 0 AS TOTAL_QTDE_ACUMULADA,         
     0 AS TOTAL_MINUTOS_PERIODO, 0 AS TOTAL_ABSORCAO_ACUMULADO,         
     CAST(( SUM(( ( H.QTDE - H.PERDA /*#19#- ISNULL(R.QTDE_RETORNO,0)/*#3#*/*/ ) * H.CUSTO )        
        * ( CASE WHEN @FECHA_COR_PA = 1 THEN PERC_COR ELSE 1  END )         
                  ) /         
             
             
     (  COUNT(DISTINCT C.COR_PRODUTO)  ) /*#13#*/         
             
     ) AS NUMERIC(14, 2)) AS TOTAL_ABSORCAO_PERIODO        
        
   FROM PRODUCAO_ORDEM_SERVICO B  (NOLOCK)/*#GS:01.02#*/       
   INNER JOIN PRODUCAO_RECURSOS PR  (NOLOCK)/*#GS:01.02#*/ON PR.RECURSO_PRODUTIVO = B.RECURSO_PRODUTIVO --#22#        
   INNER JOIN PRODUCAO_OS_ANTERIOR  (NOLOCK)/*#GS:01.02#*/C         
    ON C.ORDEM_SERVICO = ISNULL(B.ORDEM_SERVICO_PARALELA,B.ORDEM_SERVICO) /*#14#*/        
   INNER JOIN PRODUTOS  (NOLOCK)/*#GS:01.02#*/P ON P.PRODUTO = C.PRODUTO        
   INNER JOIN PRODUCAO_ORDEM  (NOLOCK)/*#GS:01.02#*/O ON O.ORDEM_PRODUCAO = C.ORDEM_PRODUCAO        
   INNER JOIN ESTOQUE_SAI_MAT  (NOLOCK)/*#GS:01.02#*/G ON G.ORDEM_SERVICO = B.ORDEM_SERVICO        
   INNER JOIN ESTOQUE_SAI1_MAT  (NOLOCK)/*#GS:01.02#*/H ON H.REQ_MATERIAL = G.REQ_MATERIAL AND         
              H.FILIAL = G.FILIAL AND         
              H.ORDEM_PRODUCAO = C.ORDEM_PRODUCAO        
     LEFT JOIN ( PRODUCAO_CUSTO_ABSORCAO I   (NOLOCK)/*#GS:01.02#*/       
        INNER JOIN PRODUCAO_CUSTO_RECURSO  (NOLOCK)/*#GS:01.02#*/J ON J.INDICADOR_ABSORCAO = I.INDICADOR_ABSORCAO         
         ) ON J.RECURSO_PRODUTIVO = B.RECURSO_PRODUTIVO AND         
        I.TIPO_INDICADOR = 1        
    --#24# INICIO        
    --#19#        
    -- --#3# -- INICIO             
    -- LEFT JOIN (        
    --   SELECT ER1M.MATERIAL,ER1M.COR_MATERIAL,ER1M.FILIAL,ER1M.ORDEM_PRODUCAO,SUM(QTDE) QTDE_RETORNO --#6#         
    --   FROM ESTOQUE_RET_MAT AS ERM        
    --    JOIN ESTOQUE_RET1_MAT AS ER1M        
    --     ON ERM.REQ_MATERIAL=ER1M.REQ_MATERIAL AND         
    --    ERM.FILIAL=ER1M.FILIAL        
    --   WHERE ERM.TIPO_MOVIMENTACAO='B' and ERM.EMISSAO BETWEEN @DATA_INI AND @DATA_FIN        
    --   GROUP BY ER1M.MATERIAL,ER1M.COR_MATERIAL,ER1M.FILIAL,ER1M.ORDEM_PRODUCAO) R        
    --    ON R.FILIAL=G.FILIAL AND R.ORDEM_PRODUCAO=O.ORDEM_PRODUCAO --#6#         
    --    AND R.MATERIAL=H.MATERIAL AND R.COR_MATERIAL=H.COR_MATERIAL --#6#         
    ----#3# -- FIM         
    --#19#        
    --LEFT JOIN  (        
    --SELECT A.ORDEM_PRODUCAO,A.COR_PRODUTO,        
    --ROUND(((case when QTDE_O=0 then C.QTDE_PERDA else QTDE_O+C.QTDE_PERDA end)*1.0/ CASE WHEN B.QTDE= 0 THEN B.QTDE_PERDA ELSE B.QTDE+B.QTDE_PERDA END ),2) AS PERC_COR --#24#        
    --FROM PRODUCAO_ORDEM_COR A         
    -- INNER JOIN ( SELECT ORDEM_PRODUCAO, SUM(QTDE_O) QTDE , SUM(PERDAS_NO_PROCESSO)*-1 QTDE_PERDA--#24#        
    --     FROM PRODUCAO_ORDEM_COR         
    --     GROUP BY ORDEM_PRODUCAO) B                 
    -- ON A.ORDEM_PRODUCAO = B.ORDEM_PRODUCAO         
    -- --#24#        
    -- INNER JOIN ( SELECT ORDEM_PRODUCAO, COR_PRODUTO, SUM(QTDE_O) QTDE , SUM(PERDAS_NO_PROCESSO)*-1 QTDE_PERDA--#24#        
    --     FROM PRODUCAO_ORDEM_COR         
    --     GROUP BY ORDEM_PRODUCAO, COR_PRODUTO) C         
    -- ON A.ORDEM_PRODUCAO = C.ORDEM_PRODUCAO AND A.COR_PRODUTO = C.COR_PRODUTO        
    -- ) D         
     LEFT JOIN @PERC_COR AS D        
      ON D.ORDEM_PRODUCAO = O.ORDEM_PRODUCAO         
      AND D.COR_PRODUTO = C.COR_PRODUTO              
   --#24# FIM         
        
   WHERE --B.DATA BETWEEN @DATA_INI AND @DATA_FIN AND --##        
     G.EMISSAO BETWEEN @DATA_INI AND @DATA_FIN AND --##        
     B.INDICADOR_TIPO_MOV IN ( 1, 3 ) AND         
     ISNULL(P.MONTAGEM_KIT, 0) = @SEMI_ACABADO AND        
     ISNULL(O.TIPO_PROCESSO, 0) NOT IN ( 4 )        
     /*#15# - Início*/        
      AND (        
       (         
        @CALCULA_CUSTO_POR_FILIAL=1        
        AND          
        EXISTS (SELECT COD_CUSTO_MEDIO         
          FROM CM_FECHAMENTO_CUSTO_MEDIO_FILIAIS CMF          
          INNER JOIN FILIAIS  (NOLOCK)/*#GS:01.02#*/FI ON CMF.COD_FILIAL = FI.COD_FILIAL        
          WHERE CMF.COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO AND FI.FILIAL = O.FILIAL        
          )         
       )        
        OR         
       (        
        @CALCULA_CUSTO_POR_FILIAL=0        
       )        
      )        
     /*#15# - Fim*/        
     /*#17# - Início*/        
     AND EXISTS (        
         SELECT EMPRESA         
         FROM FILIAIS FI  (NOLOCK)/*#GS:01.02#*/         
         WHERE FI.FILIAL = O.FILIAL AND         
         ( FI.EMPRESA = @EMPRESA OR FI.EMPRESA IS NULL OR @EMPRESA=-1 )         
        )         
     /*#17# - Fim*/        
             
            
     /*#22# - Início*/        
     --AND ((G.NF_PENDENTE = 0 AND PR.RECURSO_PROPRIO = 1) OR (G.NF_PENDENTE = 1 AND PR.RECURSO_PROPRIO = 0 ))--#CSM002#        
     
     /*#22# - Fim*/        
   GROUP BY C.PRODUTO, C.ORDEM_PRODUCAO, C.TAREFA, I.INDICADOR_ABSORCAO        
     ,( CASE WHEN @FECHA_COR_PA = 1 THEN C.COR_PRODUTO ELSE '' END ) /*#13#*/        
        
        
   -- CUSTO ABSORÇÃO - 1 - MATÉRIA PRIMA - SAIDA SEM OS        
   -- SAIDAS --        
   --#5#        
           
         
   INSERT INTO @TMP_CALCULOS_MP ( ORDEM_PRODUCAO,MATERIAL,COR_MATERIAL,QTDE,PERDA,CUSTO,QTDE_RETORNO,TOTAL_ABSORCAO_PERIODO)        
   SELECT B.ORDEM_PRODUCAO, B.MATERIAL,B.COR_MATERIAL ,SUM(B.QTDE),SUM(B.PERDA), B.CUSTO,0,0        
   FROM ESTOQUE_SAI_MAT  (NOLOCK)/*#GS:01.02#*/AS A        
     INNER JOIN ESTOQUE_SAI1_MAT  (NOLOCK)/*#GS:01.02#*/AS B        
       ON A.REQ_MATERIAL = B.REQ_MATERIAL AND A.FILIAL = B.FILIAL        
        
     INNER JOIN PRODUCAO_ORDEM  (NOLOCK)/*#GS:01.02#*/AS O ON O.ORDEM_PRODUCAO = B.ORDEM_PRODUCAO        
     INNER JOIN PRODUTOS  (NOLOCK)/*#GS:01.02#*/AS P ON P.PRODUTO = O.PRODUTO         
             
     LEFT JOIN ( PRODUCAO_OS_ANTERIOR  (NOLOCK)/*#GS:01.02#*/AS D --#18#        
       INNER JOIN PRODUCAO_ORDEM_SERVICO  (NOLOCK)/*#GS:01.02#*/AS E ON E.ORDEM_SERVICO = D.ORDEM_SERVICO AND E.INDICADOR_TIPO_MOV IN (1,3) --#18#        
       --INNER JOIN PRODUCAO_RECURSOS PR ON PR.RECURSO_PRODUTIVO = E.RECURSO_PRODUTIVO --#22# --#28#        
           ) ON D.ORDEM_SERVICO = (CASE WHEN A.ORDEM_SERVICO = '' THEN NULL ELSE A.ORDEM_SERVICO END ) --#18#        
        
   WHERE A.EMISSAO BETWEEN @DATA_INI AND @DATA_FIN AND         
     --D.ORDEM_SERVICO IS NULL AND         
     ISNULL(P.MONTAGEM_KIT, 0) = @SEMI_ACABADO AND        
     ISNULL(O.TIPO_PROCESSO, 0) NOT IN ( 4 )        
     --and A.ORDEM_SERVICO IS NULL         
     AND ISNULL(A.ORDEM_SERVICO,'') = '' --#24#        
     /*#15# - Início*/        
      AND (        
       (         
        @CALCULA_CUSTO_POR_FILIAL=1        
        AND          
        EXISTS (SELECT COD_CUSTO_MEDIO         
          FROM CM_FECHAMENTO_CUSTO_MEDIO_FILIAIS CMF          
          INNER JOIN FILIAIS  (NOLOCK)/*#GS:01.02#*/FI ON CMF.COD_FILIAL = FI.COD_FILIAL        
     WHERE CMF.COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO AND FI.FILIAL = O.FILIAL        
          )         
       )        
        OR         
       (        
        @CALCULA_CUSTO_POR_FILIAL=0        
       )        
      )        
     /*#15# - Fim*/        
     /*#17# - Início*/        
     AND EXISTS (        
         SELECT EMPRESA         
         FROM FILIAIS  (NOLOCK)/*#GS:01.02#*/FI         
         WHERE FI.FILIAL = O.FILIAL AND         
         ( FI.EMPRESA = @EMPRESA OR FI.EMPRESA IS NULL OR @EMPRESA=-1 )         
        )         
     /*#17# - Fim*/        
             
             
     /*#22# - Início*/        
     --AND ((A.NF_PENDENTE = 0 AND PR.RECURSO_PROPRIO = 1) OR (A.NF_PENDENTE = 1 AND PR.RECURSO_PROPRIO = 0 )) --#28#        
     /*#22# - Fim*/        
        
             
   GROUP BY B.ORDEM_PRODUCAO ,B.MATERIAL,B.COR_MATERIAL ,B.CUSTO        
           
   --#18#         
   -- ATUALIZA QTDE RETORNO--        
   /*UPDATE TMP        
   SET  QTDE_RETORNO=R.QTDE_RETORNO        
   FROM @TMP_CALCULOS_MP AS TMP*/  --- #7#colocado o insert abaixo para trazer os retornos de OP quando a saida não for no mes.        
          
   INSERT INTO @TMP_CALCULOS_MP (ORDEM_PRODUCAO,MATERIAL,COR_MATERIAL,QTDE,PERDA,CUSTO,QTDE_RETORNO,TOTAL_ABSORCAO_PERIODO)        
           
   --SELECT ORDEM_PRODUCAO,MATERIAL,COR_MATERIAL, 0,0,ER1M.CUSTO_MATERIA_PRIMA,SUM(QTDE),0 --#25# --##        
   SELECT ORDEM_PRODUCAO,MATERIAL,COR_MATERIAL, 0,0,ER1M.CUSTO_MATERIA_PRIMA,         
     CASE WHEN  ISNULL(DBO.FX_PARAMETRO('CM_ABS_CONSIDERA_PERDA_MP'), '.F.') = '.T.' THEN SUM(QTDE-PERDA) ELSE SUM(QTDE) END,0 --#25# --##        
   FROM ESTOQUE_RET_MAT  (NOLOCK)/*#GS:01.02#*/AS ERM        
     JOIN ESTOQUE_RET1_MAT  (NOLOCK)/*#GS:01.02#*/AS ER1M        
     ON ERM.REQ_MATERIAL=ER1M.REQ_MATERIAL AND         
      ERM.FILIAL=ER1M.FILIAL        
   WHERE ERM.TIPO_MOVIMENTACAO='B' AND        
     ERM.EMISSAO BETWEEN @DATA_INI AND @DATA_FIN --#5#        
	 AND @SEMI_ACABADO = 0 --#CSM004# (para pegar os retornos de sobra mesmo que seja OP de transformacao)
   GROUP BY ER1M.MATERIAL,ER1M.COR_MATERIAL, ER1M.ORDEM_PRODUCAO, ER1M.CUSTO_MATERIA_PRIMA        
   --UPDATE @TMP_CALCULOS_MP SET TOTAL_ABSORCAO_PERIODO= (QTDE - PERDA - ISNULL(QTDE_RETORNO,0)) * CUSTO         
   --#18#         
             
   /*#13# - Inicio*/         
   IF @FECHA_COR_PA = 0        
   BEGIN         
           
    INSERT INTO @CM_PRODUCAO_PA_ABSORCAO ( COD_CUSTO_MEDIO, PRODUTO, COR_PRODUTO, ORDEM_PRODUCAO, TAREFA, INDICADOR_ABSORCAO,         
            TOTAL_QTDE_PERIODO, TOTAL_QTDE_ACUMULADA, TOTAL_MINUTOS_PERIODO, TOTAL_ABSORCAO_ACUMULADO,         
            TOTAL_ABSORCAO_PERIODO )        
    SELECT @COD_CUSTO_MEDIO AS COD_CUSTO_MEDIO,         
      '' AS PRODUTO,         
      '' AS COR_PRODUTO,         
      A.ORDEM_PRODUCAO,         
      '' AS TAREFA,         
      @IND_MP_PADRAO AS INDICADOR_ABSORCAO,         
      0 AS TOTAL_QTDE_PERIODO,         
      0 AS TOTAL_QTDE_ACUMULADA,         
      0 AS TOTAL_MINUTOS_PERIODO,         
      0 AS TOTAL_ABSORCAO_ACUMULADO,         
      SUM ((A.QTDE-A.PERDA-A.QTDE_RETORNO)*A.CUSTO) TOTAL_ABSORCAO_PERIODO  --#18#         
    FROM @TMP_CALCULOS_MP AS A        
    GROUP BY A.ORDEM_PRODUCAO        
           
    UPDATE A        
    SET  A.PRODUTO=B.PRODUTO , A.TOTAL_QTDE_PERIODO=B.QTDE_TOTAL        
    FROM @CM_PRODUCAO_PA_ABSORCAO AS A        
     JOIN PRODUCAO_ORDEM   (NOLOCK)/*#GS:01.02#*/AS B        
      ON A.ORDEM_PRODUCAO =B.ORDEM_PRODUCAO        
   END        
   ELSE        
   BEGIN        
        
    INSERT INTO @CM_PRODUCAO_PA_ABSORCAO ( COD_CUSTO_MEDIO, PRODUTO, COR_PRODUTO, ORDEM_PRODUCAO, TAREFA, INDICADOR_ABSORCAO,         
            TOTAL_QTDE_PERIODO, TOTAL_QTDE_ACUMULADA, TOTAL_MINUTOS_PERIODO, TOTAL_ABSORCAO_ACUMULADO,         
            TOTAL_ABSORCAO_PERIODO )        
    SELECT @COD_CUSTO_MEDIO AS COD_CUSTO_MEDIO,         
      '' AS PRODUTO,         
      B.COR_PRODUTO,         
      A.ORDEM_PRODUCAO,         
      '' AS TAREFA,         
      @IND_MP_PADRAO AS INDICADOR_ABSORCAO,         
      0 AS TOTAL_QTDE_PERIODO,         
      0 AS TOTAL_QTDE_ACUMULADA,         
      0 AS TOTAL_MINUTOS_PERIODO,         
      0 AS TOTAL_ABSORCAO_ACUMULADO,         
      SUM ((A.QTDE-A.PERDA-A.QTDE_RETORNO)*A.CUSTO) TOTAL_ABSORCAO_PERIODO  --#18#         
    FROM @TMP_CALCULOS_MP AS A        
    INNER JOIN PRODUCAO_ORDEM_COR  (NOLOCK)/*#GS:01.02#*/B ON A.ORDEM_PRODUCAO = B.ORDEM_PRODUCAO        
    GROUP BY A.ORDEM_PRODUCAO, B.COR_PRODUTO         
        
    UPDATE A        
    SET  A.PRODUTO=B.PRODUTO ,         
      A.TOTAL_QTDE_PERIODO=C.QTDE_O,        
      TOTAL_ABSORCAO_PERIODO=TOTAL_ABSORCAO_PERIODO*PERC_COR        
    FROM @CM_PRODUCAO_PA_ABSORCAO AS A        
     JOIN PRODUCAO_ORDEM   (NOLOCK)/*#GS:01.02#*/AS B        
      ON A.ORDEM_PRODUCAO =B.ORDEM_PRODUCAO        
     JOIN PRODUCAO_ORDEM_COR  (NOLOCK)/*#GS:01.02#*/C ON  A.ORDEM_PRODUCAO =C.ORDEM_PRODUCAO AND A.COR_PRODUTO = C.COR_PRODUTO        
            
     --#24# - INICIO        
     --JOIN (        
     --  SELECT  A.ORDEM_PRODUCAO, A.COR_PRODUTO,               
     --    ROUND(((case when QTDE_O=0 then C.QTDE_PERDA else QTDE_O+C.QTDE_PERDA end)*1.0/ CASE WHEN B.QTDE= 0 THEN B.QTDE_PERDA ELSE B.QTDE+B.QTDE_PERDA END ),2) AS PERC_COR --#24#        
     --    FROM PRODUCAO_ORDEM_COR A         
     --     INNER JOIN ( SELECT ORDEM_PRODUCAO, SUM(QTDE_O) QTDE , SUM(PERDAS_NO_PROCESSO)*-1 QTDE_PERDA--#24#        
     --         FROM PRODUCAO_ORDEM_COR         
     --         GROUP BY ORDEM_PRODUCAO) B                 
     --     ON A.ORDEM_PRODUCAO = B.ORDEM_PRODUCAO         
                 
     --    --#24#        
     --    INNER JOIN ( SELECT ORDEM_PRODUCAO, COR_PRODUTO, SUM(QTDE_O) QTDE , SUM(PERDAS_NO_PROCESSO)*-1 QTDE_PERDA--#24#        
     --        FROM PRODUCAO_ORDEM_COR         
     --        GROUP BY ORDEM_PRODUCAO, COR_PRODUTO) C                 
     --    ON A.ORDEM_PRODUCAO = C.ORDEM_PRODUCAO AND A.COR_PRODUTO = C.COR_PRODUTO        
     --    --#24#         
        
     --  ) D         
     JOIN @PERC_COR AS D        
       ON D.ORDEM_PRODUCAO = A.ORDEM_PRODUCAO         
       AND D.COR_PRODUTO = A.COR_PRODUTO        
     --#24# - FIM        
        
   END         
   /*#13# - Fim*/         
        
   --#19#        
   UPDATE B        
   SET B.TOTAL_ABSORCAO_PERIODO = B.TOTAL_ABSORCAO_PERIODO + a.TOTAL_ABSORCAO_PERIODO          
   FROM @CM_PRODUCAO_PA_ABSORCAO A        
   INNER JOIN CM_PRODUCAO_PA_ABSORCAO B on        
       a.COD_CUSTO_MEDIO = b.COD_CUSTO_MEDIO and         
       a.PRODUTO = b.PRODUTO and         
       a.COR_PRODUTO = b.COR_PRODUTO  and         
       a.ORDEM_PRODUCAO = b.COR_PRODUTO and        
       a.TAREFA = b.TAREFA and          
       a.INDICADOR_ABSORCAO = b.INDICADOR_ABSORCAO         
   --#19#        
   INSERT INTO CM_PRODUCAO_PA_ABSORCAO ( COD_CUSTO_MEDIO, PRODUTO, COR_PRODUTO, ORDEM_PRODUCAO, TAREFA, INDICADOR_ABSORCAO,         
                                  TOTAL_QTDE_PERIODO, TOTAL_QTDE_ACUMULADA, TOTAL_MINUTOS_PERIODO, TOTAL_ABSORCAO_ACUMULADO,         
                                  TOTAL_ABSORCAO_PERIODO )              
   SELECT A.COD_CUSTO_MEDIO,         
     A.PRODUTO,         
     A.COR_PRODUTO,         
     A.ORDEM_PRODUCAO,         
     A.TAREFA,         
     A.INDICADOR_ABSORCAO,         
     A.TOTAL_QTDE_PERIODO,         
     A.TOTAL_QTDE_ACUMULADA,         
     A.TOTAL_MINUTOS_PERIODO,         
     A.TOTAL_ABSORCAO_ACUMULADO,         
     A.TOTAL_ABSORCAO_PERIODO        
   FROM @CM_PRODUCAO_PA_ABSORCAO AS A        
    --#19#        
    LEFT JOIN CM_PRODUCAO_PA_ABSORCAO B ON        
       A.COD_CUSTO_MEDIO = B.COD_CUSTO_MEDIO AND         
       A.PRODUTO = B.PRODUTO AND         
       A.COR_PRODUTO = B.COR_PRODUTO  AND         
       A.ORDEM_PRODUCAO = B.COR_PRODUTO AND        
       A.TAREFA = B.TAREFA AND          
       A.INDICADOR_ABSORCAO = B.INDICADOR_ABSORCAO         
   WHERE B.COD_CUSTO_MEDIO IS NULL        
    --#19#        
   --#5#        
        
   /*--------------------------------------------------------------------------------------------------------------------------------------*/        
   UPDATE CM_PRODUCAO_PA_ABSORCAO        
   SET TOTAL_QTDE_PERIODO = TOTAL_OP        
   FROM CM_PRODUCAO_PA_ABSORCAO AS A        
     INNER JOIN ( SELECT SUM(QTDE_A) AS TOTAL_OP, ORDEM_PRODUCAO, TAREFA, INDICADOR_ABSORCAO, PRODUTO        
          ,( CASE WHEN @FECHA_COR_PA = 1 THEN COR_PRODUTO ELSE '' END ) AS COR_PRODUTO/*#13#*/         
         FROM ( SELECT DISTINCT C.QTDE_A, O.ORDEM_PRODUCAO, B.ORDEM_SERVICO, C.TAREFA,         
          ISNULL(I.INDICADOR_ABSORCAO , @IND_MP_PADRAO) AS INDICADOR_ABSORCAO, C.PRODUTO, C.COR_PRODUTO        
          FROM PRODUCAO_ORDEM_SERVICO B  (NOLOCK)/*#GS:01.02#*/       
            INNER JOIN PRODUCAO_OS_ANTERIOR  (NOLOCK)/*#GS:01.02#*/C ON C.ORDEM_SERVICO = B.ORDEM_SERVICO         
            INNER JOIN PRODUTOS  (NOLOCK)/*#GS:01.02#*/P ON P.PRODUTO = C.PRODUTO        
            INNER JOIN PRODUCAO_ORDEM  (NOLOCK)/*#GS:01.02#*/O ON O.ORDEM_PRODUCAO = C.ORDEM_PRODUCAO        
            INNER JOIN ESTOQUE_SAI_MAT  (NOLOCK)/*#GS:01.02#*/G ON G.ORDEM_SERVICO = B.ORDEM_SERVICO        
            INNER JOIN ESTOQUE_SAI1_MAT  (NOLOCK)/*#GS:01.02#*/H ON H.REQ_MATERIAL = G.REQ_MATERIAL AND         
                     H.FILIAL = G.FILIAL AND         
                     H.ORDEM_PRODUCAO = C.ORDEM_PRODUCAO        
            LEFT JOIN ( PRODUCAO_CUSTO_ABSORCAO  (NOLOCK)/*#GS:01.02#*/I         
               INNER JOIN PRODUCAO_CUSTO_RECURSO  (NOLOCK)/*#GS:01.02#*/J ON J.INDICADOR_ABSORCAO = I.INDICADOR_ABSORCAO         
             ) ON J.RECURSO_PRODUTIVO = B.RECURSO_PRODUTIVO AND         
               I.TIPO_INDICADOR = 1        
          WHERE --( B.DATA BETWEEN @DATA_INI AND @DATA_FIN ) AND --##        
              ( G.EMISSAO BETWEEN @DATA_INI AND @DATA_FIN ) AND --##         
             B.INDICADOR_TIPO_MOV IN ( 1, 3 ) AND         
             ISNULL(P.MONTAGEM_KIT, 0) = @SEMI_ACABADO AND        
             ISNULL(O.TIPO_PROCESSO, 0) NOT IN ( 4 )        
           ) AS A        
         GROUP BY ORDEM_PRODUCAO, TAREFA, INDICADOR_ABSORCAO, PRODUTO        
          ,( CASE WHEN @FECHA_COR_PA = 1 THEN COR_PRODUTO ELSE '' END ) /*#13#*/        
       ) AS B ON A.ORDEM_PRODUCAO =  B.ORDEM_PRODUCAO AND        
           A.TAREFA = B.TAREFA AND         
           A.INDICADOR_ABSORCAO = B.INDICADOR_ABSORCAO AND         
           A.PRODUTO = B.PRODUTO AND        
           A.COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO        
           AND A.COR_PRODUTO = B.COR_PRODUTO        
        
        
   /*--------------------------------------------------------------------------------------------------------------------------------------*/        
           
/*---------------------------------------------------------------------------------------------------------------------------------------------*/        
   -- CUSTO ABSORÇÃO - 2 - CUSTO OS        
   IF ( SELECT ISNULL(DBO.FX_PARAMETRO('CM_UTILIZA_IMPOSTO_MD'), '.F.') ) = '.T.' -- UTILIZADO POR CAUSA DA PERNAMBUCANAS        
   BEGIN        
        
    INSERT INTO CM_PRODUCAO_PA_ABSORCAO ( COD_CUSTO_MEDIO, PRODUTO, COR_PRODUTO, ORDEM_PRODUCAO, TAREFA, INDICADOR_ABSORCAO,         
                                          TOTAL_QTDE_PERIODO, TOTAL_QTDE_ACUMULADA, TOTAL_MINUTOS_PERIODO, TOTAL_ABSORCAO_ACUMULADO,         
                                          TOTAL_ABSORCAO_PERIODO )        
    SELECT         
     COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO,         
     A.PRODUTO,         
     ( CASE WHEN @FECHA_COR_PA = 1 THEN A.COR_PRODUTO ELSE '' END ) /*#13#*/,         
     A.ORDEM_PRODUCAO,        
     '',        
     INDICADOR_ABSORCAO = ISNULL(I.INDICADOR_ABSORCAO, @IND_OS_PADRAO),        
     TOTAL_QTDE_PERIODO = SUM(CASE WHEN B.INDICADOR_TIPO_MOV IN (1,3) THEN A.QTDE_A ELSE 0 END),         
     TOTAL_QTDE_ACUMULADA = 0,         
     TOTAL_MINUTOS_PERIODO = 0,         
     TOTAL_ABSORCAO_ACUMULADO = 0,         
     TOTAL_ABSORCAO_PERIODO = SUM(CAST(( ISNULL(A.VALOR_CREDITADO,0) - ISNULL(ENTRADAS.VALOR_IMPOSTOS, 0) ) AS NUMERIC(15,5))) --#20#        
/*        
     TOTAL_ABSORCAO_PERIODO = SUM(CAST(( ISNULL(A.VALOR_CREDITADO,0) -         
              ( ( CASE WHEN ISNULL(ENTRADAS.QTDE_ITEM, 0) = 0         
                  THEN 0         
                  ELSE ( ISNULL(ENTRADAS.VALOR_IMPOSTOS, 0) / ISNULL(ENTRADAS.QTDE_ITEM, 0) )        
               END ) * A.QTDE_A ) ) AS NUMERIC(14,2)))         
*/        
    FROM PRODUCAO_OS_ANTERIOR A (NOLOCK)/*#GS:01.02#*/       
      JOIN PRODUCAO_ORDEM  (NOLOCK)/*#GS:01.02#*/O ON O.ORDEM_PRODUCAO=A.ORDEM_PRODUCAO        
      JOIN PRODUTOS  (NOLOCK)/*#GS:01.02#*/P ON P.PRODUTO=A.PRODUTO        
      JOIN PRODUCAO_ORDEM_SERVICO  (NOLOCK)/*#GS:01.02#*/B ON A.ORDEM_SERVICO = ISNULL(B.ORDEM_SERVICO_PARALELA,B.ORDEM_SERVICO)/*#14#*/        
      JOIN ( SELECT A.NF_ENTRADA, A.SERIE_NF_ENTRADA, A.NOME_CLIFOR, SUM(A.VALOR_IMPOSTO_ESPELHO) AS VALOR_IMPOSTOS,         
           AVG(C.QTDE_ITEM) AS QTDE_ITEM, D.NATUREZA --#16#        
          FROM ENTRADAS_IMPOSTO  (NOLOCK)/*#GS:01.02#*/AS A         
         INNER JOIN ENTRADAS_ITEM  (NOLOCK)/*#GS:01.02#*/AS C ON A.NF_ENTRADA = C.NF_ENTRADA AND        
                  A.SERIE_NF_ENTRADA = C.SERIE_NF_ENTRADA AND        
                  A.NOME_CLIFOR = C.NOME_CLIFOR AND        
                  A.ITEM_IMPRESSAO = C.ITEM_IMPRESSAO AND        
                  A.SUB_ITEM_TAMANHO = C.SUB_ITEM_TAMANHO        
         --#16#        
         INNER JOIN ENTRADAS  (NOLOCK)/*#GS:01.02#*/AS D ON D.NF_ENTRADA = C.NF_ENTRADA AND        
                  D.SERIE_NF_ENTRADA = C.SERIE_NF_ENTRADA AND        
                  D.NOME_CLIFOR = C.NOME_CLIFOR         
         --#16#        
         INNER JOIN ( SELECT DISTINCT NF_ENTRADA, SERIE_NF_ENTRADA, BENEFICIADOR_TAREFA_ANTERIOR         
             FROM PRODUCAO_ORDEM_SERVICO  (NOLOCK)/*#GS:01.02#*/        
             WHERE DATA BETWEEN @DATA_INI AND @DATA_FIN        
              ) AS B ON A.NF_ENTRADA = B.NF_ENTRADA AND         
               A.SERIE_NF_ENTRADA = B.SERIE_NF_ENTRADA AND         
               A.NOME_CLIFOR = B.BENEFICIADOR_TAREFA_ANTERIOR        
               WHERE A.VALOR_IMPOSTO_ESPELHO <> 0     
      AND A.ID_IMPOSTO <> 1 --#CSM001#      
               GROUP BY A.NF_ENTRADA, A.SERIE_NF_ENTRADA, A.NOME_CLIFOR, D.NATUREZA --#16#        
         ) AS ENTRADAS ON B.NF_ENTRADA = ENTRADAS.NF_ENTRADA AND         
               B.SERIE_NF_ENTRADA = ENTRADAS.SERIE_NF_ENTRADA AND         
                  B.BENEFICIADOR_TAREFA_ANTERIOR = ENTRADAS.NOME_CLIFOR        
        --#16#        
      INNER JOIN NATUREZAS_ENTRADAS AS NE ON NE.NATUREZA = ENTRADAS.NATUREZA        
      LEFT JOIN  CTB_LX_TIPO_OPERACAO AS CTO  ON CTO.CTB_TIPO_OPERACAO = NE.CTB_TIPO_OPERACAO         
      --#16#        
              
              
      /*#21# - Início*/        
      INNER JOIN         
      (SELECT A.NF_ENTRADA , A.SERIE_NF_ENTRADA ,NOME_CLIFOR FROM ENTRADAS A (NOLOCK)        
       INNER JOIN CTB_LANCAMENTO B (NOLOCK) ON A.CTB_LANCAMENTO =  B.LANCAMENTO AND A.EMPRESA = B.EMPRESA        
       INNER JOIN CTB_LANCAMENTO_ITEM C (NOLOCK) ON C.LANCAMENTO  =  B.LANCAMENTO AND C.EMPRESA = B.EMPRESA        
       INNER JOIN CTB_A_PAGAR_FATURA D (NOLOCK) ON D.FATURA = A.NF_ENTRADA AND D.FATURA_SERIE = A.SERIE_NF_ENTRADA         
       AND (SELECT NOME_CLIFOR FROM CADASTRO_CLI_FOR (NOLOCK) WHERE COD_CLIFOR = D.COD_CLIFOR) = A.NOME_CLIFOR        
          WHERE  LX_TIPO_LANCAMENTO = 'ITP'        
       )AS  VITP  ON VITP.NF_ENTRADA = B.NF_ENTRADA         
           AND VITP.SERIE_NF_ENTRADA = B.SERIE_NF_ENTRADA         
           AND VITP.NOME_CLIFOR = B.BENEFICIADOR_TAREFA_ANTERIOR         
      /*#21# - Fim*/        
              
      JOIN PRODUCAO_TAREFAS  (NOLOCK)/*#GS:01.02#*/C ON C.TAREFA = A.TAREFA_ANTERIOR        
      LEFT JOIN ( PRODUCAO_CUSTO_ABSORCAO  (NOLOCK)/*#GS:01.02#*/I        
         INNER JOIN PRODUCAO_CUSTO_RECURSO  (NOLOCK)/*#GS:01.02#*/J ON J.INDICADOR_ABSORCAO = I.INDICADOR_ABSORCAO        
          ) ON J.RECURSO_PRODUTIVO = C.RECURSO_PRODUTIVO AND         
            I.TIPO_INDICADOR = 2        
    WHERE B.DATA BETWEEN @DATA_INI AND @DATA_FIN         
      AND ISNULL(P.SEMI_ACABADO, 0) = @SEMI_ACABADO         
      AND ( ( @CONSERTO = 0 AND ISNULL(O.TIPO_PROCESSO, 0) IN ( 0, 4 ) ) OR         
       ( @CONSERTO = 1 AND O.TIPO_PROCESSO IN ( 1, 2, 3, 5 ) ) ) --#10#        
      /*#15# - Início*/        
       AND (        
        (         
         @CALCULA_CUSTO_POR_FILIAL=1        
         AND          
         EXISTS (SELECT COD_CUSTO_MEDIO         
           FROM CM_FECHAMENTO_CUSTO_MEDIO_FILIAIS CMF          
           INNER JOIN FILIAIS  (NOLOCK)/*#GS:01.02#*/FI ON CMF.COD_FILIAL = FI.COD_FILIAL        
           WHERE CMF.COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO AND FI.FILIAL = O.FILIAL        
           )         
        )        
         OR         
        (        
         @CALCULA_CUSTO_POR_FILIAL=0        
        )        
       )        
      /*#15# - Fim*/        
      AND CTO.GERA_FINANCEIRO = 1 --#16#        
      /*#17# - Início*/        
      AND EXISTS (        
          SELECT EMPRESA         
          FROM FILIAIS  (NOLOCK)/*#GS:01.02#*/FI         
          WHERE FI.FILIAL = O.FILIAL AND         
          ( FI.EMPRESA = @EMPRESA OR FI.EMPRESA IS NULL OR @EMPRESA=-1 )         
         )         
      /*#17# - Fim*/        
              
              
        
    GROUP BY A.PRODUTO, A.ORDEM_PRODUCAO, I.INDICADOR_ABSORCAO        
      ,( CASE WHEN @FECHA_COR_PA = 1 THEN A.COR_PRODUTO ELSE '' END ) /*#13#*/         
        
   END        
   ELSE        
   BEGIN        
 -- #GS:01.01# - INICIO
 -- INICIO - CRIANDO AS TABELAS  TEMPORARIAS -- 
IF(ISNULL(OBJECT_ID('TEMPDB..#IMPOSTO'),'')) <> ''
BEGIN
	DROP TABLE #IMPOSTO
END 

SELECT IMPOSTOS_TAXA.NF_ENTRADA, IMPOSTOS_TAXA.SERIE_NF_ENTRADA, IMPOSTOS_TAXA.NOME_CLIFOR,         
MAX(IMPOSTOS_TAXA.TAXA) AS TAXA        
INTO #IMPOSTO
FROM ( SELECT IMP.NF_ENTRADA, IMP.SERIE_NF_ENTRADA, IMP.NOME_CLIFOR, IMP.ITEM_IMPRESSAO, IMP.SUB_ITEM_TAMANHO,         
( ( 100.00000 - SUM(TAXA_IMPOSTO_ESPELHO) ) / 100.00000 ) AS TAXA 
FROM ENTRADAS_IMPOSTO AS IMP    (NOLOCK)    
INNER JOIN ENTRADAS_ITEM AS ITEM (NOLOCK)ON IMP.NF_ENTRADA = ITEM.NF_ENTRADA AND        
IMP.SERIE_NF_ENTRADA = ITEM.SERIE_NF_ENTRADA AND        
IMP.NOME_CLIFOR = ITEM.NOME_CLIFOR AND        
IMP.ITEM_IMPRESSAO = ITEM.ITEM_IMPRESSAO AND        
IMP.SUB_ITEM_TAMANHO = ITEM.SUB_ITEM_TAMANHO/* AND        
ITEM.COD_TABELA_FILHA = 'O'*/        
WHERE IMP.TAXA_IMPOSTO_ESPELHO > 0        
AND IMP.ID_IMPOSTO <> 1 --#CSM001#   
GROUP BY IMP.NF_ENTRADA, IMP.SERIE_NF_ENTRADA, IMP.NOME_CLIFOR, IMP.ITEM_IMPRESSAO, IMP.SUB_ITEM_TAMANHO        
) AS IMPOSTOS_TAXA        
GROUP BY IMPOSTOS_TAXA.NF_ENTRADA, IMPOSTOS_TAXA.SERIE_NF_ENTRADA, IMPOSTOS_TAXA.NOME_CLIFOR   
CREATE NONCLUSTERED INDEX [IDSGS_#IMPOSTO]
ON [DBO].[#IMPOSTO] ([NF_ENTRADA],[SERIE_NF_ENTRADA],[NOME_CLIFOR])
WITH FILLFACTOR = 100     
--
IF(ISNULL(OBJECT_ID('TEMPDB..#IMPOSTO_VALORES'),'')) <> ''
BEGIN
	DROP TABLE #IMPOSTO_VALORES
END 

SELECT IMP.NF_ENTRADA, IMP.SERIE_NF_ENTRADA, IMP.NOME_CLIFOR,         
SUM( CASE WHEN  ISNULL(OS.QTDE_O,0) = 0 THEN 0 ELSE ( IMP.VALOR_IMPOSTO_ESPELHO / OS.QTDE_O ) END ) AS VALOR_IMPOSTO /*#11#*/ 
INTO #IMPOSTO_VALORES       
FROM ENTRADAS_IMPOSTO AS IMP (NOLOCK)       
INNER JOIN ENTRADAS_ITEM AS ITEM (NOLOCK)ON IMP.NF_ENTRADA = ITEM.NF_ENTRADA AND        
IMP.SERIE_NF_ENTRADA = ITEM.SERIE_NF_ENTRADA AND        
IMP.NOME_CLIFOR = ITEM.NOME_CLIFOR AND        
IMP.ITEM_IMPRESSAO = ITEM.ITEM_IMPRESSAO AND        
IMP.SUB_ITEM_TAMANHO = ITEM.SUB_ITEM_TAMANHO AND        
ITEM.COD_TABELA_FILHA IN ( 'A', 'C' )        
/*#11# - INICIO*/        
LEFT JOIN (SELECT A.NF_ENTRADA,A.SERIE_NF_ENTRADA,SUM(B.QTDE_O) AS QTDE_O        
FROM PRODUCAO_ORDEM_SERVICO A (NOLOCK)        
INNER JOIN PRODUCAO_OS_TAREFAS B (NOLOCK)ON A.ORDEM_SERVICO = B.ORDEM_SERVICO        
GROUP BY A.NF_ENTRADA,A.SERIE_NF_ENTRADA        
) AS OS  ON ITEM.NF_ENTRADA = OS.NF_ENTRADA AND ITEM.SERIE_NF_ENTRADA = OS.SERIE_NF_ENTRADA       
/*#11# - FIM*/        
GROUP BY IMP.NF_ENTRADA, IMP.SERIE_NF_ENTRADA, IMP.NOME_CLIFOR	
CREATE NONCLUSTERED INDEX [IDSGS_#IMPOSTO_VALORES]
ON [DBO].[#IMPOSTO_VALORES] ([NF_ENTRADA],[SERIE_NF_ENTRADA],[NOME_CLIFOR])
WITH FILLFACTOR = 100			        
--
IF(ISNULL(OBJECT_ID('TEMPDB..#VITP'),'')) <> ''
BEGIN
	DROP TABLE #VITP
END 
SELECT A.NF_ENTRADA , A.SERIE_NF_ENTRADA ,NOME_CLIFOR 
INTO #VITP
FROM ENTRADAS A (NOLOCK)        
INNER JOIN CTB_LANCAMENTO B (NOLOCK) ON A.CTB_LANCAMENTO =  B.LANCAMENTO AND A.EMPRESA = B.EMPRESA        
INNER JOIN CTB_LANCAMENTO_ITEM C (NOLOCK) ON C.LANCAMENTO  =  B.LANCAMENTO AND C.EMPRESA = B.EMPRESA        
INNER JOIN CTB_A_PAGAR_FATURA D (NOLOCK) ON D.FATURA = A.NF_ENTRADA AND D.FATURA_SERIE = A.SERIE_NF_ENTRADA         
AND (SELECT NOME_CLIFOR FROM CADASTRO_CLI_FOR (NOLOCK) WHERE COD_CLIFOR = D.COD_CLIFOR) = A.NOME_CLIFOR        
   WHERE  LX_TIPO_LANCAMENTO = 'ITP'  
CREATE NONCLUSTERED INDEX [IDSGS_#VITP]
ON [DBO].[#VITP] ([NF_ENTRADA],[SERIE_NF_ENTRADA],[NOME_CLIFOR])
WITH FILLFACTOR = 100	   
-- INICIO - CRIANDO AS TABELAS  TEMPORARIAS -- 
 -- #GS:01.01# - FIM
    INSERT INTO CM_PRODUCAO_PA_ABSORCAO ( COD_CUSTO_MEDIO, PRODUTO, COR_PRODUTO, ORDEM_PRODUCAO, TAREFA, INDICADOR_ABSORCAO,         
               TOTAL_QTDE_PERIODO, TOTAL_QTDE_ACUMULADA, TOTAL_MINUTOS_PERIODO, TOTAL_ABSORCAO_ACUMULADO,         
               TOTAL_ABSORCAO_PERIODO )        
    SELECT @COD_CUSTO_MEDIO, A.PRODUTO,         
      ( CASE WHEN @FECHA_COR_PA = 1 THEN A.COR_PRODUTO ELSE '' END ) AS COR_PRODUTO /*#13#*/  ,         
      A.ORDEM_PRODUCAO, '' AS TAREFA,         
       ISNULL(I.INDICADOR_ABSORCAO, @IND_OS_PADRAO) AS INDICADOR_ABSORCAO,         
               
                    
             SUM(( CASE WHEN B.INDICADOR_TIPO_MOV IN ( 1, 3 )         
        THEN A.QTDE_A         
        ELSE 0         
        END )) AS TOTAL_QTDE_PERIODO,         
              
        
                
      0 AS TOTAL_QTDE_ACUMULADA, 0 AS TOTAL_MINUTOS_PERIODO, 0 AS TOTAL_ABSORCAO_ACUMULADO,         
              
      --#23#          
      /*        
         SUM(( CASE WHEN B.INDICADOR_TIPO_MOV IN ( 1, 3 )         
       THEN ( CASE WHEN ( ( ISNULL(DBO.FX_PARAMETRO('CM_UTILIZA_TAXA_NF_OS'), '.F.') = '.T.' ) OR        
            ( IMPOSTOS_VALORES.NF_ENTRADA IS NULL ) )        
          THEN ( ISNULL(A.VALOR_CREDITADO, 0) * ( CASE WHEN DBO.FX_PARAMETRO('ABATE_IMPOSTO_NF_OS') = '.F.'         
                     THEN ISNULL(IMPOSTOS.TAXA, 1.0000)        
                     ELSE 1.0000        
                    END ) )        
          ELSE ( ISNULL(A.VALOR_CREDITADO, 0) - ( ISNULL(IMPOSTOS_VALORES.VALOR_IMPOSTO, 0) * A.QTDE_A ) )        
         END )        
       ELSE 0         
       END )) AS TOTAL_ABSORCAO_PERIODO         
      */                    
      SUM(( CASE WHEN B.INDICADOR_TIPO_MOV IN ( 1, 3 )         
        THEN ( CASE WHEN ( ( ISNULL(DBO.FX_PARAMETRO('CM_UTILIZA_TAXA_NF_OS'), '.F.') = '.T.' ) OR        
               ( IMPOSTOS_VALORES.NF_ENTRADA IS NULL ) )        
            --THEN ( ISNULL(ENT.VALOR_TOTAL, 0) * ( CASE WHEN DBO.FX_PARAMETRO('ABATE_IMPOSTO_NF_OS') = '.F.'         
            THEN ( ISNULL((ENT_ITENS.VALOR_ITEM / OS_TOTAL.QTDE_A_TOTAL)*A.QTDE_A, 0) * ( CASE WHEN DBO.FX_PARAMETRO('ABATE_IMPOSTO_NF_OS') = '.F.'         
                      THEN ISNULL(IMPOSTOS.TAXA, 1.0000)        
                      ELSE 1.0000        
                      END ) )        
            ELSE ( ISNULL((ENT_ITENS.VALOR_ITEM / OS_TOTAL.QTDE_A_TOTAL)*A.QTDE_A, 0)  - ( ISNULL(IMPOSTOS_VALORES.VALOR_IMPOSTO, 0) * A.QTDE_A ) )        
            END )        
        ELSE 0         
        END )) AS TOTAL_ABSORCAO_PERIODO         
         -- #23#          
        
    FROM PRODUCAO_OS_ANTERIOR A  (NOLOCK)/*#GS:01.02#*/       
      INNER JOIN PRODUCAO_ORDEM  (NOLOCK)/*#GS:01.02#*/O ON O.ORDEM_PRODUCAO = A.ORDEM_PRODUCAO        
      INNER JOIN PRODUTOS  (NOLOCK)/*#GS:01.02#*/P ON P.PRODUTO = A.PRODUTO        
      INNER JOIN PRODUCAO_ORDEM_SERVICO  (NOLOCK)/*#GS:01.02#*/B ON A.ORDEM_SERVICO = ISNULL(B.ORDEM_SERVICO_PARALELA,B.ORDEM_SERVICO)/*#14#*/        
      INNER JOIN ENTRADAS  (NOLOCK)/*#GS:01.02#*/AS ENT ON B.NF_ENTRADA = ENT.NF_ENTRADA AND         
               B.SERIE_NF_ENTRADA = ENT.SERIE_NF_ENTRADA AND         
               B.BENEFICIADOR_TAREFA_ANTERIOR = ENT.NOME_CLIFOR        
             
     --#23#           
     INNER JOIN (SELECT NF_ENTRADA, SERIE_NF_ENTRADA, NOME_CLIFOR, ITEM_IMPRESSAO, SUM(QTDE_ITEM) QTDE_ITEM, SUM(VALOR_ITEM) AS VALOR_ITEM        
           FROM  ENTRADAS_ITEM  (NOLOCK)/*#GS:01.02#*/AS ITEM         
                             GROUP BY NF_ENTRADA, SERIE_NF_ENTRADA, NOME_CLIFOR, ITEM_IMPRESSAO) AS ENT_ITENS         
        ON B.NF_ENTRADA = ENT_ITENS.NF_ENTRADA AND         
           B.SERIE_NF_ENTRADA = ENT_ITENS.SERIE_NF_ENTRADA AND         
           B.BENEFICIADOR_TAREFA_ANTERIOR = ENT_ITENS.NOME_CLIFOR AND         
           A.ITEM_IMPRESSAO = ENT_ITENS.ITEM_IMPRESSAO        
        
     INNER JOIN (SELECT B.NF_ENTRADA, B.BENEFICIADOR_TAREFA_ANTERIOR NOME_CLIFOR, B.SERIE_NF_ENTRADA, A.ITEM_IMPRESSAO, SUM(QTDE_A) QTDE_A_TOTAL         
        FROM PRODUCAO_OS_ANTERIOR A  (NOLOCK)/*#GS:01.02#*/         
        JOIN PRODUCAO_ORDEM_SERVICO  (NOLOCK)/*#GS:01.02#*/B ON A.ORDEM_SERVICO = B.ORDEM_SERVICO        
        GROUP BY B.NF_ENTRADA, B.BENEFICIADOR_TAREFA_ANTERIOR, B.SERIE_NF_ENTRADA, A.ITEM_IMPRESSAO) OS_TOTAL         
         ON OS_TOTAL.NF_ENTRADA = ENT.NF_ENTRADA AND         
         OS_TOTAL.SERIE_NF_ENTRADA = ENT.SERIE_NF_ENTRADA AND        
         OS_TOTAL.NOME_CLIFOR = ENT.NOME_CLIFOR AND         
         OS_TOTAL.ITEM_IMPRESSAO = ENT_ITENS.ITEM_IMPRESSAO        
     --#23#        
        
      --#16#        
      INNER JOIN NATUREZAS_ENTRADAS  (NOLOCK)/*#GS:01.02#*/AS NE ON NE.NATUREZA = ENT.NATUREZA        
      LEFT JOIN  CTB_LX_TIPO_OPERACAO  (NOLOCK)/*#GS:01.02#*/AS CTO ON CTO.CTB_TIPO_OPERACAO = NE.CTB_TIPO_OPERACAO          
      --#16#        
      LEFT JOIN ( 
	  -- INCLUSÃO DA TABELA TEMPORARIA 
	  SELECT NF_ENTRADA,SERIE_NF_ENTRADA,NOME_CLIFOR,TAXA 
	  FROM #IMPOSTO
--SELECT IMPOSTOS_TAXA.NF_ENTRADA, IMPOSTOS_TAXA.SERIE_NF_ENTRADA, IMPOSTOS_TAXA.NOME_CLIFOR,         
--MAX(IMPOSTOS_TAXA.TAXA) AS TAXA        
--FROM ( SELECT IMP.NF_ENTRADA, IMP.SERIE_NF_ENTRADA, IMP.NOME_CLIFOR, IMP.ITEM_IMPRESSAO, IMP.SUB_ITEM_TAMANHO,         
--( ( 100.00000 - SUM(TAXA_IMPOSTO_ESPELHO) ) / 100.00000 ) AS TAXA        
--FROM ENTRADAS_IMPOSTO AS IMP        
--INNER JOIN ENTRADAS_ITEM AS ITEM ON IMP.NF_ENTRADA = ITEM.NF_ENTRADA AND        
--IMP.SERIE_NF_ENTRADA = ITEM.SERIE_NF_ENTRADA AND        
--IMP.NOME_CLIFOR = ITEM.NOME_CLIFOR AND        
--IMP.ITEM_IMPRESSAO = ITEM.ITEM_IMPRESSAO AND        
--IMP.SUB_ITEM_TAMANHO = ITEM.SUB_ITEM_TAMANHO/* AND        
--ITEM.COD_TABELA_FILHA = 'O'*/        
--WHERE IMP.TAXA_IMPOSTO_ESPELHO > 0        
--AND IMP.ID_IMPOSTO <> 1 --#CSM001#   
--GROUP BY IMP.NF_ENTRADA, IMP.SERIE_NF_ENTRADA, IMP.NOME_CLIFOR, IMP.ITEM_IMPRESSAO, IMP.SUB_ITEM_TAMANHO        
--) AS IMPOSTOS_TAXA        
--GROUP BY IMPOSTOS_TAXA.NF_ENTRADA, IMPOSTOS_TAXA.SERIE_NF_ENTRADA, IMPOSTOS_TAXA.NOME_CLIFOR        
) AS IMPOSTOS ON B.NF_ENTRADA = IMPOSTOS.NF_ENTRADA AND         
         B.SERIE_NF_ENTRADA = IMPOSTOS.SERIE_NF_ENTRADA AND         
         B.BENEFICIADOR_TAREFA_ANTERIOR = IMPOSTOS.NOME_CLIFOR        
      LEFT JOIN ( 
	  -- INCLUSÃO DA TABELA TEMPORARIA 
	  SELECT NF_ENTRADA,SERIE_NF_ENTRADA,NOME_CLIFOR,VALOR_IMPOSTO 
	  FROM #IMPOSTO_VALORES
--SELECT IMP.NF_ENTRADA, IMP.SERIE_NF_ENTRADA, IMP.NOME_CLIFOR,         
--SUM( CASE WHEN  ISNULL(OS.QTDE_O,0) = 0 THEN 0 ELSE ( IMP.VALOR_IMPOSTO_ESPELHO / OS.QTDE_O ) END ) AS VALOR_IMPOSTO /*#11#*/        
--FROM ENTRADAS_IMPOSTO AS IMP        
--INNER JOIN ENTRADAS_ITEM AS ITEM ON IMP.NF_ENTRADA = ITEM.NF_ENTRADA AND        
--IMP.SERIE_NF_ENTRADA = ITEM.SERIE_NF_ENTRADA AND        
--IMP.NOME_CLIFOR = ITEM.NOME_CLIFOR AND        
--IMP.ITEM_IMPRESSAO = ITEM.ITEM_IMPRESSAO AND        
--IMP.SUB_ITEM_TAMANHO = ITEM.SUB_ITEM_TAMANHO AND        
--ITEM.COD_TABELA_FILHA IN ( 'A', 'C' )        
                            
--/*#11# - INICIO*/        
--LEFT JOIN (SELECT A.NF_ENTRADA,A.SERIE_NF_ENTRADA,SUM(B.QTDE_O) AS QTDE_O        
--FROM PRODUCAO_ORDEM_SERVICO A         
--INNER JOIN PRODUCAO_OS_TAREFAS B ON A.ORDEM_SERVICO = B.ORDEM_SERVICO        
--GROUP BY A.NF_ENTRADA,A.SERIE_NF_ENTRADA        
--) AS OS  ON ITEM.NF_ENTRADA = OS.NF_ENTRADA AND ITEM.SERIE_NF_ENTRADA = OS.SERIE_NF_ENTRADA        
--/*#11# - FIM*/        
--GROUP BY IMP.NF_ENTRADA, IMP.SERIE_NF_ENTRADA, IMP.NOME_CLIFOR        
) AS IMPOSTOS_VALORES ON B.NF_ENTRADA = IMPOSTOS_VALORES.NF_ENTRADA AND         
               B.SERIE_NF_ENTRADA = IMPOSTOS_VALORES.SERIE_NF_ENTRADA AND         
               B.BENEFICIADOR_TAREFA_ANTERIOR = IMPOSTOS_VALORES.NOME_CLIFOR        
          /*#27# - Início*/        
          INNER JOIN         
          (
		-- INCLUSÃO DA TABELA TEMPORARIA
		SELECT NF_ENTRADA,SERIE_NF_ENTRADA,NOME_CLIFOR FROM #VITP
--SELECT A.NF_ENTRADA , A.SERIE_NF_ENTRADA ,NOME_CLIFOR FROM ENTRADAS A (NOLOCK)        
--INNER JOIN CTB_LANCAMENTO B (NOLOCK) ON A.CTB_LANCAMENTO =  B.LANCAMENTO AND A.EMPRESA = B.EMPRESA        
--INNER JOIN CTB_LANCAMENTO_ITEM C (NOLOCK) ON C.LANCAMENTO  =  B.LANCAMENTO AND C.EMPRESA = B.EMPRESA        
--INNER JOIN CTB_A_PAGAR_FATURA D (NOLOCK) ON D.FATURA = A.NF_ENTRADA AND D.FATURA_SERIE = A.SERIE_NF_ENTRADA         
--AND (SELECT NOME_CLIFOR FROM CADASTRO_CLI_FOR (NOLOCK) WHERE COD_CLIFOR = D.COD_CLIFOR) = A.NOME_CLIFOR        
--WHERE  LX_TIPO_LANCAMENTO = 'ITP'        
          )AS  VITP  ON VITP.NF_ENTRADA = B.NF_ENTRADA         
              AND VITP.SERIE_NF_ENTRADA = B.SERIE_NF_ENTRADA         
              AND VITP.NOME_CLIFOR = B.BENEFICIADOR_TAREFA_ANTERIOR         
          /*#27# - Fim*/        
        
      INNER JOIN PRODUCAO_TAREFAS  (NOLOCK)/*#GS:01.02#*/C ON C.TAREFA = A.TAREFA_ANTERIOR        
      LEFT JOIN ( PRODUCAO_CUSTO_ABSORCAO  (NOLOCK)/*#GS:01.02#*/I         
         INNER JOIN PRODUCAO_CUSTO_RECURSO  (NOLOCK)/*#GS:01.02#*/J ON J.INDICADOR_ABSORCAO = I.INDICADOR_ABSORCAO        
          ) ON J.RECURSO_PRODUTIVO = C.RECURSO_PRODUTIVO AND         
         I.TIPO_INDICADOR = 2        
    WHERE         
      /* B.DATA BETWEEN @DATA_INI AND @DATA_FIN AND #12#*/        
      ent.RECEBIMENTO BETWEEN @DATA_INI AND @DATA_FIN AND /*#12#*/        
      ISNULL(P.MONTAGEM_KIT, 0) = @SEMI_ACABADO AND         
      ISNULL(O.TIPO_PROCESSO, 0) NOT IN ( 4 )        
      /*#15# - Início*/        
       AND (        
        (         
         @CALCULA_CUSTO_POR_FILIAL=1        
         AND          
         EXISTS (SELECT COD_CUSTO_MEDIO         
           FROM CM_FECHAMENTO_CUSTO_MEDIO_FILIAIS CMF          
           INNER JOIN FILIAIS  (NOLOCK)/*#GS:01.02#*/FI ON CMF.COD_FILIAL = FI.COD_FILIAL        
           WHERE CMF.COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO AND FI.FILIAL = O.FILIAL        
           )         
        )        
         OR         
        (        
         @CALCULA_CUSTO_POR_FILIAL=0        
        )        
       )        
      /*#15# - Fim*/        
AND CTO.GERA_FINANCEIRO = 1 --#16#        
      /*#17# - Início*/        
      AND EXISTS (        
          SELECT EMPRESA         
          FROM FILIAIS  (NOLOCK)/*#GS:01.02#*/FI         
          WHERE FI.FILIAL = O.FILIAL AND         
          ( FI.EMPRESA = @EMPRESA OR FI.EMPRESA IS NULL OR @EMPRESA=-1 )         
       )         
      /*#17# - Fim*/        
               
    GROUP BY A.PRODUTO, A.ORDEM_PRODUCAO, I.INDICADOR_ABSORCAO        
      ,( CASE WHEN @FECHA_COR_PA = 1 THEN A.COR_PRODUTO ELSE '' END ) /*#13#*/           
        
   END        
/*---------------------------------------------------------------------------------------------------------------------------------------------*/        
        
   -- CUSTO ABSORÇÃO - 3 - CUSTO FABRIL        
   INSERT INTO CM_PRODUCAO_PA_ABSORCAO ( COD_CUSTO_MEDIO, PRODUTO, COR_PRODUTO, ORDEM_PRODUCAO, TAREFA, INDICADOR_ABSORCAO,         
                                         TOTAL_QTDE_PERIODO, TOTAL_QTDE_ACUMULADA, TOTAL_MINUTOS_PERIODO, TOTAL_ABSORCAO_ACUMULADO,         
                                         TOTAL_ABSORCAO_PERIODO )        
   SELECT @COD_CUSTO_MEDIO AS COD_CUSTO_MEDIO, A.PRODUTO,         
     ( CASE WHEN @FECHA_COR_PA = 1 THEN A.COR_PRODUTO ELSE '' END ) AS COR_PRODUTO /*#13#*/          
     , A.ORDEM_PRODUCAO, A.TAREFA_ANTERIOR AS TAREFA,         
     I.INDICADOR_ABSORCAO AS INDICADOR_ABSORCAO, SUM(A.QTDE_A) AS TOTAL_QTDE_PERIODO, 0 AS TOTAL_QTDE_ACUMULADA,         
     0 AS TOTAL_MINUTOS_PERIODO, 0 AS TOTAL_ABSORCAO_ACUMULADO,         
     CAST(SUM(( ISNULL(A.VALOR_CREDITADO, 0) * ( ISNULL(J.PORC_CUSTO_FABRIL, 0) / 100. ) )) AS NUMERIC(15,5)) AS TOTAL_ABSORCAO_PERIODO --#20#        
   FROM PRODUCAO_OS_ANTERIOR  (NOLOCK)/*#GS:01.02#*/AS A        
     INNER JOIN PRODUCAO_ORDEM  (NOLOCK)/*#GS:01.02#*/AS O ON O.ORDEM_PRODUCAO = A.ORDEM_PRODUCAO        
     INNER JOIN PRODUTOS  (NOLOCK)/*#GS:01.02#*/AS P ON P.PRODUTO = A.PRODUTO         
     INNER JOIN PRODUCAO_ORDEM_SERVICO  (NOLOCK)/*#GS:01.02#*/AS B ON A.ORDEM_SERVICO = ISNULL(B.ORDEM_SERVICO_PARALELA,B.ORDEM_SERVICO)/*#14#*/        
     INNER JOIN PRODUCAO_TAREFAS  (NOLOCK)/*#GS:01.02#*/AS C ON C.TAREFA = A.TAREFA_ANTERIOR         
     INNER JOIN ( PRODUCAO_CUSTO_ABSORCAO  (NOLOCK)/*#GS:01.02#*/AS I         
         INNER JOIN PRODUCAO_CUSTO_RECURSO  (NOLOCK)/*#GS:01.02#*/AS J ON J.INDICADOR_ABSORCAO = I.INDICADOR_ABSORCAO         
       ) ON J.RECURSO_PRODUTIVO = C.RECURSO_PRODUTIVO AND         
         I.TIPO_INDICADOR = 3     
   WHERE B.DATA BETWEEN @DATA_INI AND @DATA_FIN AND         
     ISNULL(P.MONTAGEM_KIT, 0) = @SEMI_ACABADO AND         
     ISNULL(O.TIPO_PROCESSO, 0) NOT IN ( 4 )        
     /*#15# - Início*/        
      AND (        
       (         
        @CALCULA_CUSTO_POR_FILIAL=1        
        AND          
        EXISTS (SELECT COD_CUSTO_MEDIO         
          FROM CM_FECHAMENTO_CUSTO_MEDIO_FILIAIS CMF          
          INNER JOIN FILIAIS  (NOLOCK)/*#GS:01.02#*/FI ON CMF.COD_FILIAL = FI.COD_FILIAL        
          WHERE CMF.COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO AND FI.FILIAL = O.FILIAL        
          )         
       )        
        OR         
       (        
        @CALCULA_CUSTO_POR_FILIAL=0        
       )        
      )        
     /*#15# - Fim*/        
     /*#17# - Início*/        
     AND EXISTS (        
         SELECT EMPRESA         
         FROM FILIAIS  (NOLOCK)/*#GS:01.02#*/FI         
         WHERE FI.FILIAL = O.FILIAL AND         
         ( FI.EMPRESA = @EMPRESA OR FI.EMPRESA IS NULL OR @EMPRESA=-1 )         
        )         
     /*#17# - Fim*/        
        
   GROUP BY A.PRODUTO, A.ORDEM_PRODUCAO, A.TAREFA_ANTERIOR, I.INDICADOR_ABSORCAO        
   ,( CASE WHEN @FECHA_COR_PA = 1 THEN A.COR_PRODUTO ELSE '' END ) /*#13#*/        
        
   HAVING SUM(( ISNULL(A.VALOR_CREDITADO, 0) * ( ISNULL(J.PORC_CUSTO_FABRIL, 0) / 100. ) )) <> 0        
           
   -- CUSTO DE ABSORÇÃO POR VALOR MP - INICIO        
   IF EXISTS( SELECT * FROM PRODUCAO_CUSTO_ABSORCAO  (NOLOCK)/*#GS:01.02#*/WHERE TIPO_INDICADOR = 4 )        
   BEGIN        
        
    DECLARE @TEMP_INDICE TABLE ( ORDEM_PRODUCAO CHAR(08) COLLATE DATABASE_DEFAULT,         
            PRODUTO CHAR(12) COLLATE DATABASE_DEFAULT,         
            RECURSO_PRODUTIVO CHAR(05) COLLATE DATABASE_DEFAULT,         
            VALOR_MATERIAIS_OS NUMERIC(15,5),--#20#        
            INDICE NUMERIC(20,19)         
            ,COR_PRODUTO CHAR(10)/*#13#*/)        
        
    INSERT INTO @TEMP_INDICE ( ORDEM_PRODUCAO, PRODUTO, RECURSO_PRODUTIVO, VALOR_MATERIAIS_OS, INDICE ,COR_PRODUTO)        
    SELECT ORDEM_PRODUCAO, PRODUTO, RECURSO_PRODUTIVO, SUM(TOTAL_ABSORCAO_PERIODO), 0 AS INDICE        
      ,COR_PRODUTO /*#13#*/        
    FROM (         
      SELECT C.ORDEM_PRODUCAO, P.PRODUTO, B.RECURSO_PRODUTIVO,         
         CAST(SUM( ( H.QTDE - H.PERDA ) * H.CUSTO ) /         
         ( CASE WHEN @FECHA_COR_PA = 1 THEN 1 ELSE COUNT(DISTINCT C.COR_PRODUTO) END ) AS NUMERIC(14,2) ) AS TOTAL_ABSORCAO_PERIODO /*#13#*/        
         ,( CASE WHEN @FECHA_COR_PA = 1 THEN C.COR_PRODUTO ELSE '' END ) AS COR_PRODUTO /*#13#*/        
      FROM PRODUCAO_ORDEM_SERVICO B   (NOLOCK)/*#GS:01.02#*/      
       INNER JOIN PRODUCAO_RECURSOS  (NOLOCK)/*#GS:01.02#*/PR ON PR.RECURSO_PRODUTIVO = B.RECURSO_PRODUTIVO --#22#        
       INNER JOIN PRODUCAO_OS_ANTERIOR  (NOLOCK)/*#GS:01.02#*/C ON C.ORDEM_SERVICO = ISNULL(B.ORDEM_SERVICO_PARALELA,B.ORDEM_SERVICO)/*#14#*/        
       INNER JOIN PRODUTOS  (NOLOCK)/*#GS:01.02#*/P ON P.PRODUTO = C.PRODUTO        
       INNER JOIN PRODUCAO_ORDEM  (NOLOCK)/*#GS:01.02#*/O ON O.ORDEM_PRODUCAO = C.ORDEM_PRODUCAO        
       INNER JOIN ESTOQUE_SAI_MAT  (NOLOCK)/*#GS:01.02#*/G ON G.ORDEM_SERVICO = B.ORDEM_SERVICO        
       INNER JOIN ESTOQUE_SAI1_MAT  (NOLOCK)/*#GS:01.02#*/H ON H.REQ_MATERIAL = G.REQ_MATERIAL AND         
                H.FILIAL = G.FILIAL AND         
                H.ORDEM_PRODUCAO = C.ORDEM_PRODUCAO        
       LEFT JOIN ( PRODUCAO_CUSTO_ABSORCAO  (NOLOCK)/*#GS:01.02#*/I         
          INNER JOIN PRODUCAO_CUSTO_RECURSO  (NOLOCK)/*#GS:01.02#*/J ON J.INDICADOR_ABSORCAO = I.INDICADOR_ABSORCAO         
           ) ON J.RECURSO_PRODUTIVO = B.RECURSO_PRODUTIVO AND         
             I.TIPO_INDICADOR = 1        
      WHERE B.DATA BETWEEN @DATA_INI AND @DATA_FIN AND         
        B.INDICADOR_TIPO_MOV IN ( 1, 3 ) AND         
        ISNULL(P.MONTAGEM_KIT,0) = @SEMI_ACABADO AND         
        ISNULL(O.TIPO_PROCESSO, 0) NOT IN ( 4 )        
        /*#15# - Início*/        
         AND (        
          (         
           @CALCULA_CUSTO_POR_FILIAL=1        
           AND          
           EXISTS (SELECT COD_CUSTO_MEDIO         
             FROM CM_FECHAMENTO_CUSTO_MEDIO_FILIAIS CMF          
             INNER JOIN FILIAIS  (NOLOCK)/*#GS:01.02#*/FI ON CMF.COD_FILIAL = FI.COD_FILIAL        
             WHERE CMF.COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO AND FI.FILIAL = O.FILIAL        
            )         
          )        
           OR         
          (        
           @CALCULA_CUSTO_POR_FILIAL=0        
          )        
         )        
        /*#15# - Fim*/        
        /*#17# - Início*/        
        AND EXISTS (        
            SELECT EMPRESA         
            FROM FILIAIS  (NOLOCK)/*#GS:01.02#*/FI         
            WHERE FI.FILIAL = O.FILIAL AND         
            ( FI.EMPRESA = @EMPRESA OR FI.EMPRESA IS NULL OR @EMPRESA=-1 )         
           )         
        /*#17# - Fim*/        
                
                
        /*#22# - Início*/        
        AND ((G.NF_PENDENTE = 0 AND PR.RECURSO_PROPRIO = 1) OR (G.NF_PENDENTE = 1 AND PR.RECURSO_PROPRIO = 0 ))        
        /*#22# - Fim*/        
        
      GROUP BY C.ORDEM_PRODUCAO, P.PRODUTO, B.RECURSO_PRODUTIVO        
      ,( CASE WHEN @FECHA_COR_PA = 1 THEN C.COR_PRODUTO ELSE '' END ) /*#13#*/        
        /*-----------------------------------------------------------------*/        
        UNION ALL        
        /*-----------------------------------------------------------------*/        
        SELECT A.ORDEM_PRODUCAO, A.PRODUTO, B.RECURSO_PRODUTIVO,         
         SUM(( CASE WHEN B.INDICADOR_TIPO_MOV IN ( 1, 3 ) 
                  THEN ( CASE WHEN IMPOSTOS_VALORES.NF_ENTRADA IS NULL         
                            THEN ( ISNULL(A.VALOR_CREDITADO, 0) * ( CASE WHEN DBO.FX_PARAMETRO('ABATE_IMPOSTO_NF_OS') = '.F.'         
                                                                       THEN IMPOSTOS.TAXA        
                                                                       ELSE 1.0000        
                                                                    END ) )        
                            ELSE ( ISNULL(A.VALOR_CREDITADO, 0) - ( IMPOSTOS_VALORES.VALOR_IMPOSTO * A.QTDE_A ) )                                 END )        
                  ELSE 0         
                  END )) AS TOTAL_ABSORCAO_PERIODO         
         ,( CASE WHEN @FECHA_COR_PA = 1 THEN A.COR_PRODUTO ELSE '' END ) AS COR_PRODUTO /*#13#*/        
        FROM PRODUCAO_OS_ANTERIOR  (NOLOCK)/*#GS:01.02#*/AS A        
       INNER JOIN PRODUCAO_ORDEM  (NOLOCK)/*#GS:01.02#*/AS O ON O.ORDEM_PRODUCAO = A.ORDEM_PRODUCAO        
       INNER JOIN PRODUTOS  (NOLOCK)/*#GS:01.02#*/AS P ON P.PRODUTO = A.PRODUTO        
       INNER JOIN PRODUCAO_ORDEM_SERVICO  (NOLOCK)/*#GS:01.02#*/AS B ON A.ORDEM_SERVICO =ISNULL(B.ORDEM_SERVICO_PARALELA,B.ORDEM_SERVICO)/*#14#*/        
             INNER JOIN ENTRADAS  (NOLOCK)/*#GS:01.02#*/AS ENT ON B.NF_ENTRADA = ENT.NF_ENTRADA AND         
                                           B.SERIE_NF_ENTRADA = ENT.SERIE_NF_ENTRADA AND         
                                           B.BENEFICIADOR_TAREFA_ANTERIOR = ENT.NOME_CLIFOR        
             LEFT JOIN ( SELECT IMPOSTOS_TAXA.NF_ENTRADA, IMPOSTOS_TAXA.SERIE_NF_ENTRADA, IMPOSTOS_TAXA.NOME_CLIFOR,         
                                MAX(IMPOSTOS_TAXA.TAXA) AS TAXA        
                         FROM ( SELECT IMP.NF_ENTRADA, IMP.SERIE_NF_ENTRADA, IMP.NOME_CLIFOR, IMP.ITEM_IMPRESSAO,         
                                       IMP.SUB_ITEM_TAMANHO, ( ( 100.00000 - SUM(TAXA_IMPOSTO_ESPELHO) ) / 100.00000 ) AS TAXA        
                                FROM ENTRADAS_IMPOSTO  (NOLOCK)/*#GS:01.02#*/AS IMP        
                                     INNER JOIN ENTRADAS_ITEM  (NOLOCK)/*#GS:01.02#*/AS ITEM ON IMP.NF_ENTRADA = ITEM.NF_ENTRADA AND        
                                                                         IMP.SERIE_NF_ENTRADA = ITEM.SERIE_NF_ENTRADA AND        
                                                                         IMP.NOME_CLIFOR = ITEM.NOME_CLIFOR AND        
                                                                         IMP.ITEM_IMPRESSAO = ITEM.ITEM_IMPRESSAO AND        
                                                                         IMP.SUB_ITEM_TAMANHO = ITEM.SUB_ITEM_TAMANHO AND        
                                                                         ITEM.COD_TABELA_FILHA = 'O'        
                                WHERE IMP.TAXA_IMPOSTO_ESPELHO > 0        
                                GROUP BY IMP.NF_ENTRADA, IMP.SERIE_NF_ENTRADA, IMP.NOME_CLIFOR, IMP.ITEM_IMPRESSAO,         
                                    IMP.SUB_ITEM_TAMANHO        
                              ) AS IMPOSTOS_TAXA        
                         GROUP BY IMPOSTOS_TAXA.NF_ENTRADA, IMPOSTOS_TAXA.SERIE_NF_ENTRADA, IMPOSTOS_TAXA.NOME_CLIFOR        
                       ) AS IMPOSTOS ON B.NF_ENTRADA = IMPOSTOS.NF_ENTRADA AND         
                                        B.SERIE_NF_ENTRADA = IMPOSTOS.SERIE_NF_ENTRADA AND         
                                        B.BENEFICIADOR_TAREFA_ANTERIOR = IMPOSTOS.NOME_CLIFOR        
             LEFT JOIN ( SELECT IMP.NF_ENTRADA, IMP.SERIE_NF_ENTRADA, IMP.NOME_CLIFOR,         
              SUM( CASE WHEN  ISNULL(OS.QTDE_O,0) = 0 THEN 0 ELSE ( IMP.VALOR_IMPOSTO_ESPELHO / OS.QTDE_O ) END ) AS VALOR_IMPOSTO /*#11#*/        
                         FROM ENTRADAS_IMPOSTO  (NOLOCK)/*#GS:01.02#*/AS IMP        
               INNER JOIN ENTRADAS_ITEM  (NOLOCK)/*#GS:01.02#*/AS ITEM ON IMP.NF_ENTRADA = ITEM.NF_ENTRADA AND        
                                                                  IMP.SERIE_NF_ENTRADA = ITEM.SERIE_NF_ENTRADA AND        
                                                                  IMP.NOME_CLIFOR = ITEM.NOME_CLIFOR AND        
                                                                  IMP.ITEM_IMPRESSAO = ITEM.ITEM_IMPRESSAO AND        
                                                                  IMP.SUB_ITEM_TAMANHO = ITEM.SUB_ITEM_TAMANHO AND        
                                                                  ITEM.COD_TABELA_FILHA IN ( 'A', 'C' )        
        
           /*#11# - INICIO*/        
             LEFT JOIN (SELECT A.NF_ENTRADA,A.SERIE_NF_ENTRADA,SUM(B.QTDE_O) AS QTDE_O        
               FROM PRODUCAO_ORDEM_SERVICO  (NOLOCK)/*#GS:01.02#*/A       
               INNER JOIN PRODUCAO_OS_TAREFAS  (NOLOCK)/*#GS:01.02#*/B ON A.ORDEM_SERVICO = B.ORDEM_SERVICO        
               GROUP BY A.NF_ENTRADA,A.SERIE_NF_ENTRADA        
               ) AS OS  ON ITEM.NF_ENTRADA = OS.NF_ENTRADA AND ITEM.SERIE_NF_ENTRADA = OS.SERIE_NF_ENTRADA        
           /*#11# - FIM*/        
        
                         GROUP BY IMP.NF_ENTRADA, IMP.SERIE_NF_ENTRADA, IMP.NOME_CLIFOR        
                       ) AS IMPOSTOS_VALORES ON B.NF_ENTRADA = IMPOSTOS_VALORES.NF_ENTRADA AND         
                                                B.SERIE_NF_ENTRADA = IMPOSTOS_VALORES.SERIE_NF_ENTRADA AND         
                                                B.BENEFICIADOR_TAREFA_ANTERIOR = IMPOSTOS_VALORES.NOME_CLIFOR          
       INNER JOIN PRODUCAO_TAREFAS  (NOLOCK)/*#GS:01.02#*/AS C ON C.TAREFA = A.TAREFA_ANTERIOR        
       LEFT JOIN ( PRODUCAO_CUSTO_ABSORCAO  (NOLOCK)/*#GS:01.02#*/AS I         
          INNER JOIN PRODUCAO_CUSTO_RECURSO  (NOLOCK)/*#GS:01.02#*/AS J ON J.INDICADOR_ABSORCAO = I.INDICADOR_ABSORCAO        
           ) ON J.RECURSO_PRODUTIVO = C.RECURSO_PRODUTIVO AND         
             I.TIPO_INDICADOR = 2        
        WHERE /* B.DATA BETWEEN @DATA_INI AND @DATA_FIN AND #12#*/        
        ent.RECEBIMENTO BETWEEN @DATA_INI AND @DATA_FIN AND /*#12#*/        
        ISNULL(P.MONTAGEM_KIT, 0) = @SEMI_ACABADO AND         
        ISNULL(O.TIPO_PROCESSO, 0) NOT IN ( 4 )        
        /*#15# - Início*/        
         AND (        
          (         
           @CALCULA_CUSTO_POR_FILIAL=1        
           AND          
           EXISTS (SELECT COD_CUSTO_MEDIO         
             FROM CM_FECHAMENTO_CUSTO_MEDIO_FILIAIS CMF          
             INNER JOIN FILIAIS  (NOLOCK)/*#GS:01.02#*/FI ON CMF.COD_FILIAL = FI.COD_FILIAL        
             WHERE CMF.COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO AND FI.FILIAL = O.FILIAL        
             )         
          )        
           OR         
          (        
           @CALCULA_CUSTO_POR_FILIAL=0        
          )        
         )        
        /*#15# - Fim*/        
        /*#17# - Início*/        
        AND EXISTS (        
            SELECT EMPRESA         
            FROM FILIAIS  (NOLOCK)/*#GS:01.02#*/FI         
            WHERE FI.FILIAL = O.FILIAL AND         
            ( FI.EMPRESA = @EMPRESA OR FI.EMPRESA IS NULL OR @EMPRESA=-1 )         
           )         
        /*#17# - Fim*/        
        
        GROUP BY A.ORDEM_PRODUCAO, A.PRODUTO, B.RECURSO_PRODUTIVO        
        ,( CASE WHEN @FECHA_COR_PA = 1 THEN A.COR_PRODUTO ELSE '' END )  /*#13#*/        
        
        
        
      ) AS VALORES_MP_OS        
    GROUP BY ORDEM_PRODUCAO, PRODUTO, RECURSO_PRODUTIVO        
      ,COR_PRODUTO   /*#13#*/        
        
    UPDATE TEMP_INDICE        
    SET INDICE = ( CASE WHEN ABSORCAO.SUM_ABSORCAO = 0         
          THEN 0         
          ELSE ( CAST(ABSORCAO.SUM_ABSORCAO AS NUMERIC(14,2)) / CAST(VALORES.SUM_VALOR AS NUMERIC(14,5)) )         
          END )        
    FROM @TEMP_INDICE AS TEMP_INDICE        
      INNER JOIN ( SELECT A.RECURSO_PRODUTIVO, SUM(A.VALOR_MATERIAIS_OS) AS SUM_VALOR        
          FROM @TEMP_INDICE AS A        
          GROUP BY A.RECURSO_PRODUTIVO         
        ) AS VALORES ON TEMP_INDICE.RECURSO_PRODUTIVO = VALORES.RECURSO_PRODUTIVO        
      INNER JOIN ( SELECT A.RECURSO_PRODUTIVO, SUM(A.TOTAL_ABSORCAO_PERIODO) AS SUM_ABSORCAO        
          FROM CM_PRODUCAO_RECURSO (NOLOCK)/*#GS:01.02#*/AS A        
            INNER JOIN PRODUCAO_CUSTO_ABSORCAO (NOLOCK)/*#GS:01.02#*/AS B ON A.INDICADOR_ABSORCAO = B.INDICADOR_ABSORCAO         
          WHERE B.TIPO_INDICADOR = 4 AND        
          A.COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO         
          GROUP BY A.RECURSO_PRODUTIVO        
        ) AS ABSORCAO ON TEMP_INDICE.RECURSO_PRODUTIVO = ABSORCAO.RECURSO_PRODUTIVO        
        
    DECLARE @TEMP_VALOR_MP TABLE ( ORDEM_PRODUCAO CHAR(08) COLLATE DATABASE_DEFAULT,         
              PRODUTO CHAR(12) COLLATE DATABASE_DEFAULT,         
              VALOR_ABSORCAO NUMERIC(14,5),--#20#        
              QTDE_TOTAL NUMERIC(10,3),         
              COR_PRODUTO CHAR(10)/*#13#*/        
              )        
        
    INSERT INTO @TEMP_VALOR_MP ( ORDEM_PRODUCAO, PRODUTO, VALOR_ABSORCAO, QTDE_TOTAL ,COR_PRODUTO)        
    SELECT A.ORDEM_PRODUCAO, A.PRODUTO, 0, AVG(A.TOTAL_QTDE_PERIODO)        
      ,( CASE WHEN @FECHA_COR_PA = 1 THEN A.COR_PRODUTO ELSE '' END ) AS COR_PRODUTO /*#13#*/        
    FROM CM_PRODUCAO_PA_ABSORCAO (NOLOCK)/*#GS:01.02#*/AS A        
      INNER JOIN PRODUCAO_CUSTO_ABSORCAO (NOLOCK)/*#GS:01.02#*/AS B ON A.INDICADOR_ABSORCAO = B.INDICADOR_ABSORCAO        
    WHERE A.COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO AND        
       B.TIPO_INDICADOR IN ( 1, 2 )        
    GROUP BY A.ORDEM_PRODUCAO, A.PRODUTO        
       ,( CASE WHEN @FECHA_COR_PA = 1 THEN A.COR_PRODUTO ELSE '' END )  /*#13#*/        
        
        
        
    INSERT INTO CM_PRODUCAO_PA_ABSORCAO ( COD_CUSTO_MEDIO, PRODUTO, COR_PRODUTO, ORDEM_PRODUCAO, TAREFA, INDICADOR_ABSORCAO,         
               TOTAL_QTDE_PERIODO, TOTAL_QTDE_ACUMULADA, TOTAL_MINUTOS_PERIODO, TOTAL_ABSORCAO_ACUMULADO,         
               TOTAL_ABSORCAO_PERIODO )        
    SELECT @COD_CUSTO_MEDIO,         
        A.PRODUTO,         
        ( CASE WHEN @FECHA_COR_PA = 1 THEN A.COR_PRODUTO ELSE '' END ) AS COR_PRODUTO /*#13#*/,         
        A.ORDEM_PRODUCAO,        
        '' AS TAREFA,         
        I.INDICADOR_ABSORCAO,         
        A.QTDE_TOTAL AS TOTAL_QTDE_PERIODO,         
        A.QTDE_TOTAL AS TOTAL_QTDE_ACUMULADA,         
        0 AS TOTAL_MINUTOS_PERIODO,         
        0 AS TOTAL_ABSORCAO_ACUMULADO,         
        C.VALOR_ABSORCAO AS TOTAL_ABSORCAO_PERIODO         
    FROM @TEMP_VALOR_MP AS A        
      INNER JOIN ( SELECT ORDEM_PRODUCAO, PRODUTO, SUM(ROUND(( VALOR_MATERIAIS_OS * INDICE ), 5)) AS VALOR_ABSORCAO --#20#        
          ,COR_PRODUTO /*#13#*/        
          FROM @TEMP_INDICE         
          GROUP BY ORDEM_PRODUCAO, PRODUTO        
          ,COR_PRODUTO /*13*/        
          HAVING SUM(ROUND(( VALOR_MATERIAIS_OS * INDICE ), 5)) > 0 --#20#        
        ) AS C ON A.ORDEM_PRODUCAO = C.ORDEM_PRODUCAO AND        
            A.PRODUTO = C.PRODUTO         
            AND A.COR_PRODUTO = C.COR_PRODUTO /*#13#*/        
      CROSS JOIN ( SELECT TOP 1 INDICADOR_ABSORCAO        
          FROM PRODUCAO_CUSTO_ABSORCAO (NOLOCK)/*#GS:01.02#*/       
          WHERE TIPO_INDICADOR = 4         
        ) AS I        
                
   END        
         
      -- CUSTO DE ABSORÇÃO POR VALOR MP - FINAL        
 
   /*-- PROPORCIONALIZAÇÃO DA ABSORÇÃO DE PRODUÇÃO -- INICIO --*/        
   DECLARE @ABSORCAO_TEMP TABLE ( COD_CUSTO_MEDIO CHAR(08),         
             INDICADOR_ABSORCAO CHAR(08) COLLATE DATABASE_DEFAULT,         
             CRITERIO_ABSORCAO SMALLINT,         
             PRODUTO CHAR(12) COLLATE DATABASE_DEFAULT,         
             COR_PRODUTO CHAR(10) COLLATE DATABASE_DEFAULT,         
             ORDEM_PRODUCAO CHAR(08) COLLATE DATABASE_DEFAULT,         
             TAREFA CHAR(10) COLLATE DATABASE_DEFAULT,         
             RECURSO_PRODUTIVO CHAR(05) COLLATE DATABASE_DEFAULT,         
             TOTAL_MINUTOS_PERIODO INT,        
             TOTAL_QTDE_PERIODO NUMERIC(10,3),        
             TOTAL_ABSORCAO_PERIODO NUMERIC(14,2),        
             PORCENTAGEM_RATEIO NUMERIC(17,16) )        

 IF ISNULL(@SEMI_ACABADO,0) = 0 --#CSM004# para nao duplicar chave ao passar varias vezes.
 BEGIN 
        
   INSERT INTO @ABSORCAO_TEMP ( COD_CUSTO_MEDIO, INDICADOR_ABSORCAO, CRITERIO_ABSORCAO, PRODUTO, COR_PRODUTO, ORDEM_PRODUCAO, TAREFA,         
                                RECURSO_PRODUTIVO, TOTAL_MINUTOS_PERIODO, TOTAL_QTDE_PERIODO, TOTAL_ABSORCAO_PERIODO, PORCENTAGEM_RATEIO )        
   SELECT @COD_CUSTO_MEDIO, A.INDICADOR_ABSORCAO, A.CRITERIO_ABSORCAO, C.PRODUTO, /*C.COR_PRODUTO*/
   ( CASE WHEN @FECHA_COR_PA = 1 THEN C.COR_PRODUTO ELSE '' END ) AS COR_PRODUTO /*#13#*/, C.ORDEM_PRODUCAO,         
                   
          CASE WHEN @CM_ABSORVE_FIM_TAREFA = '.F.' THEN C.TAREFA ELSE D.TAREFA END,--#26#        
          A.RECURSO_PRODUTIVO,         
       SUM(( CASE WHEN A.CRITERIO_ABSORCAO <> 0         
       THEN CAST(( ISNULL(D.TEMPO_CRONOM_FIXO, 0) + ( ISNULL(D.TEMPO_CRONOMETRADO, 0) * ISNULL(C.QTDE_A, 0) ) ) AS INT)        
       ELSE 0        
       END )) AS TOTAL_MINUTOS_PERIODO,         
       /*-- INDEPENTENDE SE FOR POR TEMPO, PRECISO DA QTDE PARA VALORIZAR CORRETAMENTE O QUE FOI FINALIZADO. --*/        
       SUM(( /*CASE WHEN A.CRITERIO_ABSORCAO = 0         
       THEN*/ C.QTDE_A        
       /*ELSE 0        
       END*/ )) AS TOTAL_QTDE_PERIODO,         
       CAST(0 AS NUMERIC(14,2)) AS TOTAL_ABSORCAO_PERIODO, CAST(0 AS NUMERIC(17,16)) AS PORCENTAGEM_RATEIO        
 --#26# inicio da rotina que foi substituidda pelo comentátio da #26#        
  /* FROM CM_PRODUCAO_RECURSO AS A        
     INNER JOIN PRODUCAO_ORDEM_SERVICO AS B ON ( CASE WHEN A.RECURSO_PRODUTIVO = ''         
                THEN ''         
                ELSE B.RECURSO_PRODUTIVO         
                END )= A.RECURSO_PRODUTIVO AND         
                 B.DATA BETWEEN @DATA_INI AND @DATA_FIN        
     INNER JOIN PRODUCAO_OS_ANTERIOR AS C ON B.ORDEM_SERVICO = C.ORDEM_SERVICO        
     INNER JOIN PRODUCAO_ORDEM AS O ON C.ORDEM_PRODUCAO = O.ORDEM_PRODUCAO        
     INNER JOIN PRODUTOS AS P ON O.PRODUTO = P.PRODUTO        
     INNER JOIN PRODUCAO_TAREFAS AS D ON C.TAREFA = D.TAREFA        
     INNER JOIN PRODUCAO_CUSTO_ABSORCAO AS F ON F.INDICADOR_ABSORCAO = A.INDICADOR_ABSORCAO        
     LEFT JOIN PRODUCAO_RECURSOS AS E ON A.RECURSO_PRODUTIVO = E.RECURSO_PRODUTIVO         
     LEFT JOIN CM_PRODUCAO_PA_ABSORCAO AS X ON A.COD_CUSTO_MEDIO = X.COD_CUSTO_MEDIO AND         
                 C.PRODUTO = X.PRODUTO AND         
                 C.COR_PRODUTO = X.COR_PRODUTO AND         
                 C.ORDEM_PRODUCAO = X.ORDEM_PRODUCAO AND         
                 D.TAREFA = X.TAREFA AND         
                 A.INDICADOR_ABSORCAO = X.INDICADOR_ABSORCAO*/         
    -- #26# final        
 --#26# inicio da rotina         
   FROM PRODUCAO_ORDEM_SERVICO OS  (NOLOCK)/*#GS:01.02#*/      
        INNER JOIN PRODUCAO_OS_ANTERIOR (NOLOCK)/*#GS:01.02#*/AS C ON OS.ORDEM_SERVICO = C.ORDEM_SERVICO        
     inner join PRODUCAO_TAREFAS (NOLOCK)/*#GS:01.02#*/AS D  on  C.TAREFA_anterior = D.TAREFA           
        INNER JOIN CM_PRODUCAO_RECURSO (NOLOCK)/*#GS:01.02#*/AS A ON        
              ( CASE WHEN A.RECURSO_PRODUTIVO = ''         
                THEN ''         
                ELSE D.RECURSO_PRODUTIVO         
                END )= A.RECURSO_PRODUTIVO        
                       
	  INNER JOIN PRODUCAO_ORDEM (NOLOCK)/*#GS:01.02#*/AS O ON C.ORDEM_PRODUCAO = O.ORDEM_PRODUCAO        
     INNER JOIN PRODUTOS (NOLOCK)/*#GS:01.02#*/AS P ON O.PRODUTO = P.PRODUTO        
        
     INNER JOIN PRODUCAO_CUSTO_ABSORCAO (NOLOCK)/*#GS:01.02#*/AS F ON F.INDICADOR_ABSORCAO = A.INDICADOR_ABSORCAO        
     LEFT JOIN PRODUCAO_RECURSOS (NOLOCK)/*#GS:01.02#*/AS E ON A.RECURSO_PRODUTIVO = E.RECURSO_PRODUTIVO         
     LEFT JOIN CM_PRODUCAO_PA_ABSORCAO AS X ON A.COD_CUSTO_MEDIO = X.COD_CUSTO_MEDIO AND         
                 C.PRODUTO = X.PRODUTO AND         
                 C.COR_PRODUTO = X.COR_PRODUTO AND         
                 C.ORDEM_PRODUCAO = X.ORDEM_PRODUCAO AND         
                 D.TAREFA = X.TAREFA AND         
                 A.INDICADOR_ABSORCAO = X.INDICADOR_ABSORCAO        
 --#26 final da rotina         
                        
   WHERE A.COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO AND         
         OS.DATA BETWEEN @DATA_INI AND @DATA_FIN AND   --#26# colocação da escolha da data da Ordem de servico no where        
          F.TIPO_INDICADOR = 0 AND         
      X.PRODUTO IS NULL AND         
      ISNULL(O.TIPO_PROCESSO, 0) NOT IN ( 4 )        
   GROUP BY A.INDICADOR_ABSORCAO, A.CRITERIO_ABSORCAO, C.PRODUTO, /*C.COR_PRODUTO,*/ ( CASE WHEN @FECHA_COR_PA = 1 THEN C.COR_PRODUTO ELSE '' END ) ,C.ORDEM_PRODUCAO,         
    CASE WHEN @CM_ABSORVE_FIM_TAREFA = '.F.' THEN C.TAREFA ELSE D.TAREFA END, --#26#         
    A.RECURSO_PRODUTIVO        
 END --#CSM004# FIM  

   UPDATE A        
   SET PORCENTAGEM_RATEIO = ( CASE A.CRITERIO_ABSORCAO         
            WHEN 0 THEN ( CASE WHEN B.TOTAL_QTDE_PERIODO = 0        
                 THEN 0        
                 ELSE ( 1. * A.TOTAL_QTDE_PERIODO / B.TOTAL_QTDE_PERIODO )        
              END ) /* TOTALIDADE DAS QUANTIDADES */        
            WHEN 1 THEN ( CASE WHEN B.TOTAL_MINUTOS_PERIODO = 0 AND ISNULL(E.RECURSO_PROPRIO, 1) = 0         
                 THEN 0        
                 ELSE ( 1. * A.TOTAL_MINUTOS_PERIODO / B.TOTAL_MINUTOS_PERIODO )        
              END ) /* SOMENTE TEMPOS INTERNOS */        
            WHEN 2 THEN ( CASE WHEN B.TOTAL_MINUTOS_PERIODO = 0 AND ISNULL(E.RECURSO_PROPRIO, 1) = 1         
                 THEN 0        
                 ELSE ( 1. * A.TOTAL_MINUTOS_PERIODO / B.TOTAL_MINUTOS_PERIODO )        
              END ) /* SOMENTE TEMPOS EXTERNOS */        
            ELSE ( CASE WHEN B.TOTAL_MINUTOS_PERIODO = 0        
             THEN 0        
             ELSE ( 1. * A.TOTAL_MINUTOS_PERIODO / B.TOTAL_MINUTOS_PERIODO )        
             END )        
            END )        
   FROM @ABSORCAO_TEMP AS A        
     LEFT JOIN PRODUCAO_RECURSOS (NOLOCK)/*#GS:01.02#*/AS E ON A.RECURSO_PRODUTIVO = E.RECURSO_PRODUTIVO        
 /*    INNER JOIN ( SELECT INDICADOR_ABSORCAO, CRITERIO_ABSORCAO, RECURSO_PRODUTIVO, SUM(TOTAL_MINUTOS_PERIODO) AS TOTAL_MINUTOS_PERIODO,         
          SUM(TOTAL_QTDE_PERIODO) AS TOTAL_QTDE_PERIODO        
         FROM CM_PRODUCAO_RECURSO        
         WHERE COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO        
         GROUP BY INDICADOR_ABSORCAO, CRITERIO_ABSORCAO, RECURSO_PRODUTIVO        
       ) AS B ON A.INDICADOR_ABSORCAO = B.INDICADOR_ABSORCAO AND        
           A.CRITERIO_ABSORCAO = B.CRITERIO_ABSORCAO AND        
           A.RECURSO_PRODUTIVO = B.RECURSO_PRODUTIVO*/        
                   
                   
     INNER JOIN ( SELECT INDICADOR_ABSORCAO, CRITERIO_ABSORCAO, RECURSO_PRODUTIVO, SUM(TOTAL_MINUTOS_PERIODO) AS TOTAL_MINUTOS_PERIODO,         
       SUM(TOTAL_QTDE_PERIODO) AS TOTAL_QTDE_PERIODO        
      FROM @ABSORCAO_TEMP        
      WHERE COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO        
      GROUP BY INDICADOR_ABSORCAO, CRITERIO_ABSORCAO, RECURSO_PRODUTIVO        
        ) AS B ON A.INDICADOR_ABSORCAO = B.INDICADOR_ABSORCAO AND        
        A.CRITERIO_ABSORCAO = B.CRITERIO_ABSORCAO AND        
        A.RECURSO_PRODUTIVO = B.RECURSO_PRODUTIVO               
        
        
   DELETE FROM @ABSORCAO_TEMP         
   WHERE TOTAL_MINUTOS_PERIODO = 0 AND        
      TOTAL_QTDE_PERIODO = 0        
        
   DECLARE @INDICADOR_ABSORCAO AS CHAR(08), @CRITERIO_ABSORCAO AS SMALLINT, @RECURSO_PRODUTIVO AS CHAR(05), @DIFERENCA AS NUMERIC(17,16)        
        
   DECLARE CUR_DIFERENCAS CURSOR FAST_FORWARD FOR        
   SELECT A.INDICADOR_ABSORCAO, A.CRITERIO_ABSORCAO, A.RECURSO_PRODUTIVO, ( 1 - SUM(A.PORCENTAGEM_RATEIO) ) AS DIFERENCA        
   FROM @ABSORCAO_TEMP AS A        
   GROUP BY A.INDICADOR_ABSORCAO, A.CRITERIO_ABSORCAO, A.RECURSO_PRODUTIVO        
   HAVING ( 1 - SUM(A.PORCENTAGEM_RATEIO) ) <> 0        
           
   OPEN CUR_DIFERENCAS        
           
   FETCH NEXT FROM CUR_DIFERENCAS INTO @INDICADOR_ABSORCAO, @CRITERIO_ABSORCAO, @RECURSO_PRODUTIVO, @DIFERENCA        
           
   WHILE @@FETCH_STATUS = 0        
   BEGIN        
        
    UPDATE A        
    SET PORCENTAGEM_RATEIO = ( PORCENTAGEM_RATEIO + @DIFERENCA )        
    FROM @ABSORCAO_TEMP AS A        
      INNER JOIN ( SELECT TOP 1 B.INDICADOR_ABSORCAO, B.CRITERIO_ABSORCAO, B.PRODUTO, B.COR_PRODUTO, B.ORDEM_PRODUCAO, B.TAREFA,         
              B.RECURSO_PRODUTIVO        
          FROM @ABSORCAO_TEMP AS B        
          WHERE B.INDICADOR_ABSORCAO = @INDICADOR_ABSORCAO AND        
          B.CRITERIO_ABSORCAO = @CRITERIO_ABSORCAO AND        
          B.RECURSO_PRODUTIVO = @RECURSO_PRODUTIVO AND        
          ( PORCENTAGEM_RATEIO + @DIFERENCA ) > 0        
        ) AS B ON A.INDICADOR_ABSORCAO = B.INDICADOR_ABSORCAO AND        
            A.CRITERIO_ABSORCAO = B.CRITERIO_ABSORCAO AND        
            A.PRODUTO = B.PRODUTO AND        
            A.COR_PRODUTO = B.COR_PRODUTO AND        
            A.ORDEM_PRODUCAO = B.ORDEM_PRODUCAO AND   
            A.TAREFA = B.TAREFA AND        
            A.RECURSO_PRODUTIVO = B.RECURSO_PRODUTIVO        
        
    FETCH NEXT FROM CUR_DIFERENCAS INTO @INDICADOR_ABSORCAO, @CRITERIO_ABSORCAO, @RECURSO_PRODUTIVO, @DIFERENCA        
        
   END        
        
   CLOSE CUR_DIFERENCAS        
   DEALLOCATE CUR_DIFERENCAS        
        
   UPDATE A        
   SET TOTAL_ABSORCAO_PERIODO = ROUND(( B.TOTAL_ABSORCAO_PERIODO * A.PORCENTAGEM_RATEIO ), 5)--#20#        
   FROM @ABSORCAO_TEMP AS A        
     INNER JOIN CM_PRODUCAO_RECURSO AS B ON B.COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO AND        
              A.INDICADOR_ABSORCAO = B.INDICADOR_ABSORCAO AND        
              A.CRITERIO_ABSORCAO = B.CRITERIO_ABSORCAO AND        
              A.RECURSO_PRODUTIVO = B.RECURSO_PRODUTIVO        
        
   DECLARE @DIFERENCA2 AS NUMERIC(14,2)        
        
   DECLARE CUR_DIFERENCAS CURSOR FAST_FORWARD FOR        
   SELECT A.INDICADOR_ABSORCAO, A.CRITERIO_ABSORCAO, A.RECURSO_PRODUTIVO,         
          ( B.TOTAL_ABSORCAO_PERIODO - A.TOTAL_ABSORCAO_PERIODO ) AS DIFERENCA        
   FROM ( SELECT A.COD_CUSTO_MEDIO, A.INDICADOR_ABSORCAO, A.CRITERIO_ABSORCAO, A.RECURSO_PRODUTIVO,         
                 SUM(A.TOTAL_ABSORCAO_PERIODO) AS TOTAL_ABSORCAO_PERIODO        
       FROM @ABSORCAO_TEMP AS A        
       GROUP BY A.COD_CUSTO_MEDIO, A.INDICADOR_ABSORCAO, A.CRITERIO_ABSORCAO, A.RECURSO_PRODUTIVO        
     ) AS A        
     INNER JOIN CM_PRODUCAO_RECURSO (NOLOCK)/*#GS:01.02#*/AS B ON A.COD_CUSTO_MEDIO = B.COD_CUSTO_MEDIO AND        
                                            A.INDICADOR_ABSORCAO = B.INDICADOR_ABSORCAO AND        
              A.CRITERIO_ABSORCAO = B.CRITERIO_ABSORCAO AND        
              A.RECURSO_PRODUTIVO = B.RECURSO_PRODUTIVO        
   WHERE ( B.TOTAL_ABSORCAO_PERIODO - A.TOTAL_ABSORCAO_PERIODO ) <> 0        
        
   OPEN CUR_DIFERENCAS        
       
   FETCH NEXT FROM CUR_DIFERENCAS INTO @INDICADOR_ABSORCAO, @CRITERIO_ABSORCAO, @RECURSO_PRODUTIVO, @DIFERENCA2        
           
   WHILE @@FETCH_STATUS = 0        
   BEGIN        
        
    UPDATE A        
    SET TOTAL_ABSORCAO_PERIODO = ( TOTAL_ABSORCAO_PERIODO + @DIFERENCA2 )        
    FROM @ABSORCAO_TEMP AS A        
      INNER JOIN ( SELECT TOP 1 B.INDICADOR_ABSORCAO, B.CRITERIO_ABSORCAO, B.PRODUTO, B.COR_PRODUTO, B.ORDEM_PRODUCAO, B.TAREFA,         
              B.RECURSO_PRODUTIVO        
          FROM @ABSORCAO_TEMP AS B        
          WHERE B.INDICADOR_ABSORCAO = @INDICADOR_ABSORCAO AND        
          B.CRITERIO_ABSORCAO = @CRITERIO_ABSORCAO AND        
          B.RECURSO_PRODUTIVO = @RECURSO_PRODUTIVO AND        
          ( TOTAL_ABSORCAO_PERIODO + @DIFERENCA2 ) > 0        
        ) AS B ON A.INDICADOR_ABSORCAO = B.INDICADOR_ABSORCAO AND        
            A.CRITERIO_ABSORCAO = B.CRITERIO_ABSORCAO AND        
            A.PRODUTO = B.PRODUTO AND        
            A.COR_PRODUTO = B.COR_PRODUTO AND        
            A.ORDEM_PRODUCAO = B.ORDEM_PRODUCAO AND        
            A.TAREFA = B.TAREFA AND        
            A.RECURSO_PRODUTIVO = B.RECURSO_PRODUTIVO        
        
    FETCH NEXT FROM CUR_DIFERENCAS INTO @INDICADOR_ABSORCAO, @CRITERIO_ABSORCAO, @RECURSO_PRODUTIVO, @DIFERENCA2        
        
   END        
           
   CLOSE CUR_DIFERENCAS        
   DEALLOCATE CUR_DIFERENCAS        
           
   INSERT INTO CM_PRODUCAO_PA_ABSORCAO ( COD_CUSTO_MEDIO, PRODUTO, COR_PRODUTO, ORDEM_PRODUCAO, TAREFA, INDICADOR_ABSORCAO,         
                                         TOTAL_QTDE_PERIODO, TOTAL_QTDE_ACUMULADA, TOTAL_MINUTOS_PERIODO, TOTAL_ABSORCAO_ACUMULADO,         
                                         TOTAL_ABSORCAO_PERIODO )        
   SELECT @COD_CUSTO_MEDIO, PRODUTO, COR_PRODUTO, ORDEM_PRODUCAO, TAREFA, INDICADOR_ABSORCAO, SUM(TOTAL_QTDE_PERIODO), 0,        
       SUM(TOTAL_MINUTOS_PERIODO), 0, SUM(TOTAL_ABSORCAO_PERIODO)        
   FROM @ABSORCAO_TEMP        
        
   GROUP BY PRODUTO, COR_PRODUTO, ORDEM_PRODUCAO, TAREFA, INDICADOR_ABSORCAO        
   /*-- PROPORCIONALIZAÇÃO DA ABSORÇÃO DE PRODUÇÃO -- FINAL --*/        
        
  IF @FECHA_COR_PA = 0 --#24#        
  BEGIN --#24#        
   INSERT INTO CM_PRODUCAO_PA_ABSORCAO ( COD_CUSTO_MEDIO, PRODUTO, COR_PRODUTO, ORDEM_PRODUCAO, TAREFA, INDICADOR_ABSORCAO,         
                                         TOTAL_QTDE_PERIODO, TOTAL_QTDE_ACUMULADA, TOTAL_MINUTOS_PERIODO, TOTAL_ABSORCAO_ACUMULADO,         
                                         TOTAL_ABSORCAO_PERIODO )        
   SELECT @COD_CUSTO_MEDIO, A.PRODUTO, A.COR_PRODUTO, A.ORDEM_PRODUCAO, A.TAREFA, A.INDICADOR_ABSORCAO, 0 AS TOTAL_QTDE_PERIODO,         
       A.TOTAL_QTDE_ACUMULADA, 0 AS TOTAL_MINUTOS_PERIODO, A.TOTAL_ABSORCAO_ACUMULADO, 0 AS TOTAL_ABSORCAO_PERIODO        
   FROM CM_PRODUCAO_PA_ABSORCAO A        
     JOIN PRODUCAO_ORDEM (NOLOCK)/*#GS:01.02#*/C ON C.ORDEM_PRODUCAO = A.ORDEM_PRODUCAO        
     JOIN PRODUTOS (NOLOCK)/*#GS:01.02#*/P ON P.PRODUTO = A.PRODUTO        
     LEFT JOIN CM_PRODUCAO_PA_ABSORCAO B ON B.COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO AND         
                 B.PRODUTO = A.PRODUTO AND         
                 B.ORDEM_PRODUCAO = A.ORDEM_PRODUCAO AND         
                 B.INDICADOR_ABSORCAO = A.INDICADOR_ABSORCAO AND         
                 B.TAREFA = A.TAREFA        
   WHERE A.COD_CUSTO_MEDIO = @COD_CUSTO_ANT AND         
      B.COD_CUSTO_MEDIO IS NULL AND         
      ( C.ENCERRAMENTO  >= @DATA_INI OR         
     C.ENCERRAMENTO IS NULL ) AND         
      ISNULL(P.MONTAGEM_KIT,0) = @SEMI_ACABADO AND         
      ISNULL(C.TIPO_PROCESSO, 0) NOT IN ( 4 )        
  END --#24#        
  ELSE --#24#        
  BEGIN --#24#        
   INSERT INTO CM_PRODUCAO_PA_ABSORCAO ( COD_CUSTO_MEDIO, PRODUTO, COR_PRODUTO, ORDEM_PRODUCAO, TAREFA, INDICADOR_ABSORCAO,         
                                         TOTAL_QTDE_PERIODO, TOTAL_QTDE_ACUMULADA, TOTAL_MINUTOS_PERIODO, TOTAL_ABSORCAO_ACUMULADO,         
                                         TOTAL_ABSORCAO_PERIODO )        
   SELECT @COD_CUSTO_MEDIO, A.PRODUTO, A.COR_PRODUTO, A.ORDEM_PRODUCAO, A.TAREFA, A.INDICADOR_ABSORCAO, 0 AS TOTAL_QTDE_PERIODO,         
       A.TOTAL_QTDE_ACUMULADA, 0 AS TOTAL_MINUTOS_PERIODO, A.TOTAL_ABSORCAO_ACUMULADO, 0 AS TOTAL_ABSORCAO_PERIODO        
   FROM CM_PRODUCAO_PA_ABSORCAO A        
     JOIN PRODUCAO_ORDEM (NOLOCK)/*#GS:01.02#*/C ON C.ORDEM_PRODUCAO = A.ORDEM_PRODUCAO        
     JOIN PRODUTOS (NOLOCK)/*#GS:01.02#*/P ON P.PRODUTO = A.PRODUTO        
     LEFT JOIN CM_PRODUCAO_PA_ABSORCAO B ON B.COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO AND         
                 B.PRODUTO = A.PRODUTO AND         
                 B.COR_PRODUTO = A.COR_PRODUTO AND         
                 B.ORDEM_PRODUCAO = A.ORDEM_PRODUCAO AND         
                 B.INDICADOR_ABSORCAO = A.INDICADOR_ABSORCAO AND         
                 B.TAREFA = A.TAREFA        
   WHERE A.COD_CUSTO_MEDIO = @COD_CUSTO_ANT AND         
      B.COD_CUSTO_MEDIO IS NULL AND         
      ( C.ENCERRAMENTO  >= @DATA_INI OR         
     C.ENCERRAMENTO IS NULL ) AND         
      ISNULL(P.MONTAGEM_KIT,0) = @SEMI_ACABADO AND         
      ISNULL(C.TIPO_PROCESSO, 0) NOT IN ( 4 )        
        
  END --#24#        
                
  END -- IF @CONSERTO = 0        
  ELSE       
  BEGIN        


        
   INSERT INTO CM_PRODUCAO_PA_ABSORCAO ( COD_CUSTO_MEDIO, PRODUTO, COR_PRODUTO, ORDEM_PRODUCAO, TAREFA, INDICADOR_ABSORCAO,         
                                         TOTAL_QTDE_PERIODO, TOTAL_QTDE_ACUMULADA, TOTAL_MINUTOS_PERIODO, TOTAL_ABSORCAO_ACUMULADO,         
                                         TOTAL_ABSORCAO_PERIODO )        


   SELECT @COD_CUSTO_MEDIO AS COD_CUSTO_MEDIO, B.PRODUTO,         
     ( CASE WHEN @FECHA_COR_PA = 1 THEN A.COR_PRODUTO ELSE '' END ) AS COR_PRODUTO /*#13#*/,        
     A.ORDEM_PRODUCAO, 'CONSUMO PA' AS TAREFA,        
     @IND_MP_PADRAO AS INDICADOR_ABSORCAO, QTDE_TOTAL AS TOTAL_QTDE_PERIODO, 0 AS TOTAL_QTDE_ACUMULADA, 0 AS TOTAL_MINUTOS_PERIODO,         
     0 AS TOTAL_ABSORCAO_ACUMULADO, TOTAL_ABSORCAO_PERIODO AS TOTAL_ABSORCAO_PERIODO        
   FROM ( SELECT A.ORDEM_PRODUCAO, SUM(( B.QTDE * ISNULL(C.CUSTO_MEDIO_UNITARIO,0) )) AS TOTAL_ABSORCAO_PERIODO         
       ,( CASE WHEN @FECHA_COR_PA = 1 THEN B.COR_PRODUTO ELSE '' END ) AS COR_PRODUTO /*#13#*/         
          FROM ESTOQUE_PROD_SAI (NOLOCK)/*#GS:01.02#*/AS A        
               INNER JOIN ESTOQUE_PROD1_SAI (NOLOCK)/*#GS:01.02#*/AS B ON B.ROMANEIO_PRODUTO = A.ROMANEIO_PRODUTO AND         
                                                    B.FILIAL = A.FILIAL        
               INNER JOIN PRODUCAO_ORDEM (NOLOCK)/*#GS:01.02#*/AS O ON O.ORDEM_PRODUCAO = A.ORDEM_PRODUCAO        
               INNER JOIN PRODUTOS (NOLOCK)/*#GS:01.02#*/AS P ON P.PRODUTO = O.PRODUTO        
               JOIN CM_ESTOQUE_PA (NOLOCK)/*#GS:01.02#*/AS C  --#CSM004# retirado o join para calcular o consumo do semi acabado dentro do periodo na query abaixo 
       ON --C.COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO AND --#29#        
        C.COD_CUSTO_MEDIO = @COD_CUSTO_ANT AND --#29#        
                       C.FILIAL = A.FILIAL AND         
                       C.PRODUTO = B.PRODUTO AND         
                     ( C.COR_PRODUTO = B.COR_PRODUTO OR         
        C.COR_PRODUTO = '' )        
          WHERE A.EMISSAO BETWEEN @DATA_INI AND @DATA_FIN AND         
       A.ORDEM_PRODUCAO IS NOT NULL AND         
       ISNULL(P.MONTAGEM_KIT, 0) = @SEMI_ACABADO AND         
       O.TIPO_PROCESSO IN ( 1, 2, 3, 5 ) /* TRANSFORMAÇÃO / CONSERTO / SEGUNDA QUALIDADE/ RETRABALHO */--#10#        
       /*#15# - Início*/        
        AND (        
         (         
      @CALCULA_CUSTO_POR_FILIAL=1        
          AND          
          EXISTS (SELECT COD_CUSTO_MEDIO         
            FROM CM_FECHAMENTO_CUSTO_MEDIO_FILIAIS CMF          
            INNER JOIN FILIAIS (NOLOCK)/*#GS:01.02#*/FI ON CMF.COD_FILIAL = FI.COD_FILIAL        
            WHERE CMF.COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO AND FI.FILIAL = O.FILIAL        
            )         
         )        
          OR         
         (        
          @CALCULA_CUSTO_POR_FILIAL=0        
         )        
        )        
       /*#15# - Fim*/        
       /*#17# - Início*/        
       AND EXISTS (        
           SELECT EMPRESA         
           FROM FILIAIS (NOLOCK)/*#GS:01.02#*/FI         
           WHERE FI.FILIAL = O.FILIAL AND         
           ( FI.EMPRESA = @EMPRESA OR FI.EMPRESA IS NULL OR @EMPRESA=-1 )         
          )         
       /*#17# - Fim*/        
        
          GROUP BY A.ORDEM_PRODUCAO         
       ,( CASE WHEN @FECHA_COR_PA = 1 THEN B.COR_PRODUTO ELSE '' END )  /*#13#*/        
       ) A        
        INNER JOIN PRODUCAO_ORDEM AS B ON B.ORDEM_PRODUCAO = A.ORDEM_PRODUCAO        

   INSERT INTO CM_PRODUCAO_PA_ABSORCAO ( COD_CUSTO_MEDIO, PRODUTO, COR_PRODUTO, ORDEM_PRODUCAO, TAREFA, INDICADOR_ABSORCAO,         
                                         TOTAL_QTDE_PERIODO, TOTAL_QTDE_ACUMULADA, TOTAL_MINUTOS_PERIODO, TOTAL_ABSORCAO_ACUMULADO,         
                                         TOTAL_ABSORCAO_PERIODO )        

   SELECT @COD_CUSTO_MEDIO AS COD_CUSTO_MEDIO, B.PRODUTO,         
     ( CASE WHEN @FECHA_COR_PA = 1 THEN A.COR_PRODUTO ELSE '' END ) AS COR_PRODUTO /*#13#*/,        
     A.ORDEM_PRODUCAO, 'CONSUMO PA' AS TAREFA,        
     @IND_MP_PADRAO AS INDICADOR_ABSORCAO, QTDE_TOTAL AS TOTAL_QTDE_PERIODO, 0 AS TOTAL_QTDE_ACUMULADA, 0 AS TOTAL_MINUTOS_PERIODO,         
     0 AS TOTAL_ABSORCAO_ACUMULADO, TOTAL_ABSORCAO_PERIODO AS TOTAL_ABSORCAO_PERIODO        
   FROM ( SELECT A.ORDEM_PRODUCAO, SUM(( B.QTDE * ISNULL(C.CUSTO_MEDIO_UNITARIO,0) )) AS TOTAL_ABSORCAO_PERIODO         
       ,( CASE WHEN @FECHA_COR_PA = 1 THEN B.COR_PRODUTO ELSE '' END ) AS COR_PRODUTO /*#13#*/         
          FROM ESTOQUE_PROD_SAI (NOLOCK)/*#GS:01.02#*/AS A        
               INNER JOIN ESTOQUE_PROD1_SAI (NOLOCK)/*#GS:01.02#*/AS B ON B.ROMANEIO_PRODUTO = A.ROMANEIO_PRODUTO AND         
                                                    B.FILIAL = A.FILIAL        
               INNER JOIN PRODUCAO_ORDEM (NOLOCK)/*#GS:01.02#*/AS O ON O.ORDEM_PRODUCAO = A.ORDEM_PRODUCAO        
               INNER JOIN PRODUTOS (NOLOCK)/*#GS:01.02#*/AS P ON P.PRODUTO = O.PRODUTO        
               JOIN 
			   (
				  SELECT PRODUTO, SUM(VALOR_PRODUZIDO)/SUM(QTDE_PRODUZIDA) CUSTO_MEDIO_UNITARIO 
				  FROM CM_PRODUCAO_PA 
				  WHERE COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO
				  AND QTDE_PRODUZIDA > 0 
				  GROUP BY PRODUTO 
				) C --#CSM004# Calcula o custo medio dos produtos que foram produzidos neste periodo 
       ON --C.COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO AND --#29#        
                       C.PRODUTO = B.PRODUTO 
          WHERE A.EMISSAO BETWEEN @DATA_INI AND @DATA_FIN AND         
       A.ORDEM_PRODUCAO IS NOT NULL AND         
       ISNULL(P.MONTAGEM_KIT, 0) = @SEMI_ACABADO AND         
       O.TIPO_PROCESSO IN ( 1, 2, 3, 5 ) /* TRANSFORMAÇÃO / CONSERTO / SEGUNDA QUALIDADE/ RETRABALHO */--#10#        
       /*#15# - Início*/        
        AND (        
         (         
          @CALCULA_CUSTO_POR_FILIAL=1        
          AND          
          EXISTS (SELECT COD_CUSTO_MEDIO         
            FROM CM_FECHAMENTO_CUSTO_MEDIO_FILIAIS CMF          
            INNER JOIN FILIAIS (NOLOCK)/*#GS:01.02#*/FI ON CMF.COD_FILIAL = FI.COD_FILIAL        
            WHERE CMF.COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO AND FI.FILIAL = O.FILIAL        
            )         
         )        
          OR         
         (        
          @CALCULA_CUSTO_POR_FILIAL=0        
         )        
        )        
       /*#15# - Fim*/        
       /*#17# - Início*/        
       AND EXISTS (        
           SELECT EMPRESA         
           FROM FILIAIS (NOLOCK)/*#GS:01.02#*/FI         
           WHERE FI.FILIAL = O.FILIAL AND         
   ( FI.EMPRESA = @EMPRESA OR FI.EMPRESA IS NULL OR @EMPRESA=-1 )         
          )         
       /*#17# - Fim*/        
        
          GROUP BY A.ORDEM_PRODUCAO         
       ,( CASE WHEN @FECHA_COR_PA = 1 THEN B.COR_PRODUTO ELSE '' END )  /*#13#*/        
       ) A        
        INNER JOIN PRODUCAO_ORDEM AS B ON B.ORDEM_PRODUCAO = A.ORDEM_PRODUCAO        



        
   DELETE A         
   FROM CM_PRODUCAO_PA AS A        
        INNER JOIN PRODUCAO_ORDEM (NOLOCK)/*#GS:01.02#*/AS B ON A.ORDEM_PRODUCAO = B.ORDEM_PRODUCAO AND        
                                          A.PRODUTO = B.PRODUTO        
        INNER JOIN PRODUTOS (NOLOCK)/*#GS:01.02#*/AS C ON A.PRODUTO = C.PRODUTO        
   WHERE COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO AND        
         ISNULL(C.MONTAGEM_KIT, 0) = @SEMI_ACABADO AND         
         ISNULL(B.TIPO_PROCESSO, 0) IN ( 1, 2, 3, 5 ) --#10#        
   
  END -- IF @CONSERTO = 0 / ELSE        
          
  --ACUMULA ABSORCAO        
  UPDATE A        
  SET TOTAL_ABSORCAO_ACUMULADO = ( ISNULL(B.TOTAL_ABSORCAO_ACUMULADO, 0) + ISNULL(A.TOTAL_ABSORCAO_PERIODO, 0) ),        
    --TOTAL_QTDE_ACUMULADA = ( ISNULL(B.TOTAL_QTDE_ACUMULADA, 0) + ISNULL(A.TOTAL_QTDE_PERIODO, 0) ) -##        
    --##        
   TOTAL_QTDE_ACUMULADA = CASE WHEN ISNULL(A.TAREFA,'')='' AND ISNULL(B.TOTAL_QTDE_ACUMULADA, 0) = 0 THEN ISNULL(A.TOTAL_QTDE_PERIODO, 0)        
                               WHEN ISNULL(A.TAREFA,'')='' AND ISNULL(B.TOTAL_QTDE_ACUMULADA, 0) > 0 THEN ISNULL(B.TOTAL_QTDE_ACUMULADA, 0)        
                               ELSE (ISNULL(B.TOTAL_QTDE_ACUMULADA, 0) + ISNULL(A.TOTAL_QTDE_PERIODO, 0))         
                          END         
    --##        
  FROM CM_PRODUCAO_PA_ABSORCAO A        
       LEFT JOIN CM_PRODUCAO_PA_ABSORCAO B ON B.COD_CUSTO_MEDIO = @COD_CUSTO_ANT AND         
                                              B.PRODUTO = A.PRODUTO AND         
                                              B.COR_PRODUTO = A.COR_PRODUTO AND         
                                       B.ORDEM_PRODUCAO = A.ORDEM_PRODUCAO AND         
                                              B.INDICADOR_ABSORCAO = A.INDICADOR_ABSORCAO AND         
                                              B.TAREFA = A.TAREFA        
  WHERE A.COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO        

  SELECT * FROM CM_PRODUCAO_PA_ABSORCAO WHERE COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO AND ORDEM_PRODUCAO = '885759' 
        
  /*-- EXCLUI OS ZERADOS --*/        
  DELETE A FROM CM_PRODUCAO_PA_ABSORCAO A        
  JOIN PRODUCAO_ORDEM B ON A.ORDEM_PRODUCAO = B.ORDEM_PRODUCAO --#CSM004#--
  WHERE COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO AND        
     TOTAL_ABSORCAO_PERIODO = 0 AND        
     TOTAL_ABSORCAO_ACUMULADO = 0 AND 
	 B.FILIAL NOT LIKE 'FAC%INTERNACIONAL%' --#CSM004#--

       
 END -- IF @ARBITRADO = 1 OR @ARBITRADO = 2 // ELSE        
        
 -- GERA TABELA TEMPORÁRIA PARA GRAVAÇÃO DA TABELA CM_PRODUCAO_PA         
 DECLARE @TEMP_QTDE_OPS TABLE ( PRODUTO CHAR(12) COLLATE DATABASE_DEFAULT,        
           COR_PRODUTO CHAR(10) COLLATE DATABASE_DEFAULT,        
           ORDEM_PRODUCAO CHAR(8) COLLATE DATABASE_DEFAULT,        
           QTDE_FINALIZADA INT,        
           QTDE_FINALIZADA_PERIODO INT,         
           VALOR_FINALIZADO NUMERIC(15,5), --#20#        
           QTDE_EM_PRODUCAO INT,         
           VALOR_EM_PRODUCAO NUMERIC(15,5), --#20#        
		   QTDE_EM_PROCESSO INT ) --#GS:01.03#
        
 INSERT INTO @TEMP_QTDE_OPS ( PRODUTO, COR_PRODUTO, ORDEM_PRODUCAO, QTDE_EM_PRODUCAO, QTDE_FINALIZADA, QTDE_FINALIZADA_PERIODO,         
                              VALOR_EM_PRODUCAO, VALOR_FINALIZADO, QTDE_EM_PROCESSO ) --#GS:01.03#
         
         
 SELECT B.PRODUTO, B.COR_PRODUTO, A.ORDEM_PRODUCAO,         
        ( ISNULL(B.QTDE_O, 0) - ISNULL(C.QTDE_FINALIZADA, 0) + ISNULL(PCP.QTDE_PCP_PERDA, 0) -         
          ISNULL(PCP.QTDE_LAVAGEM_TRANSF, 0) + ISNULL(LAV.QTDE_LAVAGEM, 0) ),         
        ISNULL(C.QTDE_FINALIZADA, 0), ISNULL(C.QTDE_FINALIZADA_PERIODO, 0), 0 AS VALOR_EM_PRODUCAO, 0 AS VALOR_FINALIZADO, 0 AS QTDE_EM_PROCESSO --#GS:01.03#        
 FROM PRODUCAO_ORDEM AS A (NOLOCK)/*#GS:01.02#*/       
      INNER JOIN PRODUCAO_ORDEM_COR (NOLOCK)/*#GS:01.02#*/AS B ON A.ORDEM_PRODUCAO = B.ORDEM_PRODUCAO        
   INNER JOIN PRODUTOS (NOLOCK)/*#GS:01.02#*/AS P ON P.PRODUTO = A.PRODUTO        
      LEFT JOIN FILIAIS (NOLOCK)/*#GS:01.02#*/AS D ON D.FILIAL = A.FILIAL        
   LEFT JOIN ( SELECT A.ORDEM_PRODUCAO, A.PRODUTO, A.COR_PRODUTO, SUM(A.QTDE) AS QTDE_FINALIZADA,         
                      SUM(( CASE WHEN B.EMISSAO BETWEEN @DATA_INI AND @DATA_FIN        
                               THEN A.QTDE        
                               ELSE 0        
                            END )) AS QTDE_FINALIZADA_PERIODO        
                     FROM ESTOQUE_PROD1_ENT AS A(NOLOCK)/*#GS:01.02#*/       
                          INNER JOIN ESTOQUE_PROD_ENT (NOLOCK)/*#GS:01.02#*/AS B ON B.ROMANEIO_PRODUTO = A.ROMANEIO_PRODUTO AND         
         B.FILIAL = A.FILIAL        
                     WHERE A.ORDEM_PRODUCAO IS NOT NULL AND         
                           B.EMISSAO <= @DATA_FIN        
                     GROUP BY A.ORDEM_PRODUCAO, A.PRODUTO, A.COR_PRODUTO         
                   ) AS C ON C.ORDEM_PRODUCAO = A.ORDEM_PRODUCAO AND         
                             C.PRODUTO = B.PRODUTO AND         
                             C.COR_PRODUTO = B.COR_PRODUTO        
      LEFT JOIN ( SELECT A.ORDEM_PRODUCAO, A.PRODUTO, A.COR_PRODUTO,         
                         SUM(( CASE WHEN B.INDICADOR_TIPO_MOV IN ( 2, 4 )         
                                  THEN ( A.QTDE_O * -1 )        
                                  ELSE 0         
                               END )) AS QTDE_PCP_PERDA,         
                         SUM(( CASE WHEN B.INDICADOR_TIPO_MOV IN ( 3 )         
                  THEN A.QTDE_O        
                                  ELSE 0         
                               END )) AS QTDE_LAVAGEM_TRANSF        
                  FROM PRODUCAO_OS_TAREFAS AS A(NOLOCK)/*#GS:01.02#*/        
                       INNER JOIN PRODUCAO_ORDEM_SERVICO (NOLOCK)/*#GS:01.02#*/AS B ON A.ORDEM_SERVICO = B.ORDEM_SERVICO        
                  WHERE A.ORDEM_PRODUCAO IS NOT NULL AND        
                        B.DATA > @DATA_FIN AND        
                        B.INDICADOR_TIPO_MOV IN ( 2, 3, 4 ) -- ALTERAÇÃO PCP / LAVAGEM / PERDA        
                  GROUP BY A.ORDEM_PRODUCAO, A.PRODUTO, A.COR_PRODUTO        
                ) AS PCP ON A.ORDEM_PRODUCAO = PCP.ORDEM_PRODUCAO AND        
                            B.PRODUTO = PCP.PRODUTO AND         
                            B.COR_PRODUTO = PCP.COR_PRODUTO        
      LEFT JOIN ( SELECT A.ORDEM_PRODUCAO, A.PRODUTO, C.COR_ANTERIOR AS COR_PRODUTO, SUM(C.QTDE_A) AS QTDE_LAVAGEM        
                  FROM PRODUCAO_OS_TAREFAS (NOLOCK)/*#GS:01.02#*/AS A        
                       INNER JOIN PRODUCAO_ORDEM_SERVICO (NOLOCK)/*#GS:01.02#*/AS B ON A.ORDEM_SERVICO = B.ORDEM_SERVICO        
                       INNER JOIN PRODUCAO_OS_ANTERIOR (NOLOCK)/*#GS:01.02#*/AS C ON A.TAREFA = C.TAREFA AND         
                                                               ISNULL(B.ORDEM_SERVICO_PARALELA,B.ORDEM_SERVICO)/*#14#*/ = C.ORDEM_SERVICO AND        
                                                               A.ORDEM_PRODUCAO = C.ORDEM_PRODUCAO AND        
                                                               A.PRODUTO = C.PRODUTO AND        
                                                               A.COR_PRODUTO = C.COR_PRODUTO        
                  WHERE A.ORDEM_PRODUCAO IS NOT NULL AND        
                        B.DATA > @DATA_FIN AND        
  B.INDICADOR_TIPO_MOV IN ( 3 ) -- LAVAGEM        
                  GROUP BY A.ORDEM_PRODUCAO, A.PRODUTO, C.COR_ANTERIOR        
                ) AS LAV ON A.ORDEM_PRODUCAO = LAV.ORDEM_PRODUCAO AND        
                            B.PRODUTO = LAV.PRODUTO AND         
                            B.COR_PRODUTO = LAV.COR_PRODUTO        
 WHERE A.INICIO_REAL <= @DATA_FIN AND         
   ISNULL(A.ENCERRAMENTO, @DATA_INI) >= @DATA_INI AND        
   ( D.EMPRESA = @EMPRESA OR D.EMPRESA IS NULL OR @EMPRESA=-1 ) AND         
   ISNULL(P.MONTAGEM_KIT, 0) = @SEMI_ACABADO AND         
   ( ( ISNULL(B.QTDE_O, 0) - ISNULL(C.QTDE_FINALIZADA, 0) + ISNULL(PCP.QTDE_PCP_PERDA, 0) - ISNULL(PCP.QTDE_LAVAGEM_TRANSF, 0) +         
            ISNULL(LAV.QTDE_LAVAGEM, 0) ) <> 0 OR ISNULL(C.QTDE_FINALIZADA, 0) <> 0 ) AND        
   ( ( @CONSERTO = 0 AND ISNULL(A.TIPO_PROCESSO, 0) NOT IN ( 4 ) ) OR         
          ( @CONSERTO = 1 AND A.TIPO_PROCESSO IN ( 1, 2, 3, 5 ) ) ) --#10#        
   /*#15# - Início*/        
    AND (        
     (         
      @CALCULA_CUSTO_POR_FILIAL=1        
      AND          
      EXISTS (SELECT COD_CUSTO_MEDIO         
        FROM CM_FECHAMENTO_CUSTO_MEDIO_FILIAIS CMF          
        INNER JOIN FILIAIS (NOLOCK)/*#GS:01.02#*/FI ON CMF.COD_FILIAL = FI.COD_FILIAL        
        WHERE CMF.COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO AND FI.FILIAL = A.FILIAL        
        )         
     )        
      OR         
     (        
      @CALCULA_CUSTO_POR_FILIAL=0        
     )        
    )        
   /*#15# - Fim*/        
   /*#17# - Início*/        
   AND EXISTS (        
       SELECT EMPRESA         
       FROM FILIAIS (NOLOCK)/*#GS:01.02#*/FI         
       WHERE FI.FILIAL = A.FILIAL AND         
       ( FI.EMPRESA = @EMPRESA OR FI.EMPRESA IS NULL OR @EMPRESA=-1 )         
      )         
   /*#17# - Fim*/        

 UPDATE @TEMP_QTDE_OPS SET QTDE_EM_PRODUCAO = 0, VALOR_EM_PRODUCAO = 0, QTDE_EM_PROCESSO=0 --#GS:01.03#
  WHERE QTDE_EM_PRODUCAO < 0 -- #CSM003
        
 IF ISNULL(DBO.FX_PARAMETRO('CM_QTDE_PROC_MOVIMENTO'), '.F.') = '.T.'          
 BEGIN          
        
  /* ZERA A QTDE EM PRODUÇÃO PARA AS OPS QUE NÃO TIVERAM BAIXA DE MATERIAL */        
  UPDATE A        
  SET QTDE_EM_PRODUCAO = 0        
  FROM @TEMP_QTDE_OPS AS A        
       LEFT JOIN ( ESTOQUE_SAI1_MAT  (NOLOCK)/*#GS:01.02#*/      
                   INNER JOIN ESTOQUE_SAI_MAT (NOLOCK)/*#GS:01.02#*/ON ESTOQUE_SAI_MAT.REQ_MATERIAL = ESTOQUE_SAI1_MAT.REQ_MATERIAL AND         
                                                 ESTOQUE_SAI_MAT.FILIAL = ESTOQUE_SAI1_MAT.FILIAL AND        
                                           ESTOQUE_SAI_MAT.EMISSAO <= @DATA_FIN        
                 ) ON ESTOQUE_SAI1_MAT.ORDEM_PRODUCAO = A.ORDEM_PRODUCAO        
  WHERE ESTOQUE_SAI1_MAT.REQ_MATERIAL IS NULL        
        
 END        
        
 /* GERAR REGISTROS DA TABELA CM_PRODUCAO_PA */        
 IF @ARBITRADO = 1 /* POR PEDIDO DE VENDAS */        
 BEGIN        
        
  DECLARE @TMP_VENDAS TABLE ( PRODUTO CHAR(12) COLLATE DATABASE_DEFAULT,        
                 COR_PRODUTO CHAR(10) COLLATE DATABASE_DEFAULT,        
                              CUSTO NUMERIC(18,5) )        
        
  /* PRIMEIRO PASSO: PEGAR DO FATURAMENTO */        
  INSERT INTO @TMP_VENDAS        
  SELECT B.PRODUTO, B.COR_PRODUTO, CUSTO = MAX(ROUND(( CASE WHEN B.QTDE = 0         
                                                          THEN 0         
                                                          ELSE ( B.VALOR / B.QTDE )         
                                                       END ), 5))        
  FROM FATURAMENTO A   (NOLOCK)/*#GS:01.02#*/     
    INNER JOIN ( SELECT FP.FILIAL, FP.NF_SAIDA, FP.SERIE_NF, FP.PRODUTO, FP.COR_PRODUTO, SUM(FP.QTDE) AS QTDE, SUM(FP.VALOR) AS VALOR        
                 FROM FATURAMENTO_PROD (NOLOCK)/*#GS:01.02#*/AS FP        
          INNER JOIN FATURAMENTO (NOLOCK)/*#GS:01.02#*/AS F ON FP.FILIAL = F.FILIAL AND        
                                                     FP.NF_SAIDA = F.NF_SAIDA AND        
                                                     FP.SERIE_NF = F.SERIE_NF        
                 WHERE F.EMISSAO BETWEEN @INICIO_VENDAS AND @FINAL_VENDAS        
        /*#15# - Início*/        
         AND (        
          (         
           @CALCULA_CUSTO_POR_FILIAL=1        
           AND          
           EXISTS (SELECT COD_CUSTO_MEDIO         
             FROM CM_FECHAMENTO_CUSTO_MEDIO_FILIAIS CMF          
             INNER JOIN FILIAIS (NOLOCK)/*#GS:01.02#*/FI ON CMF.COD_FILIAL = FI.COD_FILIAL        
             WHERE CMF.COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO AND FI.FILIAL = FP.FILIAL        
             )         
          )        
           OR         
          (        
           @CALCULA_CUSTO_POR_FILIAL=0        
          )        
         )        
        /*#15# - Fim*/        
        /*#17# - Início*/        
        AND EXISTS (        
            SELECT EMPRESA         
            FROM FILIAIS (NOLOCK)/*#GS:01.02#*/FI         
            WHERE FI.FILIAL = FP.FILIAL AND         
            ( FI.EMPRESA = @EMPRESA OR FI.EMPRESA IS NULL OR @EMPRESA=-1 )         
           )         
        /*#17# - Fim*/        
                 GROUP BY FP.FILIAL, FP.NF_SAIDA, FP.SERIE_NF, FP.PRODUTO, FP.COR_PRODUTO         
               ) AS B ON A.FILIAL = B.FILIAL AND        
                            A.NF_SAIDA = B.NF_SAIDA AND        
                            A.SERIE_NF = B.SERIE_NF        
    LEFT JOIN NATUREZAS_SAIDAS (NOLOCK)/*#GS:01.02#*/C ON A.NATUREZA_SAIDA = C.NATUREZA_SAIDA        
    LEFT JOIN CTB_LX_TIPO_OPERACAO (NOLOCK)/*#GS:01.02#*/D ON C.CTB_TIPO_OPERACAO = D.CTB_TIPO_OPERACAO        
  WHERE ISNULL(D.TIPO_OPERACAO, ISNULL(C.TIPO_OPERACAO, ' ')) = 'V' AND        
     A.EMISSAO BETWEEN @INICIO_VENDAS AND @FINAL_VENDAS        
  GROUP BY B.PRODUTO, B.COR_PRODUTO        
        
  /* SEGUNDO PASSO: PEGAR DO PEDIDO DE VENDA TODOS AQUELES QUE NÃO FORAM ENCONTRADOS NO FATURAMENTO */        
  INSERT INTO @TMP_VENDAS        
  SELECT B.PRODUTO, B.COR_PRODUTO, CUSTO = MAX(( CASE WHEN B.QTDE_ORIGINAL = 0 THEN 0 ELSE ROUND(( B.VALOR_ORIGINAL / B.QTDE_ORIGINAL ), 5) END ))        
  FROM VENDAS A   (NOLOCK)/*#GS:01.02#*/     
    INNER JOIN ( SELECT VP.PEDIDO, VP.PRODUTO, VP.COR_PRODUTO, SUM(VP.QTDE_ORIGINAL) AS QTDE_ORIGINAL, SUM(VP.VALOR_ORIGINAL) AS VALOR_ORIGINAL        
                 FROM VENDAS_PRODUTO (NOLOCK)/*#GS:01.02#*/AS VP        
                      INNER JOIN VENDAS (NOLOCK)/*#GS:01.02#*/AS V ON VP.PEDIDO = V.PEDIDO        
                 WHERE V.EMISSAO BETWEEN @INICIO_VENDAS AND @FINAL_VENDAS        
          /*#15# - Início*/        
         AND (        
          (         
           @CALCULA_CUSTO_POR_FILIAL=1        
           AND          
           EXISTS (SELECT COD_CUSTO_MEDIO         
             FROM CM_FECHAMENTO_CUSTO_MEDIO_FILIAIS CMF          
             INNER JOIN FILIAIS (NOLOCK)/*#GS:01.02#*/FI ON CMF.COD_FILIAL = FI.COD_FILIAL        
             WHERE CMF.COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO AND FI.FILIAL = V.FILIAL        
             )         
          )        
           OR         
          (        
           @CALCULA_CUSTO_POR_FILIAL=0        
          )        
         )        
        /*#15# - Fim*/        
        /*#17# - Início*/        
        AND EXISTS (        
            SELECT EMPRESA         
            FROM FILIAIS (NOLOCK)/*#GS:01.02#*/FI         
            WHERE FI.FILIAL = V.FILIAL AND         
            ( FI.EMPRESA = @EMPRESA OR FI.EMPRESA IS NULL OR @EMPRESA=-1 )         
           )         
        /*#17# - Fim*/        
        
                 GROUP BY VP.PEDIDO, VP.PRODUTO, VP.COR_PRODUTO        
               ) AS B ON A.PEDIDO = B.PEDIDO        
       LEFT JOIN @TMP_VENDAS AS C ON B.PRODUTO = C.PRODUTO AND        
                                     B.COR_PRODUTO = C.COR_PRODUTO         
  WHERE C.PRODUTO IS NULL AND         
        A.EMISSAO BETWEEN @INICIO_VENDAS AND @FINAL_VENDAS        
  GROUP BY B.PRODUTO, B.COR_PRODUTO        
          
  /* TERCEIRO PASSO: PEGAR A VENDA DA LOJA */        
  INSERT INTO @TMP_VENDAS        
  SELECT B.PRODUTO, B.COR_PRODUTO, MAX(( CASE WHEN B.QTDE = 0 THEN 0 ELSE ROUND(( B.VALOR_TOTAL / B.QTDE ), 5) END )) AS CUSTO        
  FROM LOJA_VENDA (NOLOCK)/*#GS:01.02#*/AS A         
    INNER JOIN ( SELECT LVP.TICKET, LVP.CODIGO_FILIAL, LVP.DATA_VENDA, LVP.PRODUTO, LVP.COR_PRODUTO, SUM(LVP.QTDE) AS QTDE,         
         SUM(( LVP.QTDE * LVP.PRECO_LIQUIDO * LVP.FATOR_VENDA_LIQ )) AS VALOR_TOTAL        
        FROM LOJA_VENDA_PRODUTO (NOLOCK)/*#GS:01.02#*/AS LVP        
          INNER JOIN LOJA_VENDA (NOLOCK)/*#GS:01.02#*/AS LV ON LVP.CODIGO_FILIAL = LV.CODIGO_FILIAL AND        
                 LVP.TICKET = LV.TICKET AND        
                 LVP.DATA_VENDA = LV.DATA_VENDA        
        WHERE LV.DATA_VENDA BETWEEN @INICIO_VENDAS AND @FINAL_VENDAS AND        
        ISNULL(LVP.QTDE_CANCELADA, 0) = 0        
        
        
        GROUP BY LVP.TICKET, LVP.CODIGO_FILIAL, LVP.DATA_VENDA, LVP.PRODUTO, LVP.COR_PRODUTO        
      ) AS B ON A.CODIGO_FILIAL = B.CODIGO_FILIAL AND        
          A.TICKET = B.TICKET AND        
          A.DATA_VENDA = B.DATA_VENDA        
    LEFT JOIN @TMP_VENDAS AS C ON B.PRODUTO = C.PRODUTO AND        
             B.COR_PRODUTO = C.COR_PRODUTO        
  WHERE C.PRODUTO IS NULL AND        
    A.DATA_VENDA BETWEEN @INICIO_VENDAS AND @FINAL_VENDAS        
    /*#15# - Início*/        
     AND (        
      (         
       @CALCULA_CUSTO_POR_FILIAL=1        
       AND          
       EXISTS (SELECT COD_CUSTO_MEDIO         
         FROM CM_FECHAMENTO_CUSTO_MEDIO_FILIAIS CMF          
         INNER JOIN FILIAIS (NOLOCK)/*#GS:01.02#*/F  ON CMF.cod_FILIAL = F.COD_FILIAL        
         INNER JOIN LOJAS_VAREJO (NOLOCK)/*#GS:01.02#*/L ON l.FILIAL = F.FILIAL        
         WHERE CMF.COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO AND L.CODIGO_FILIAL = A.CODIGO_FILIAL        
         )         
      )        
       OR         
      (        
       @CALCULA_CUSTO_POR_FILIAL=0        
      )        
     )        
    /*#15# - Fim*/          
    /*#17# - Início*/        
    AND EXISTS (        
        SELECT empresa         
        from FILIAIS (NOLOCK)/*#GS:01.02#*/FI         
        INNER JOIN LOJAS_VAREJO (NOLOCK)/*#GS:01.02#*/L ON l.FILIAL = FI.FILIAL        
        WHERE L.CODIGO_FILIAL = A.CODIGO_FILIAL and         
        ( FI.EMPRESA = @EMPRESA OR FI.EMPRESA IS NULL OR @EMPRESA=-1 )         
       )         
        
    /*#17# - Fim*/        
        
  GROUP BY B.PRODUTO, B.COR_PRODUTO        
        
  /* VERIFICA SE FECHA POR COR, SE NÃO FECHAR, UTILIZA O MAIOR CUSTO DO PRODUTO */        
  IF @FECHA_COR_PA = 1        
  BEGIN        
        
   /* QUARTO PASSO: PEGAR DA TABELA DE PREÇO INFORMADA */        
   INSERT INTO @TMP_VENDAS        
   SELECT A.PRODUTO, A.COR_PRODUTO,         
       ROUND(( ( ISNULL(ISNULL(B.PRECO1, C.PRECO1), 0) + ISNULL(ISNULL(B.PRECO2, C.PRECO2), 0) + ISNULL(ISNULL(B.PRECO3, C.PRECO3), 0) +         
                             ISNULL(ISNULL(B.PRECO4, C.PRECO4), 0) ) /         
                           ( ( CASE WHEN CHARINDEX('1', E.PONTEIRO_PRECO_TAM) > 0 THEN 1 ELSE 0 END ) +        
                             ( CASE WHEN CHARINDEX('2', E.PONTEIRO_PRECO_TAM) > 0 THEN 1 ELSE 0 END ) +        
                     ( CASE WHEN CHARINDEX('3', E.PONTEIRO_PRECO_TAM) > 0 THEN 1 ELSE 0 END ) +        
                             ( CASE WHEN CHARINDEX('4', E.PONTEIRO_PRECO_TAM) > 0 THEN 1 ELSE 0 END ) ) ), 5)        
   FROM PRODUTO_CORES AS A (NOLOCK)/*#GS:01.02#*/       
     INNER JOIN PRODUTOS (NOLOCK)/*#GS:01.02#*/AS E ON A.PRODUTO = E.PRODUTO        
     LEFT JOIN PRODUTOS_PRECO_COR B ON A.PRODUTO = B.PRODUTO AND         
               A.COR_PRODUTO = B.COR_PRODUTO AND         
               B.CODIGO_TAB_PRECO = @CODIGO_TAB_PRECO        
     LEFT JOIN PRODUTOS_PRECOS (NOLOCK)/*#GS:01.02#*/C ON A.PRODUTO = C.PRODUTO AND         
            C.CODIGO_TAB_PRECO = @CODIGO_TAB_PRECO        
     LEFT JOIN @TMP_VENDAS AS D ON A.PRODUTO = D.PRODUTO AND        
              A.COR_PRODUTO = D.COR_PRODUTO         
   WHERE D.PRODUTO IS NULL AND         
      ( ISNULL(ISNULL(B.PRECO1, C.PRECO1), 0) + ISNULL(ISNULL(B.PRECO2, C.PRECO2), 0) + ISNULL(ISNULL(B.PRECO3, C.PRECO3), 0) +         
     ISNULL(ISNULL(B.PRECO4, C.PRECO4), 0) ) <> 0        
          
   INSERT INTO CM_PRODUCAO_PA ( COD_CUSTO_MEDIO, PRODUTO, COR_PRODUTO, ORDEM_PRODUCAO, QTDE_PRODUZIDA, VALOR_PRODUZIDO, QTDE_EM_PROCESSO,        
           VALOR_EM_PROCESSO )        
   SELECT @COD_CUSTO_MEDIO, A.PRODUTO, A.COR_PRODUTO, A.ORDEM_PRODUCAO, ISNULL(A.QTDE_FINALIZADA,0),         
       ( ISNULL(A.QTDE_FINALIZADA,0) * ROUND(( ( ISNULL(B.CUSTO,0) * @PORC_ACABADO ) / 100 ), 5) ), ISNULL(A.QTDE_EM_PRODUCAO,0),         
       ( ISNULL(A.QTDE_EM_PRODUCAO,0) * ROUND(( ( ISNULL(B.CUSTO,0) * @PORC_PROCESSO ) / 100 ), 5) )        
   FROM @TEMP_QTDE_OPS A        
     LEFT JOIN @TMP_VENDAS B ON B.PRODUTO = A.PRODUTO AND B.COR_PRODUTO = A.COR_PRODUTO        
        
  END        
  ELSE        
  BEGIN        
          
   /* QUARTO PASSO: PEGAR DA TABELA DE PREÇO INFORMADA */        
   INSERT INTO @TMP_VENDAS        
   SELECT A.PRODUTO, A.COR_PRODUTO,         
       ROUND(( ( ISNULL(ISNULL(B.PRECO1, C.PRECO1), 0) + ISNULL(ISNULL(B.PRECO2, C.PRECO2), 0) + ISNULL(ISNULL(B.PRECO3, C.PRECO3), 0) +         
              ISNULL(ISNULL(B.PRECO4, C.PRECO4), 0) ) /         
            ( ( CASE WHEN CHARINDEX('1', E.PONTEIRO_PRECO_TAM) > 0 THEN 1 ELSE 0 END ) +        
              ( CASE WHEN CHARINDEX('2', E.PONTEIRO_PRECO_TAM) > 0 THEN 1 ELSE 0 END ) +        
              ( CASE WHEN CHARINDEX('3', E.PONTEIRO_PRECO_TAM) > 0 THEN 1 ELSE 0 END ) +        
              ( CASE WHEN CHARINDEX('4', E.PONTEIRO_PRECO_TAM) > 0 THEN 1 ELSE 0 END ) ) ), 5)        
   FROM PRODUTO_CORES (NOLOCK)/*#GS:01.02#*/AS A        
     INNER JOIN PRODUTOS (NOLOCK)/*#GS:01.02#*/AS E ON A.PRODUTO = E.PRODUTO        
     LEFT JOIN PRODUTOS_PRECO_COR (NOLOCK)/*#GS:01.02#*/B ON A.PRODUTO = B.PRODUTO AND         
               A.COR_PRODUTO = B.COR_PRODUTO AND         
               B.CODIGO_TAB_PRECO = @CODIGO_TAB_PRECO        
     LEFT JOIN PRODUTOS_PRECOS (NOLOCK)/*#GS:01.02#*/C ON A.PRODUTO = C.PRODUTO AND         
            C.CODIGO_TAB_PRECO = @CODIGO_TAB_PRECO        
     LEFT JOIN @TMP_VENDAS AS D ON A.PRODUTO = D.PRODUTO        
   WHERE D.PRODUTO IS NULL AND         
      ( ISNULL(ISNULL(B.PRECO1, C.PRECO1), 0) + ISNULL(ISNULL(B.PRECO2, C.PRECO2), 0) + ISNULL(ISNULL(B.PRECO3, C.PRECO3), 0) +         
     ISNULL(ISNULL(B.PRECO4, C.PRECO4), 0) ) <> 0        
        
   INSERT INTO CM_PRODUCAO_PA ( COD_CUSTO_MEDIO, PRODUTO, COR_PRODUTO, ORDEM_PRODUCAO, QTDE_PRODUZIDA, VALOR_PRODUZIDO, QTDE_EM_PROCESSO,        
           VALOR_EM_PROCESSO )        
   SELECT @COD_CUSTO_MEDIO, A.PRODUTO, A.COR_PRODUTO, A.ORDEM_PRODUCAO, ISNULL(A.QTDE_FINALIZADA,0),         
       ( ISNULL(A.QTDE_FINALIZADA,0) * ROUND(( ( ISNULL(B.CUSTO,0) * @PORC_ACABADO ) / 100 ), 5) ), ISNULL(A.QTDE_EM_PRODUCAO,0),         
       ( ISNULL(A.QTDE_EM_PRODUCAO,0) * ROUND(( ( ISNULL(B.CUSTO,0) * @PORC_PROCESSO ) / 100 ), 5) )        
   FROM @TEMP_QTDE_OPS A        
     LEFT JOIN ( SELECT PRODUTO, MAX(CUSTO) AS CUSTO        
                 FROM @TMP_VENDAS        
                 GROUP BY PRODUTO         
               ) AS B ON B.PRODUTO = A.PRODUTO        
        
  END        
        
 END        
 ELSE        
 BEGIN        
        
  IF @ARBITRADO = 2 -- POR TABELA DE PREÇO        
  BEGIN        
        
   INSERT INTO CM_PRODUCAO_PA ( COD_CUSTO_MEDIO, PRODUTO, COR_PRODUTO, ORDEM_PRODUCAO, QTDE_PRODUZIDA, QTDE_EM_PROCESSO, VALOR_PRODUZIDO,         
           VALOR_EM_PROCESSO )        
   SELECT @COD_CUSTO_MEDIO, A.PRODUTO, A.COR_PRODUTO, A.ORDEM_PRODUCAO, A.QTDE_FINALIZADA, A.QTDE_EM_PRODUCAO,         
          ( A.QTDE_FINALIZADA * ( ( ( ISNULL(ISNULL(B.PRECO1, C.PRECO1), 0) + ISNULL(ISNULL(B.PRECO2, C.PRECO2), 0) +         
                                      ISNULL(ISNULL(B.PRECO3, C.PRECO3), 0) + ISNULL(ISNULL(B.PRECO4, C.PRECO4), 0) ) /         
                                    ( ( CASE WHEN CHARINDEX('1', D.PONTEIRO_PRECO_TAM) > 0 THEN 1 ELSE 0 END ) +        
                                      ( CASE WHEN CHARINDEX('2', D.PONTEIRO_PRECO_TAM) > 0 THEN 1 ELSE 0 END ) +        
                                      ( CASE WHEN CHARINDEX('3', D.PONTEIRO_PRECO_TAM) > 0 THEN 1 ELSE 0 END ) +        
                                      ( CASE WHEN CHARINDEX('4', D.PONTEIRO_PRECO_TAM) > 0 THEN 1 ELSE 0 END ) ) ) *         
                                  ( @PORC_ACABADO / 100 ) ) ),         
          ( A.QTDE_EM_PRODUCAO * ( ( ( ISNULL(ISNULL(B.PRECO1, C.PRECO1), 0) + ISNULL(ISNULL(B.PRECO2, C.PRECO2), 0) +         
                                       ISNULL(ISNULL(B.PRECO3, C.PRECO3), 0) + ISNULL(ISNULL(B.PRECO4, C.PRECO4), 0) ) /         
                                     ( ( CASE WHEN CHARINDEX('1', D.PONTEIRO_PRECO_TAM) > 0 THEN 1 ELSE 0 END ) +        
                                       ( CASE WHEN CHARINDEX('2', D.PONTEIRO_PRECO_TAM) > 0 THEN 1 ELSE 0 END ) +        
                                       ( CASE WHEN CHARINDEX('3', D.PONTEIRO_PRECO_TAM) > 0 THEN 1 ELSE 0 END ) +        
                                       ( CASE WHEN CHARINDEX('4', D.PONTEIRO_PRECO_TAM) > 0 THEN 1 ELSE 0 END ) ) ) *         
                                   ( @PORC_PROCESSO / 100 ) ) )        
   FROM @TEMP_QTDE_OPS A        
        INNER JOIN PRODUTOS (NOLOCK)/*#GS:01.02#*/AS D ON A.PRODUTO = D.PRODUTO        
     LEFT JOIN PRODUTOS_PRECO_COR (NOLOCK)/*#GS:01.02#*/B ON A.PRODUTO = B.PRODUTO AND         
                                          A.COR_PRODUTO = B.COR_PRODUTO AND         
                                          B.CODIGO_TAB_PRECO = @CODIGO_TAB_PRECO        
     LEFT JOIN PRODUTOS_PRECOS (NOLOCK)/*#GS:01.02#*/C ON A.PRODUTO = C.PRODUTO AND         
                                       C.CODIGO_TAB_PRECO = @CODIGO_TAB_PRECO        
        
  END        
  ELSE        
  BEGIN        
        
   DECLARE @TMP_OP TABLE ( ORDEM_PRODUCAO CHAR(8) COLLATE DATABASE_DEFAULT,        
         QTDE_EM_PRODUCAO INT,         
         VALOR_EM_PRODUCAO NUMERIC(15,5), --#20#        
         QTDE_FINALIZADA INT,        
         QTDE_FINALIZADA_PERIODO INT,         
         VALOR_FINALIZADO NUMERIC(15,5) )--#20#        
        
   INSERT INTO @TMP_OP ( ORDEM_PRODUCAO, QTDE_FINALIZADA, QTDE_FINALIZADA_PERIODO, VALOR_FINALIZADO, QTDE_EM_PRODUCAO, VALOR_EM_PRODUCAO )        
   SELECT A.ORDEM_PRODUCAO, SUM(A.QTDE_FINALIZADA) AS QTDE_FINALIZADA, SUM(A.QTDE_FINALIZADA_PERIODO), 0 AS VALOR_FINALIZADO,         
          SUM(A.QTDE_EM_PRODUCAO) AS QTDE_EM_PRODUCAO, 0 AS VALOR_EM_PRODUCAO        
   FROM @TEMP_QTDE_OPS AS A        
   GROUP BY A.ORDEM_PRODUCAO        
        
   IF ISNULL(DBO.FX_PARAMETRO('CM_UTILIZA_ACUMULADO_PROD'), '.T.') = '.T.'          
   BEGIN        
    -- #1# INICIO        
    --UPDATE A        
    --SET VALOR_FINALIZADO = ( CASE WHEN A.QTDE_EM_PRODUCAO = 0         
    --                            THEN B.VALOR_ABSORCAO         
    --                            ELSE ROUND(( A.QTDE_FINALIZADA * B.CUSTO_ABSORCAO ), 2)        
    --                         END ),         
    --    VALOR_EM_PRODUCAO = ( CASE WHEN A.QTDE_EM_PRODUCAO = 0         
    --                             THEN 0        
    --                             ELSE ( B.VALOR_ABSORCAO - ROUND(( A.QTDE_FINALIZADA * B.CUSTO_ABSORCAO ), 2) )        
    --                          END )        
    --FROM @TMP_OP AS A        
    --    INNER JOIN ( SELECT ORDEM_PRODUCAO,        
    --                         SUM(( CASE WHEN TOTAL_QTDE_ACUMULADA > 0        
    --                    THEN ( TOTAL_ABSORCAO_ACUMULADO / TOTAL_QTDE_ACUMULADA )        
    --                                  ELSE 0        
    --                               END )) AS CUSTO_ABSORCAO,         
    --                         SUM(TOTAL_ABSORCAO_ACUMULADO) AS VALOR_ABSORCAO        
    --                  FROM CM_PRODUCAO_PA_ABSORCAO        
    --                       INNER JOIN PRODUCAO_CUSTO_ABSORCAO         
    --                           ON CM_PRODUCAO_PA_ABSORCAO.INDICADOR_ABSORCAO = PRODUCAO_CUSTO_ABSORCAO.INDICADOR_ABSORCAO        
    --                  WHERE CM_PRODUCAO_PA_ABSORCAO.COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO        
    --                  GROUP BY ORDEM_PRODUCAO        
    --                ) AS B ON A.ORDEM_PRODUCAO = B.ORDEM_PRODUCAO        
        
    UPDATE A         
    SET VALOR_FINALIZADO = ( CASE WHEN A.QTDE_EM_PRODUCAO = 0         
           THEN B.VALOR_ABSORCAO         
           ELSE ROUND(( A.QTDE_FINALIZADA * ( B.VALOR_ABSORCAO / CASE WHEN ( A.QTDE_FINALIZADA + A.QTDE_EM_PRODUCAO ) = 0 THEN 1 ELSE ( A.QTDE_FINALIZADA + A.QTDE_EM_PRODUCAO )END  ) ), 5)--#20#        
           END ),         
     VALOR_EM_PRODUCAO = ( CASE WHEN A.QTDE_EM_PRODUCAO = 0         
            THEN 0        
            ELSE ( B.VALOR_ABSORCAO -         
                    ROUND(( A.QTDE_FINALIZADA *         
                      ( B.VALOR_ABSORCAO /         
                     CASE WHEN ( A.QTDE_FINALIZADA + A.QTDE_EM_PRODUCAO ) = 0 THEN 1 ELSE ( A.QTDE_FINALIZADA + A.QTDE_EM_PRODUCAO )END  ) ), 5) )--#20#        
            END )        
    FROM @TMP_OP AS A        
      INNER JOIN ( SELECT ORDEM_PRODUCAO,         
                         SUM(( CASE WHEN TOTAL_QTDE_ACUMULADA > 0        
                                  THEN ( TOTAL_ABSORCAO_ACUMULADO / TOTAL_QTDE_ACUMULADA )        
                                  ELSE 0        
                               END )) AS CUSTO_ABSORCAO,         
                         SUM(TOTAL_ABSORCAO_ACUMULADO) AS VALOR_ABSORCAO        
                  FROM CM_PRODUCAO_PA_ABSORCAO        
                       INNER JOIN PRODUCAO_CUSTO_ABSORCAO         
                           ON CM_PRODUCAO_PA_ABSORCAO.INDICADOR_ABSORCAO = PRODUCAO_CUSTO_ABSORCAO.INDICADOR_ABSORCAO        
                  WHERE CM_PRODUCAO_PA_ABSORCAO.COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO        
                  GROUP BY ORDEM_PRODUCAO        
                ) AS B ON A.ORDEM_PRODUCAO = B.ORDEM_PRODUCAO        
    -- #1# FIM        
   END        
   ELSE        
   BEGIN        
        
    UPDATE A        
    SET VALOR_FINALIZADO = ( CASE WHEN A.QTDE_EM_PRODUCAO = 0         
                                THEN B.VALOR_ABSORCAO         
                                ELSE ROUND(( A.QTDE_FINALIZADA * B.CUSTO_ABSORCAO ), 5)--#20#        
                             END ),         
        VALOR_EM_PRODUCAO = ( CASE WHEN A.QTDE_EM_PRODUCAO = 0         
                                 THEN 0        
                                 ELSE ( B.VALOR_ABSORCAO - ROUND(( A.QTDE_FINALIZADA * B.CUSTO_ABSORCAO ), 5) )--#20#        
                              END )        
    FROM @TMP_OP AS A        
         INNER JOIN ( SELECT ORDEM_PRODUCAO,         
                             SUM(( CASE WHEN TOTAL_QTDE_PERIODO > 0        
                                      THEN ( TOTAL_ABSORCAO_PERIODO / TOTAL_QTDE_PERIODO )        
                                      ELSE 0 
                                   END )) AS CUSTO_ABSORCAO,         
                             SUM(TOTAL_ABSORCAO_PERIODO) AS VALOR_ABSORCAO        
                      FROM CM_PRODUCAO_PA_ABSORCAO        
                           INNER JOIN PRODUCAO_CUSTO_ABSORCAO         
                               ON CM_PRODUCAO_PA_ABSORCAO.INDICADOR_ABSORCAO = PRODUCAO_CUSTO_ABSORCAO.INDICADOR_ABSORCAO        
                      WHERE CM_PRODUCAO_PA_ABSORCAO.COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO        
                      GROUP BY ORDEM_PRODUCAO        
                    ) AS B ON A.ORDEM_PRODUCAO = B.ORDEM_PRODUCAO        
        
   END        
        
   UPDATE A        
   SET VALOR_FINALIZADO = CASE WHEN B.QTDE_FINALIZADA = 0        --#CSM003
                             THEN 0        
                             ELSE ROUND(( ( 1. * A.QTDE_FINALIZADA / B.QTDE_FINALIZADA ) * B.VALOR_FINALIZADO ), 5)--#20#        
                          END,         
       VALOR_EM_PRODUCAO = CASE WHEN B.QTDE_EM_PRODUCAO = 0      --#CSM003  
                              THEN 0        
                              ELSE ROUND(( ( 1. * A.QTDE_EM_PRODUCAO / B.QTDE_EM_PRODUCAO ) * B.VALOR_EM_PRODUCAO ), 5)--#20#        
                           END        
   FROM @TEMP_QTDE_OPS AS A        
        INNER JOIN @TMP_OP AS B ON A.ORDEM_PRODUCAO = B.ORDEM_PRODUCAO        
        
   DECLARE @CUR_ORDEM_PRODUCAO CHAR(08), @DIF_PRODUZIDO AS NUMERIC(14,2), @DIF_EM_PRODUCAO AS NUMERIC(14,2)        
        
   DECLARE CUR_DIFERENCAS CURSOR FAST_FORWARD FOR        
   SELECT A.ORDEM_PRODUCAO, ( B.VALOR_FINALIZADO - A.VALOR_FINALIZADO ) AS DIF_PRODUZIDO,         
          ( B.VALOR_EM_PRODUCAO - A.VALOR_EM_PRODUCAO ) AS DIF_EM_PRODUCAO        
   FROM ( SELECT A.ORDEM_PRODUCAO, SUM(A.VALOR_FINALIZADO) AS VALOR_FINALIZADO, SUM(A.VALOR_EM_PRODUCAO) AS VALOR_EM_PRODUCAO        
       FROM @TEMP_QTDE_OPS AS A        
       GROUP BY A.ORDEM_PRODUCAO        
     ) AS A        
     INNER JOIN @TMP_OP AS B ON A.ORDEM_PRODUCAO = B.ORDEM_PRODUCAO        
   WHERE ( A.VALOR_FINALIZADO - B.VALOR_FINALIZADO ) <> 0 OR        
         ( A.VALOR_EM_PRODUCAO - B.VALOR_EM_PRODUCAO ) <> 0        
        
   OPEN CUR_DIFERENCAS        
           
   FETCH NEXT FROM CUR_DIFERENCAS INTO @CUR_ORDEM_PRODUCAO, @DIF_PRODUZIDO, @DIF_EM_PRODUCAO        
           
   WHILE @@FETCH_STATUS = 0        
   BEGIN        
        
    UPDATE A        
    SET VALOR_FINALIZADO = ( VALOR_FINALIZADO + @DIF_PRODUZIDO ),         
        VALOR_EM_PRODUCAO = ( VALOR_EM_PRODUCAO + @DIF_EM_PRODUCAO )        
    FROM @TEMP_QTDE_OPS AS A        
      INNER JOIN ( SELECT TOP 1 B.PRODUTO, B.COR_PRODUTO, B.ORDEM_PRODUCAO        
          FROM @TEMP_QTDE_OPS AS B        
          WHERE B.ORDEM_PRODUCAO = @CUR_ORDEM_PRODUCAO        
        ) AS B ON A.ORDEM_PRODUCAO = B.ORDEM_PRODUCAO AND        
                  A.PRODUTO = B.PRODUTO AND        
                  A.COR_PRODUTO = B.COR_PRODUTO        
        
    FETCH NEXT FROM CUR_DIFERENCAS INTO @CUR_ORDEM_PRODUCAO, @DIF_PRODUZIDO, @DIF_EM_PRODUCAO        
        
   END        
           
   CLOSE CUR_DIFERENCAS        
   DEALLOCATE CUR_DIFERENCAS        
        
   INSERT INTO CM_PRODUCAO_PA ( COD_CUSTO_MEDIO, PRODUTO, COR_PRODUTO, ORDEM_PRODUCAO, QTDE_PRODUZIDA, QTDE_EM_PROCESSO, VALOR_PRODUZIDO,        
           VALOR_EM_PROCESSO )        
   SELECT @COD_CUSTO_MEDIO, A.PRODUTO, A.COR_PRODUTO, A.ORDEM_PRODUCAO, A.QTDE_FINALIZADA, A.QTDE_EM_PRODUCAO,        
       VALOR_PRODUZIDO = A.VALOR_FINALIZADO,        
          VALOR_EM_PROCESSO = A.VALOR_EM_PRODUCAO        
   FROM @TEMP_QTDE_OPS A        
        
  END        
        
 END        
         
 DECLARE @TMP_PRODUZIDO_PERIODO TABLE ( ORDEM_PRODUCAO CHAR(8) COLLATE DATABASE_DEFAULT,        
                      QTDE_PRODUZIDA_PERIODO INT,         
                      VALOR_PRODUZIDO_PERIODO NUMERIC(15,5) )--#20#        
        
 INSERT INTO @TMP_PRODUZIDO_PERIODO ( ORDEM_PRODUCAO, QTDE_PRODUZIDA_PERIODO, VALOR_PRODUZIDO_PERIODO )        
 SELECT C.ORDEM_PRODUCAO, SUM(( C.QTDE_PRODUZIDA - ISNULL(D.QTDE_PRODUZIDA, 0) )) AS QTDE_PRODUZIDA_PERIODO,        
        SUM(( C.VALOR_PRODUZIDO - ISNULL(D.VALOR_PRODUZIDO, 0) )) AS VALOR_PRODUZIDO_PERIODO        
 FROM CM_PRODUCAO_PA AS C         
      LEFT JOIN CM_PRODUCAO_PA AS D ON C.PRODUTO = D.PRODUTO AND        
                                       C.COR_PRODUTO = D.COR_PRODUTO AND        
                                       C.ORDEM_PRODUCAO = D.ORDEM_PRODUCAO AND        
                                       D.COD_CUSTO_MEDIO = @COD_CUSTO_ANT AND        
            --#8#        
            D.QTDE_PRODUZIDA>0        
            --#8#        
 WHERE C.COD_CUSTO_MEDIO = @COD_CUSTO_MEDIO        
 GROUP BY C.ORDEM_PRODUCAO        
         
 DELETE FROM @TMP_PRODUZIDO_PERIODO WHERE QTDE_PRODUZIDA_PERIODO = 0        
        
 /* LANÇA O CUSTO DA PRODUÇÃO NAS ENTRADAS DOS PRODUTOS */        
 UPDATE A        
 SET A.CUSTO_PRODUCAO = ROUND(( CASE WHEN A.QTDE = 0        
                                   THEN 0        
  ELSE ( ( ( 1. * A.QTDE / D.QTDE_PRODUZIDA_PERIODO ) * D.VALOR_PRODUZIDO_PERIODO ) / A.QTDE )        
                                END ), 5), --#20#        
     A.VALOR = ( ( 1. * A.QTDE / D.QTDE_PRODUZIDA_PERIODO ) * D.VALOR_PRODUZIDO_PERIODO ),        
--#7#          
  A.CUSTO1= ROUND(( CASE WHEN A.QTDE = 0        
                                   THEN 0        
                                   ELSE ( ( ( 1. * A.QTDE / D.QTDE_PRODUZIDA_PERIODO ) * D.VALOR_PRODUZIDO_PERIODO ) / A.QTDE )        
                                END ), 5)--#20#        
--#7#        
 FROM ESTOQUE_PROD1_ENT A        
      INNER JOIN ESTOQUE_PROD_ENT (NOLOCK)/*#GS:01.02#*/B ON A.ROMANEIO_PRODUTO = B.ROMANEIO_PRODUTO AND        
                                       A.FILIAL = B.FILIAL        
      INNER JOIN @TMP_PRODUZIDO_PERIODO AS D ON A.ORDEM_PRODUCAO = D.ORDEM_PRODUCAO        
 WHERE B.EMISSAO BETWEEN @DATA_INI AND @DATA_FIN        
        
 -- #2# POPULAR TABELA CM_PRODUCAO_PA_TERCEIRO        
 -- EXEC LX_CM_PRODUCAO_PA_TERCEIRO @COD_CUSTO_MEDIO, @EMPRESA         
 --#9#        
 EXEC LX_CM_PRODUCAO_PA_PROCESSO @COD_CUSTO_MEDIO, @EMPRESA         
 --#9# 
