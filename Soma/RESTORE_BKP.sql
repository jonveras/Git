USE [master]

-- Passo 1: Verificar os arquivos dentro do .bak
RESTORE FILELISTONLY 
FROM DISK = '\\192.168.9.144\svr-ecomfyiatg2\BACKUP_MSSQL\ECOMMfarmATG\FULL\SVR-ECOMFYIATG2_ECOMMfarmATG_FULL_20250526_032857.bak';

--Passo 2: Faz o restore
RESTORE DATABASE [ECOMMfarmATG] FROM DISK='\\192.168.9.144\svr-ecomfyiatg2\BACKUP_MSSQL\ECOMMfarmATG\FULL\SVR-ECOMFYIATG2_ECOMMfarmATG_FULL_20250526_032857.bak'
with  
    RECOVERY,
	MOVE N'FARM_ATG' TO N'E:\MSSQL\DATA\FARM_ATG.mdf',
	MOVE N'FARM_ATG_log' TO N'E:\MSSQL\LOG\FARM_ATG_log.ldf',
	stats =10;
   go

DBCC CHECKDB('ECOMMfarmATG')


--PEGAR OS NOMES DOS ARQUIVOS DE PARA FAZER RESTORE (se o backup partir do 200)
select 
	CASE a.type
		WHEN 'D' THEN 1
		WHEN 'I' THEN 2
		ELSE 3 
	END AS ordem, 
	a.type,
	a.backup_start_date,
	a.backup_finish_date,
	b.physical_device_name
from msdb..backupset AS a
inner join msdb..backupmediafamily AS b ON a.media_set_id = b.media_set_id
where database_name = 'SOMA' and a.type IN ('D', 'L', 'I') and backup_start_date >= '20250316'
ORDER BY ordem
-----------------------------------------------------------

-- USAR NORECOVERY PARA CONSEGUIR FAZRE RESTORE NA BASE
-- USAR RECOVERY PARA LIBERAR A BASE PARA USO
 
--verificar se há alguem conectado na base e dar kill em sessões acima de 50
--select * from sys.dm_exec_sessions where  database_id = db_id ('teste_paulo')
--SESSION_ID > 50
 
--ALTER DATABASE [teste_paulo] SET SINGLE_USER WITH ROLLBACK IMMEDIATE;
--GO
 
-- ALTER DATABASE [TESTE_PAULO] SET MULTI_USER WITH ROLLBACK IMMEDIATE;
--GO
 
--RESTORE DATABASE [SOMA] WITH RECOVERY
 
---- VERIFICAR ONDE ESTÃO OS ARQUIVOS MDF E LDF
--RESTORE FILELISTONLY FROM DISK='\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\DbLogistica\FULL\SRV-SOMADB_DbLogistica_FULL_20240728_223306.bak'
--RESTORE FILELISTONLY FROM DISK='\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\DbLogistica\FULL\SRV-SOMADB_DbLogistica_FULL_20220724_222729.bak'
----
 
-- Query para olhar para onde mover os arquivos
--select 'MOVE N'''+name+'''  TO N'''+physical_name+''','
--from sys.master_files   where database_id = db_id('soma')
 
 
--   MOVE N'lx_zero_300_dbData'  TO N'E:\MSSQL\DATA\SOMA_HML.mdf',
--   MOVE N'lx_zero_300_log'     TO N'E:\MSSQL\LOG\SOMA_HML_log.ldf',
--   MOVE N'Soma_Index'          TO N'E:\MSSQL\DATA\SOMA_HML_Index.ndf',
--   MOVE N'FileMemOptim3a'      TO N'E:\MSSQL\DATA\FileMemOptim3b',
 
--USE master;
--GO

-- Passo 1: Verificar os arquivos dentro do .bak
RESTORE FILELISTONLY 
FROM DISK = '\\192.168.9.144\svr-ecomfyiatg2\BACKUP_MSSQL\ECOMMfarmATG\FULL\SVR-ECOMFYIATG2_ECOMMfarmATG_FULL_20250526_032857.bak'; 
-- Passo 2: Faz o backup 
RESTORE DATABASE [ECOMMfarmATG]
FROM DISK = '\\192.168.9.144\svr-ecomfyiatg2\BACKUP_MSSQL\ECOMMfarmATG\FULL\SVR-ECOMFYIATG2_ECOMMfarmATG_FULL_20250526_032857.bak'
WITH MOVE 'ECOMMfarmATG_Data' TO 'C:\SQLData\ECOMMfarmATG.mdf',
     MOVE 'ECOMMfarmATG_Log' TO 'C:\SQLLogs\ECOMMfarmATG_log.ldf',
     REPLACE,
     STATS = 10;

RESTORE DATABASE [SOMA_TMP] FROM DISK='\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\FULL\SRV-SOMADB_SOMA_FULL_20250316_225148.bak'
with  
    NORECOVERY,
	REPLACE,
	MOVE N'lx_zero_300_dbData'  TO N'F:\MSSQL\RESTORED\SOMA_TMP.mdf',
	MOVE N'lx_zero_300_log'  TO N'F:\MSSQL\RESTORED\SOMA_TMP_log.ldf',
	MOVE N'Soma_Index'  TO N'F:\MSSQL\RESTORED\SOMA_TMP_Index.ndf',
	MOVE N'FileMemOptim3a'  TO N'F:\MSSQL\RESTORED\FileMemOptim3D',
	stats =10;
   go
   --RESTORE database [dblogistica_temp] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\DbLogistica\DIFF\SRV-SOMADB_DbLogistica_DIFF_20220725_220227.bak'
   RESTORE database [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\DIFF\SRV-SOMADB_SOMA_DIFF_20250321_220742.bak'
WITH NORECOVERY
GO
 
 
--RESTAURAR OS LOGS
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250321_224527.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250321_230037.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250321_231533.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250321_233050.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250321_234559.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_000113.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_001601.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_003030.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_004600.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_010221.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_011559.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_013035.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_014602.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_020224.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_021549.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_023228.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_024553.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_030111.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_031550.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_033102.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_034545.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_040246.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_041612.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_043040.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_044545.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_050102.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_051535.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_053109.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_054538.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_060156.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_061540.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_063116.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_064552.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_070201.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_071542.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_073222.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_074552.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_080117.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_081607.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_083037.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_084532.trn'WITH NORECOVERY;
RESTORE LOG [SOMA_TMP] FROM DISK = '\\192.168.9.146\srv-arch03\SRV-SOMADB\BACKUP_MSSQL\SRV-SOMADB\SOMA\LOG\SRV-SOMADB_SOMA_LOG_20250322_090047.trn'WITH RECOVERY;